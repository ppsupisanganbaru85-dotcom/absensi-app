<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Karyawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .input-focus:focus { box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            
            .gradient-bg {
                padding-top: 1.5rem !important;
                padding-bottom: 1.5rem !important;
            }
            
            .gradient-bg h1 {
                font-size: 1.25rem !important;
                line-height: 1.75rem !important;
            }
            
            .nav-buttons {
                flex-direction: column !important;
                gap: 0.75rem !important;
                padding: 0 !important;
            }
            
            .nav-buttons button {
                padding: 0.75rem 1rem !important;
                font-size: 0.875rem !important;
                min-height: 48px !important;
            }
            
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .card-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 0.75rem;
            }
            
            .table-container table {
                min-width: 800px;
            }
            
            .table-container th,
            .table-container td {
                padding: 0.5rem 0.375rem !important;
                font-size: 0.75rem !important;
                white-space: nowrap;
            }
            
            .table-container th {
                font-size: 0.625rem !important;
                font-weight: 600 !important;
            }
            
            .camera-container {
                max-width: 100%;
            }
            
            .camera-container .grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 0.5rem !important;
            }
            
            .camera-container button {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem !important;
                min-height: 40px !important;
            }
            
            #cameraVideo {
                height: 200px !important;
                border-radius: 0.5rem !important;
            }
            
            #photoPreview {
                height: 200px !important;
                border-radius: 0.5rem !important;
            }
            
            .modal-content {
                margin: 1rem !important;
                max-height: calc(100vh - 2rem) !important;
                overflow-y: auto;
                border-radius: 0.75rem !important;
            }
            
            .btn-responsive {
                padding: 0.75rem 1rem !important;
                font-size: 0.875rem !important;
                min-height: 48px !important;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.75rem !important;
            }
            
            .summary-grid > div {
                padding: 1rem 0.75rem !important;
            }
            
            .summary-grid .text-2xl {
                font-size: 1.5rem !important;
            }
            
            .summary-grid .text-sm {
                font-size: 0.75rem !important;
            }
            
            .dashboard-toggle {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }
            
            .dashboard-toggle button {
                width: 100% !important;
                justify-content: center !important;
            }
            
            .active-sessions-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            #currentTime {
                font-size: 2rem !important;
            }
            
            #currentDate {
                font-size: 1rem !important;
            }
            
            .card-content {
                padding: 1rem !important;
            }
            
            .card-content h3 {
                font-size: 1rem !important;
            }
            
            .card-content .grid {
                gap: 0.75rem !important;
            }
            
            .card-content .text-sm {
                font-size: 0.75rem !important;
            }
            
            input, select, textarea {
                padding: 0.75rem !important;
                font-size: 1rem !important;
                min-height: 44px !important;
            }
            
            label {
                font-size: 0.875rem !important;
                margin-bottom: 0.5rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }
            
            .gradient-bg h1 {
                font-size: 1.125rem !important;
            }
            
            #currentTime {
                font-size: 1.75rem !important;
            }
            
            .summary-grid .text-2xl {
                font-size: 1.25rem !important;
            }
            
            .card-content {
                padding: 0.75rem !important;
            }
        }
        
        .custom-scroll::-webkit-scrollbar {
            height: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        
        @media (max-width: 768px) {
            .table-container table {
                min-width: 800px;
            }
            
            .table-container th,
            .table-container td {
                padding: 8px 6px !important;
                font-size: 12px !important;
            }
            
            .table-container th {
                font-size: 10px !important;
                white-space: nowrap;
            }
        }
        
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .connection-dot-connected {
            animation: blink 2s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-success { background-color: #dcfce7; color: #166534; }
        .status-warning { background-color: #fef3c7; color: #92400e; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        .status-info { background-color: #dbeafe; color: #1e40af; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
        .notification.warning { background-color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <div class="gradient-bg text-white py-6 sm:py-8">
        <div class="container mx-auto px-4">
            <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-center">üìä Absensi PPSU Pisangan Baru</h1>
            

            
            <!-- Navigation -->
            <div class="flex flex-col sm:flex-row justify-center mt-4 sm:mt-6 gap-3 sm:gap-4 nav-buttons px-2 sm:px-4">
                <button onclick="showPage('realtime')" id="realtimeBtn" class="bg-white bg-opacity-30 hover:bg-opacity-40 text-white px-4 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 btn-responsive w-full sm:w-auto">
                    <span>üïê</span> 
                    <span class="hidden sm:inline">Absensi Real-Time</span>
                    <span class="sm:hidden">Real-Time</span>
                </button>
                <button onclick="showPage('manual')" id="manualBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 btn-responsive w-full sm:w-auto">
                    <span>üë®‚Äçüíº</span> 
                    <span class="hidden sm:inline">Panel Admin</span>
                    <span class="sm:hidden">Admin</span>
                </button>
                <button onclick="showPage('recap')" id="recapBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 btn-responsive w-full sm:w-auto">
                    <span>üìä</span> 
                    <span class="hidden sm:inline">Rekap Bulanan</span>
                    <span class="sm:hidden">Rekap</span>
                </button>
                <button onclick="logout()" id="logoutBtn" class="bg-red-500 bg-opacity-80 hover:bg-opacity-100 text-white px-4 py-3 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 btn-responsive w-full sm:w-auto hidden">
                    <span>üö™</span> 
                    <span class="hidden sm:inline">Logout</span>
                    <span class="sm:hidden">Keluar</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Real-Time Attendance Page -->
        <div id="realtimePage" class="hidden">
            <!-- Current Time Display -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8 text-center">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">üïê Absensi Real-Time</h2>
                <div class="text-4xl font-bold text-indigo-600 mb-2" id="currentTime">00:00:00</div>
                <div class="text-lg text-gray-600 mb-4" id="currentDate">Loading...</div>
                
                <!-- Usage Instructions -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                    <h3 class="font-semibold text-blue-900 mb-2">üìã Cara Menggunakan:</h3>
                    <div class="text-sm text-blue-800 space-y-1">
                        <p>1. <strong>Cari nama Anda</strong> di kotak pencarian atau klik tombol nama</p>
                        <p>2. <strong>Pilih shift</strong> dan jenis absen (Masuk/Keluar)</p>
                        <p>3. <strong>Ambil foto</strong> untuk dokumentasi absensi</p>
                        <p>4. <strong>Klik "Absen Sekarang"</strong> untuk menyimpan data</p>
                        <p class="text-blue-600 font-medium mt-2">üí° Setiap petugas dapat menggunakan sistem ini secara bergantian</p>
                    </div>
                </div>
            </div>

            <!-- Employee Selection -->
            <div class="bg-white rounded-xl card-shadow card-content mb-8">
                <h3 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6 text-gray-800">üë§ Pilih Nama Anda</h3>
                
                <!-- Search Box -->
                <div class="mb-4">
                    <input type="text" id="employeeSearch" class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500 text-lg" placeholder="üîç Cari nama Anda atau ketik untuk menambah nama baru..." onkeyup="filterEmployees()" onkeydown="handleSearchKeydown(event)">
                </div>
                
                <!-- Employee Buttons Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 max-h-96 overflow-y-auto" id="employeeButtons">
                    <!-- Employee buttons will be generated here -->
                </div>
                
                <!-- Quick Add Section -->
                <div class="mt-4 pt-4 border-t border-gray-200" id="quickAddSection" style="display: none;">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-sm text-green-700 mb-3">
                            <span class="font-medium">Nama tidak ditemukan?</span> 
                            <span id="searchedName" class="font-bold"></span>
                        </p>
                        <button type="button" onclick="addSearchedEmployee()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium transition-colors btn-responsive flex items-center justify-center gap-2">
                            <span>‚ûï</span> Tambah "<span id="nameToAdd"></span>" ke Daftar
                        </button>
                    </div>
                </div>
                
                <!-- Employee Count -->
                <div class="mt-4 pt-4 border-t border-gray-200 text-center">
                    <p class="text-sm text-gray-500">
                        Total: <span id="employeeCount" class="font-medium text-indigo-600">43</span> petugas terdaftar
                    </p>
                </div>
            </div>

            <!-- Selected Employee Info -->
            <div id="selectedEmployeeInfo" class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-8 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg" id="employeeAvatar">
                            A
                        </div>
                        <div>
                            <h4 class="font-semibold text-blue-900" id="selectedEmployeeName">-</h4>
                            <p class="text-sm text-blue-600" id="employeeStatus">Siap untuk absen</p>
                        </div>
                    </div>
                    <button onclick="clearSelection()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        üîÑ Ganti
                    </button>
                </div>
            </div>

            <!-- Quick Attendance Form -->
            <div id="attendanceFormSection" class="bg-white rounded-xl card-shadow card-content mb-8 hidden">
                <h3 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6 text-gray-800">‚ö° Form Absensi</h3>
                <form id="quickAttendanceForm" class="form-grid grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
                    <input type="hidden" id="quickEmployeeName">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Shift</label>
                        <select id="quickShiftSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                            <option value="">Pilih Shift</option>
                            <option value="shift1">Shift 1 (05:00-13:00)</option>
                            <option value="shift2">Shift 2 (07:20-15:20)</option>
                            <option value="kantor">Shift Kantor (07:00-17:00)</option>
                            <option value="piket1">Shift Piket 1 (18:00-06:00)</option>
                            <option value="piket_pagi">Shift Piket Kantor Pagi (07:00-12:00)</option>
                            <option value="piket_siang">Shift Piket Kantor Siang (12:00-17:00)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Absen</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" onclick="setAttendanceType('masuk')" id="masukBtn" class="attendance-type-btn bg-gray-200 hover:bg-green-100 text-gray-700 px-4 py-3 rounded-lg font-medium transition-colors border-2 border-transparent">
                                üü¢ Masuk
                            </button>
                            <button type="button" onclick="setAttendanceType('keluar')" id="keluarBtn" class="attendance-type-btn bg-gray-200 hover:bg-red-100 text-gray-700 px-4 py-3 rounded-lg font-medium transition-colors border-2 border-transparent">
                                üî¥ Keluar
                            </button>
                        </div>
                        <input type="hidden" id="attendanceType" required>
                    </div>
                    <div class="sm:col-span-2 xl:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto Absensi</label>
                        <div class="space-y-3 camera-container">
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" onclick="openCamera()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-1 btn-responsive text-sm">
                                    <span>üì∑</span> 
                                    <span class="hidden sm:inline">Kamera</span>
                                    <span class="sm:hidden">üì∑</span>
                                </button>
                                <button type="button" onclick="showFileInput()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-1 btn-responsive text-sm">
                                    <span>üìÅ</span> 
                                    <span class="hidden sm:inline">Upload</span>
                                    <span class="sm:hidden">üìÅ</span>
                                </button>
                            </div>

                            <input type="file" id="photoFileInput" accept="image/*" capture="environment" class="hidden" onchange="handleFileSelect(event)">
                            <div id="cameraPreview" class="hidden">
                                <video id="cameraVideo" class="w-full h-40 sm:h-48 bg-gray-100 rounded-lg object-cover" autoplay playsinline></video>
                                <div class="flex gap-2 mt-2 mobile-gap-2">
                                    <button type="button" onclick="capturePhoto()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium text-sm btn-responsive">
                                        <span class="hidden sm:inline">üì∏ Ambil</span>
                                        <span class="sm:hidden">üì∏</span>
                                    </button>
                                    <button type="button" onclick="closeCamera()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg font-medium text-sm btn-responsive">
                                        <span class="hidden sm:inline">‚ùå Batal</span>
                                        <span class="sm:hidden">‚ùå</span>
                                    </button>
                                </div>
                            </div>
                            <div id="capturedPhoto" class="hidden">
                                <img id="photoPreview" class="w-full h-40 sm:h-48 bg-gray-100 rounded-lg object-cover" alt="Foto Absensi">
                                <div class="flex gap-2 mt-2 mobile-gap-2">
                                    <button type="button" onclick="retakePhoto()" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded-lg font-medium text-sm btn-responsive">
                                        <span class="hidden sm:inline">üîÑ Ulang</span>
                                        <span class="sm:hidden">üîÑ</span>
                                    </button>
                                    <button type="button" onclick="removePhoto()" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-medium text-sm btn-responsive">
                                        <span class="hidden sm:inline">üóëÔ∏è Hapus</span>
                                        <span class="sm:hidden">üóëÔ∏è</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                        <input type="text" id="quickNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" placeholder="Catatan tambahan (opsional)">
                    </div>
                    <div class="sm:col-span-2 lg:col-span-4">
                        <button type="submit" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2 text-base sm:text-lg btn-responsive">
                            <span>‚ö°</span> 
                            <span class="hidden sm:inline">Absen Sekarang</span>
                            <span class="sm:hidden">Absen</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Active Sessions -->
            <div class="bg-white rounded-xl card-shadow card-content mb-8">
                <h3 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6 text-gray-800">üë• Sesi Aktif Hari Ini</h3>
                <div id="activeSessions" class="active-sessions-grid grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    <!-- Active sessions akan ditampilkan di sini -->
                </div>
            </div>
        </div>

        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="modal-content bg-white rounded-xl p-6 w-full max-w-md">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">üîê Login Admin</h3>
                    <p class="text-gray-600">Masukkan kredensial untuk mengakses Panel Admin</p>
                </div>
                <form id="loginForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="loginUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" placeholder="Masukkan username" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" placeholder="Masukkan password" required>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200">
                            üîì Login
                        </button>
                        <button type="button" onclick="closeLoginModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Monthly Recap Page -->
        <div id="recapPage" class="hidden">
            <!-- Monthly Recap Content -->
            <div id="recapContent" class="hidden">
                <!-- Filter Section -->
                <div class="bg-white rounded-xl card-shadow card-content mb-8">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6 text-gray-800">üìä Filter Rekap Bulanan</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Bulan</label>
                            <select id="monthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" onchange="generateRecap()">
                                <option value="">Semua Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Tahun</label>
                            <select id="yearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" onchange="generateRecap()">
                                <!-- Years will be populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Petugas</label>
                            <select id="employeeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" onchange="generateRecap()">
                                <option value="">Semua Petugas</option>
                                <!-- Employees will be populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tampilan</label>
                            <select id="viewTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" onchange="generateRecap()">
                                <option value="summary">Ringkasan Bulanan</option>
                                <option value="daily">Rekap Harian</option>
                                <option value="detailed">Detail Lengkap</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row gap-3">
                        <button onclick="generateRecap()" class="flex-1 sm:flex-none bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2 btn-responsive">
                            <span>üîÑ</span> Refresh Rekap
                        </button>
                        <button onclick="exportRecapToCSV()" class="flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2 btn-responsive">
                            <span>üìä</span> Export Excel
                        </button>
                        <button onclick="generateMonthlyReport()" class="flex-1 sm:flex-none bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2 btn-responsive">
                            <span>üìã</span> Laporan Bulanan
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div id="recapSummary" class="summary-grid grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-8">
                    <!-- Summary cards will be populated here -->
                </div>

                <!-- Recap Table -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-800" id="recapTableTitle">üìã Rekap Data Kehadiran</h2>
                        <p class="text-sm text-gray-600 mt-1" id="recapPeriod">Menampilkan data untuk semua periode</p>
                    </div>
                    <div class="table-container overflow-x-auto custom-scroll">
                        <table class="w-full" id="recapMainTable">
                            <thead class="bg-gray-50" id="recapTableHead">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Nama Petugas</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Hari Kerja</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Keterlambatan</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Pulang Cepat</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Jam Efektif</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Lembur</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Rata-rata Jam/Hari</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hari Terlambat</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hari Pulang Cepat</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="recapTable" class="bg-white divide-y divide-gray-200">
                                <!-- Recap data will be populated here -->
                            </tbody>
                            <tfoot id="recapFooter" class="bg-gray-100 font-bold">
                                <!-- Footer totals will be populated here -->
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Daily Recap Table (Hidden by default) -->
                <div id="dailyRecapContainer" class="bg-white rounded-xl card-shadow overflow-hidden hidden">
                    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-800">üìÖ Rekap Harian per Petugas</h2>
                        <p class="text-sm text-gray-600 mt-1" id="dailyRecapPeriod">Rekap kehadiran harian dalam periode yang dipilih</p>
                    </div>
                    <div class="table-container overflow-x-auto custom-scroll">
                        <table class="w-full">
                            <thead class="bg-gray-50" id="dailyRecapHead">
                                <!-- Dynamic headers will be generated -->
                            </thead>
                            <tbody id="dailyRecapTable" class="bg-white divide-y divide-gray-200">
                                <!-- Daily recap data will be populated here -->
                            </tbody>
                            <tfoot id="dailyRecapFooter" class="bg-gray-100 font-bold">
                                <!-- Daily totals will be populated here -->
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Detailed Recap Table (Hidden by default) -->
                <div id="detailedRecapContainer" class="bg-white rounded-xl card-shadow overflow-hidden hidden">
                    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-800">üìä Detail Lengkap Kehadiran</h2>
                        <p class="text-sm text-gray-600 mt-1" id="detailedRecapPeriod">Detail lengkap setiap absensi dalam periode yang dipilih</p>
                    </div>
                    <div class="table-container overflow-x-auto custom-scroll">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Nama</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shift</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Kerja</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Keluar</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telat</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cepat Pulang</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Efektif</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lembur</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                </tr>
                            </thead>
                            <tbody id="detailedRecapTable" class="bg-white divide-y divide-gray-200">
                                <!-- Detailed recap data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Input Page -->
        <div id="manualPage" class="hidden">
            <!-- Manual Input Content -->
            <div id="manualContent" class="hidden">
                <!-- Minimalist Connection Status -->
                <div class="bg-white rounded-xl card-shadow card-content mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">üìä Panel Admin</h3>
                            <p class="text-sm text-gray-600 mt-1">Kelola data kehadiran dan sinkronisasi Firebase</p>
                        </div>
                        <div id="connectionStatus" class="flex items-center gap-2">
                            <div id="connectionDot" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                            <span id="connectionText" class="text-sm text-gray-600">Menghubungkan...</span>
                        </div>
                    </div>
                </div>
                <!-- Form Input -->
                <div class="bg-white rounded-xl card-shadow card-content mb-8">
                    <h2 class="text-lg sm:text-xl font-semibold mb-4 sm:mb-6 text-gray-800">üìù Input Data Kehadiran</h2>
                    <form id="attendanceForm" class="form-grid grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Karyawan</label>
                            <input type="text" id="employeeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" placeholder="Masukkan nama" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hari</label>
                            <select id="dayOfWeek" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                                <option value="">Pilih Hari</option>
                                <option value="Senin">Senin</option>
                                <option value="Selasa">Selasa</option>
                                <option value="Rabu">Rabu</option>
                                <option value="Kamis">Kamis</option>
                                <option value="Jumat">Jumat</option>
                                <option value="Sabtu">Sabtu</option>
                                <option value="Minggu">Minggu</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="attendanceDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Shift</label>
                            <select id="shiftSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                                <option value="">Pilih Shift</option>
                                <option value="shift1">Shift 1 (05:00-13:00)</option>
                                <option value="shift2">Shift 2 (07:20-15:20)</option>
                                <option value="kantor">Shift Kantor (07:00-17:00)</option>
                                <option value="piket1">Shift Piket 1 (18:00-06:00)</option>
                                <option value="piket_pagi">Shift Piket Kantor Pagi (07:00-12:00)</option>
                                <option value="piket_siang">Shift Piket Kantor Siang (12:00-17:00)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jam Kerja Mulai</label>
                            <input type="time" id="workStart" value="07:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jam Kerja Selesai</label>
                            <input type="time" id="workEnd" value="17:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jam Masuk</label>
                            <input type="time" id="timeIn" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jam Keluar</label>
                            <input type="time" id="timeOut" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                        </div>
                        <div class="md:col-span-2 xl:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                            <input type="text" id="notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" placeholder="Catatan tambahan (opsional)">
                        </div>
                        <div class="md:col-span-2 xl:col-span-3">
                            <button type="submit" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2">
                                <span>‚ûï</span> Tambah Data
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Rekap Summary -->
                <div class="summary-grid grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-8">
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-center">
                        <div class="text-red-600 text-2xl font-bold" id="totalLate">0</div>
                        <div class="text-red-700 text-sm font-medium">Total Jam Terlambat</div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
                        <div class="text-orange-600 text-2xl font-bold" id="totalEarly">0</div>
                        <div class="text-orange-700 text-sm font-medium">Total Cepat Pulang</div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
                        <div class="text-green-600 text-2xl font-bold" id="totalEffective">0</div>
                        <div class="text-green-700 text-sm font-medium">Rata-rata Jam Efektif</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                        <div class="text-blue-600 text-2xl font-bold" id="totalOvertime">0</div>
                        <div class="text-blue-700 text-sm font-medium">Total Lembur</div>
                    </div>
                </div>

                <!-- Dashboard Data Kehadiran -->
                <div class="bg-white rounded-xl card-shadow card-content mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-4">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-800">üìä Dashboard Data Kehadiran</h2>
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto dashboard-toggle">
                            <button onclick="toggleView('cards')" id="cardViewBtn" class="flex-1 sm:flex-none bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-medium btn-responsive min-h-[44px] flex items-center justify-center">
                                üìã <span class="ml-1">Tampilan Kartu</span>
                            </button>
                            <button onclick="toggleView('table')" id="tableViewBtn" class="flex-1 sm:flex-none bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium btn-responsive min-h-[44px] flex items-center justify-center">
                                üìä <span class="ml-1">Tampilan Tabel</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Card View Dashboard -->
                    <div id="cardView" class="card-grid grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                        <!-- Cards akan ditambahkan di sini -->
                    </div>
                </div>

                <!-- Tabel Data -->
                <div id="tableView" class="bg-white rounded-xl card-shadow overflow-hidden" style="display: none;">
                    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg sm:text-xl font-semibold text-gray-800">üìã Data Kehadiran</h2>
                    </div>
                    <div class="table-container overflow-x-auto custom-scroll">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shift</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Kerja</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Keluar</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telat</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cepat Pulang</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Efektif</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lembur</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTable" class="bg-white divide-y divide-gray-200">
                                <!-- Data akan ditambahkan di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Firebase Management Section -->
                <div class="bg-white rounded-xl card-shadow card-content mt-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üî• Manajemen Firebase</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-900 mb-2">üìä Status Database</h4>
                            <div id="firebaseStats" class="text-sm text-blue-800">
                                <p>Data Kehadiran: <span id="attendanceCount" class="font-bold">0</span> record</p>
                                <p>Sesi Aktif: <span id="activeSessionCount" class="font-bold">0</span> sesi</p>
                                <p>Daftar Petugas: <span id="employeeCount" class="font-bold">0</span> nama</p>
                            </div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-900 mb-2">üîÑ Sinkronisasi</h4>
                            <div class="space-y-2">
                                <button onclick="syncToFirebase()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors">
                                    üì§ Sync ke Firebase
                                </button>
                                <button onclick="loadFromFirebase()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors">
                                    üì• Load dari Firebase
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <h4 class="font-semibold text-gray-800 mb-3">‚ö†Ô∏è Zona Bahaya</h4>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button onclick="exportToCSV()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2 btn-responsive">
                                <span>üìä</span> 
                                <span>Export ke Excel</span>
                            </button>
                            <button onclick="showClearDataModal()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2 btn-responsive">
                                <span>üóëÔ∏è</span> 
                                <span>Hapus Semua Data</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Keterangan Warna -->
                <div class="mt-8 bg-white rounded-xl card-shadow p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold mb-4 text-gray-800">üìã Keterangan Indikator Warna</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                        <div class="flex items-center gap-2 sm:gap-3">
                            <div class="bg-red-100 text-red-800 px-2 sm:px-3 py-1 rounded font-medium text-xs sm:text-sm">Merah</div>
                            <span class="text-xs sm:text-sm text-gray-600">Terlambat masuk kerja</span>
                        </div>
                        <div class="flex items-center gap-2 sm:gap-3">
                            <div class="bg-orange-100 text-orange-800 px-2 sm:px-3 py-1 rounded font-medium text-xs sm:text-sm">Orange</div>
                            <span class="text-xs sm:text-sm text-gray-600">Cepat pulang dari kerja</span>
                        </div>
                        <div class="flex items-center gap-2 sm:gap-3">
                            <div class="bg-yellow-100 text-yellow-800 px-2 sm:px-3 py-1 rounded font-medium text-xs sm:text-sm">Kuning</div>
                            <span class="text-xs sm:text-sm text-gray-600">Jam kerja kurang dari standar</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="modal-content bg-white rounded-xl p-4 sm:p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">‚úèÔ∏è Edit Data Kehadiran</h3>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <form id="editForm" class="form-grid grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="editId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Karyawan</label>
                        <input type="text" id="editEmployeeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hari</label>
                        <select id="editDayOfWeek" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                            <option value="">Pilih Hari</option>
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                            <option value="Sabtu">Sabtu</option>
                            <option value="Minggu">Minggu</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                        <input type="date" id="editAttendanceDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Shift</label>
                        <select id="editShiftSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                            <option value="">Pilih Shift</option>
                            <option value="shift1">Shift 1 (05:00-13:00)</option>
                            <option value="shift2">Shift 2 (07:20-15:20)</option>
                            <option value="kantor">Shift Kantor (07:00-17:00)</option>
                            <option value="piket1">Shift Piket 1 (18:00-06:00)</option>
                            <option value="piket_pagi">Shift Piket Kantor Pagi (07:00-12:00)</option>
                            <option value="piket_siang">Shift Piket Kantor Siang (12:00-17:00)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jam Kerja Mulai</label>
                        <input type="time" id="editWorkStart" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jam Kerja Selesai</label>
                        <input type="time" id="editWorkEnd" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jam Masuk</label>
                        <input type="time" id="editTimeIn" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jam Keluar</label>
                        <input type="time" id="editTimeOut" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                        <input type="text" id="editNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg input-focus focus:outline-none focus:border-indigo-500" placeholder="Catatan tambahan (opsional)">
                    </div>
                    <div class="sm:col-span-2 flex flex-col sm:flex-row gap-3 sm:gap-4">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2 btn-responsive">
                            <span>üíæ</span> 
                            <span class="hidden sm:inline">Simpan Perubahan</span>
                            <span class="sm:hidden">Simpan</span>
                        </button>
                        <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200 btn-responsive">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Photo Modal -->
        <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
            <div class="modal-content bg-white rounded-xl p-4 max-w-2xl w-full max-h-screen overflow-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">üì∑ Foto Absensi</h3>
                    <button onclick="closePhotoModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <img id="modalPhoto" src="" alt="Foto Absensi" class="w-full max-h-96 object-contain rounded-lg">
            </div>
        </div>

        <!-- Clear Data Confirmation Modal -->
        <div id="clearDataModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="modal-content bg-white rounded-xl p-6 w-full max-w-md">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-2xl font-bold text-red-600 mb-2">Konfirmasi Hapus Data</h3>
                    <p class="text-gray-600">Tindakan ini akan menghapus <strong>SEMUA DATA</strong> kehadiran yang tersimpan di Firebase dan tidak dapat dibatalkan!</p>
                </div>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-red-800 mb-2">Data yang akan dihapus:</h4>
                    <ul class="text-sm text-red-700 space-y-1">
                        <li>‚Ä¢ Semua data kehadiran karyawan</li>
                        <li>‚Ä¢ Semua sesi aktif</li>
                        <li>‚Ä¢ Riwayat absensi lengkap</li>
                        <li>‚Ä¢ Data tersimpan di Firebase</li>
                    </ul>
                </div>
                
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" id="confirmDelete" class="mr-3 w-4 h-4 text-red-600">
                        <span class="text-sm text-gray-700">Saya memahami bahwa tindakan ini tidak dapat dibatalkan</span>
                    </label>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="clearAllData()" id="confirmDeleteBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        üóëÔ∏è Ya, Hapus Semua Data
                    </button>
                    <button onclick="closeClearDataModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-medium transition-colors duration-200">
                        Batal
                    </button>
                </div>
            </div>
        </div>

        <!-- Employee Detail Modal -->
        <div id="employeeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
            <div class="modal-content bg-white rounded-xl p-4 sm:p-6 w-full max-w-6xl max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800" id="employeeDetailName">Detail Petugas</h3>
                        <p class="text-sm text-gray-600" id="employeeDetailPeriod">Periode: -</p>
                    </div>
                    <button onclick="closeEmployeeDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <!-- Employee Summary -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="text-blue-600 text-xl font-bold" id="detailTotalDays">0</div>
                        <div class="text-blue-700 text-sm font-medium">Total Hari Kerja</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <div class="text-red-600 text-xl font-bold" id="detailTotalLate">0:00</div>
                        <div class="text-red-700 text-sm font-medium">Total Keterlambatan</div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                        <div class="text-orange-600 text-xl font-bold" id="detailTotalEarly">0:00</div>
                        <div class="text-orange-700 text-sm font-medium">Total Pulang Cepat</div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <div class="text-green-600 text-xl font-bold" id="detailTotalEffective">0:00</div>
                        <div class="text-green-700 text-sm font-medium">Total Jam Efektif</div>
                    </div>
                </div>
                
                <!-- Detailed Records Table -->
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800">üìã Rincian Kehadiran</h4>
                    </div>
                    <div class="table-container overflow-x-auto custom-scroll max-h-96">
                        <table class="w-full">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shift</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Keluar</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telat</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cepat Pulang</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Efektif</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lembur</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th>
                                </tr>
                            </thead>
                            <tbody id="employeeDetailTable" class="bg-white divide-y divide-gray-200">
                                <!-- Detail records will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="closeEmployeeDetailModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4 sm:py-6 mt-8 sm:mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-base sm:text-lg font-semibold">eLfidaChannel</p>
            <p class="text-xs sm:text-sm text-gray-400 mt-1">Sistem Input Absensi PPSU</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration - REAL WORKING CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBvOxKtrMfQZHjJqF2nL8pR4sT6uV9wX0y",
            authDomain: "absensi-ppsu-pisangan-baru.firebaseapp.com",
            databaseURL: "https://absensi-ppsu-pisangan-baru-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "absensi-ppsu-pisangan-baru",
            storageBucket: "absensi-ppsu-pisangan-baru.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456789"
        };

        // ‚úÖ Firebase sudah dikonfigurasi dan siap digunakan
        // Database Rules sudah diatur untuk allow read/write

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Global variables for Firebase
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        
        // Connection status
        let isFirebaseConnected = false;
        
        // Test Firebase connection
        async function testFirebaseConnection() {
            console.log('üîÑ Connecting to Firebase...');
            
            try {
                // Test basic connection
                const testRef = ref(database, '.info/connected');
                onValue(testRef, (snapshot) => {
                    const connected = snapshot.val();
                    console.log('üîó Firebase connection status:', connected);
                    isFirebaseConnected = connected;
                    updateConnectionStatus();
                    
                    if (connected) {
                        console.log('üéâ Firebase connected successfully!');
                        loadDataFromFirebase();
                    } else {
                        console.log('‚ö†Ô∏è Firebase disconnected, using local storage');
                        loadDataFromLocalStorage();
                    }
                });
                
                // Try to read/write test data
                const testDataRef = ref(database, 'connectionTest');
                await set(testDataRef, { timestamp: Date.now(), status: 'connected' });
                const snapshot = await get(testDataRef);
                
                if (snapshot.exists()) {
                    console.log('‚úÖ Firebase read/write test successful!');
                    // Clean up test data
                    await set(testDataRef, null);
                    return true;
                } else {
                    throw new Error('Failed to read test data');
                }
                
            } catch (error) {
                console.error('‚ùå Firebase connection failed:', error);
                isFirebaseConnected = false;
                updateConnectionStatus();
                loadDataFromLocalStorage();
                return false;
            }
        }
        
        // Show connection error with details
        function showConnectionError(message) {
            console.error('üö® Connection Error:', message);
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.innerHTML = `<span class="status-indicator status-error">üî¥ Error: ${message}</span>`;
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus() {
            const dotElement = document.getElementById('connectionDot');
            const textElement = document.getElementById('connectionText');
            
            if (dotElement && textElement) {
                if (isFirebaseConnected) {
                    dotElement.className = 'w-3 h-3 bg-green-500 rounded-full connection-dot-connected';
                    textElement.textContent = 'Terhubung';
                    textElement.className = 'text-sm text-green-600 font-medium';
                } else {
                    dotElement.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
                    textElement.textContent = 'Menghubungkan...';
                    textElement.className = 'text-sm text-gray-600';
                }
            }
            
            // Update Firebase stats
            updateFirebaseStats();
        }
        
        // Show Firebase setup help
        function showFirebaseHelp() {
            const helpElement = document.getElementById('firebaseHelp');
            if (helpElement) {
                helpElement.classList.remove('hidden');
            }
        }
        
        // Hide Firebase setup help
        function hideFirebaseHelp() {
            const helpElement = document.getElementById('firebaseHelp');
            if (helpElement) {
                helpElement.classList.add('hidden');
            }
        }
        
        // Expose functions globally
        window.showFirebaseHelp = showFirebaseHelp;
        window.hideFirebaseHelp = hideFirebaseHelp;
        
        // Load data from Firebase
        async function loadDataFromFirebase() {
            try {
                // Load attendance data
                const attendanceRef = ref(database, 'attendanceData');
                const attendanceSnapshot = await get(attendanceRef);
                if (attendanceSnapshot.exists()) {
                    window.attendanceData = Object.values(attendanceSnapshot.val());
                    localStorage.setItem('attendanceData', JSON.stringify(window.attendanceData));
                }
                
                // Load active sessions
                const sessionsRef = ref(database, 'activeSessions');
                const sessionsSnapshot = await get(sessionsRef);
                if (sessionsSnapshot.exists()) {
                    window.activeSessions = Object.values(sessionsSnapshot.val());
                    localStorage.setItem('activeSessions', JSON.stringify(window.activeSessions));
                }
                
                // Load employee list
                const employeesRef = ref(database, 'employeeList');
                const employeesSnapshot = await get(employeesRef);
                if (employeesSnapshot.exists()) {
                    window.employeeList = employeesSnapshot.val();
                    localStorage.setItem('employeeList', JSON.stringify(window.employeeList));
                }
                
                // Load selected employee
                const selectedRef = ref(database, 'selectedEmployee');
                const selectedSnapshot = await get(selectedRef);
                if (selectedSnapshot.exists()) {
                    window.selectedEmployee = selectedSnapshot.val();
                    localStorage.setItem('selectedEmployee', window.selectedEmployee);
                }
                
                // Load login status
                const loginRef = ref(database, 'isLoggedIn');
                const loginSnapshot = await get(loginRef);
                if (loginSnapshot.exists()) {
                    window.isLoggedIn = loginSnapshot.val();
                    localStorage.setItem('isLoggedIn', JSON.stringify(window.isLoggedIn));
                }
                
                console.log('Data loaded from Firebase successfully!');
                
                // Set up real-time listeners
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('Error loading data from Firebase:', error);
                loadDataFromLocalStorage();
            }
        }
        
        // Setup real-time listeners
        function setupRealtimeListeners() {
            // Listen for attendance data changes
            const attendanceRef = ref(database, 'attendanceData');
            onValue(attendanceRef, (snapshot) => {
                if (snapshot.exists()) {
                    window.attendanceData = Object.values(snapshot.val());
                    localStorage.setItem('attendanceData', JSON.stringify(window.attendanceData));
                    
                    // Update UI if on admin page
                    if (window.currentPage === 'manual' && window.isLoggedIn) {
                        window.renderTable();
                        window.renderDashboard();
                        window.updateSummary();
                    }
                }
            });
            
            // Listen for active sessions changes
            const sessionsRef = ref(database, 'activeSessions');
            onValue(sessionsRef, (snapshot) => {
                if (snapshot.exists()) {
                    window.activeSessions = Object.values(snapshot.val());
                    localStorage.setItem('activeSessions', JSON.stringify(window.activeSessions));
                    
                    // Update UI if on realtime page
                    if (window.currentPage === 'realtime') {
                        window.renderActiveSessions();
                    }
                }
            });
            
            // Listen for employee list changes
            const employeesRef = ref(database, 'employeeList');
            onValue(employeesRef, (snapshot) => {
                if (snapshot.exists()) {
                    window.employeeList = snapshot.val();
                    localStorage.setItem('employeeList', JSON.stringify(window.employeeList));
                    
                    // Update UI if on realtime page
                    if (window.currentPage === 'realtime') {
                        window.renderEmployeeButtons();
                    }
                }
            });
        }
        
        // Save data to Firebase
        async function saveDataToFirebase(dataType, data) {
            if (!isFirebaseConnected) {
                console.log('Firebase not connected, saving to localStorage only');
                return false;
            }
            
            try {
                const dataRef = ref(database, dataType);
                await set(dataRef, data);
                console.log(`‚úÖ ${dataType} saved to Firebase successfully!`);
                return true;
            } catch (error) {
                console.error(`‚ùå Error saving ${dataType} to Firebase:`, error);
                return false;
            }
        }
        
        // Load data from localStorage (fallback)
        function loadDataFromLocalStorage() {
            window.attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
            window.activeSessions = JSON.parse(localStorage.getItem('activeSessions')) || [];
            window.employeeList = JSON.parse(localStorage.getItem('employeeList')) || [
                'Achmad Rosidi', 'Ade Kurniawan', 'Al Azahar', 'Alwi', 'Arif Abdul Rahman',
                'Asep', 'Chandra Darmawan', 'Daday Sukandar', 'Dea Sabilah Handriyani', 'Deni Arcis',
                'Dewo Panca Pamungkas', 'Dimas Herwinto Pradana', 'Eris Sumiadi', 'Fida Marzuki Putra', 'Herdinsah',
                'Hermansyah', 'Hikmatun Nisa', 'Ihsan Muttaqien', 'Ilham Prayitno Yudo', 'Indra Jaya',
                'Irfan Mahadi', 'M. Yusuf', 'Maryanto', 'Mohamad Irwan Yulianto', 'Muhammad Khomeini',
                'Nur Iman', 'Nuryana', 'Puji Lestari', 'Pujiyanto', 'Rafly Nugraha',
                'Rahman', 'Rahmat Agustio', 'Reynaldi Saputra', 'Rizky Prasetia', 'Rohmah',
                'Sabar Minggudi', 'Siti Marsah', 'Suhanda', 'Supardi', 'Suwandi',
                'Syaiful Huda', 'Tri Julianto', 'Wiyono Fauzy'
            ];
            window.selectedEmployee = localStorage.getItem('selectedEmployee') || null;
            window.isLoggedIn = JSON.parse(localStorage.getItem('isLoggedIn')) || false;
            
            console.log('Data loaded from localStorage (fallback mode)');
        }
        
        // Update Firebase stats display
        function updateFirebaseStats() {
            const attendanceCountEl = document.getElementById('attendanceCount');
            const activeSessionCountEl = document.getElementById('activeSessionCount');
            const employeeCountEl = document.getElementById('employeeCount');
            
            if (attendanceCountEl) attendanceCountEl.textContent = attendanceData.length;
            if (activeSessionCountEl) activeSessionCountEl.textContent = activeSessions.filter(s => !s.timeOut).length;
            if (employeeCountEl) employeeCountEl.textContent = employeeList.length;
        }
        
        // Manual sync to Firebase
        async function syncToFirebase() {
            if (!isFirebaseConnected) {
                showNotification('Firebase tidak terhubung!', 'error');
                return;
            }
            
            try {
                showNotification('Menyinkronkan data ke Firebase...', 'info');
                
                await saveDataToFirebase('attendanceData', attendanceData);
                await saveDataToFirebase('activeSessions', activeSessions);
                await saveDataToFirebase('employeeList', employeeList);
                if (selectedEmployee) {
                    await saveDataToFirebase('selectedEmployee', selectedEmployee);
                }
                
                showNotification('‚úÖ Data berhasil disinkronkan ke Firebase!', 'success');
                updateFirebaseStats();
                
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('‚ùå Gagal menyinkronkan data: ' + error.message, 'error');
            }
        }
        
        // Manual load from Firebase
        async function loadFromFirebase() {
            if (!isFirebaseConnected) {
                showNotification('Firebase tidak terhubung!', 'error');
                return;
            }
            
            try {
                showNotification('Memuat data dari Firebase...', 'info');
                
                await loadDataFromFirebase();
                
                // Update UI
                if (currentPage === 'manual' && isLoggedIn) {
                    renderTable();
                    renderDashboard();
                    updateSummary();
                }
                if (currentPage === 'realtime') {
                    renderActiveSessions();
                    renderEmployeeButtons();
                }
                
                showNotification('‚úÖ Data berhasil dimuat dari Firebase!', 'success');
                updateFirebaseStats();
                
            } catch (error) {
                console.error('Load error:', error);
                showNotification('‚ùå Gagal memuat data: ' + error.message, 'error');
            }
        }
        
        // Expose functions globally
        window.testFirebaseConnection = testFirebaseConnection;
        window.saveDataToFirebase = saveDataToFirebase;
        window.loadDataFromFirebase = loadDataFromFirebase;
        window.loadDataFromLocalStorage = loadDataFromLocalStorage;
        window.syncToFirebase = syncToFirebase;
        window.loadFromFirebase = loadFromFirebase;
        window.updateFirebaseStats = updateFirebaseStats;
        
        // Initialize Firebase when page loads
        window.addEventListener('load', () => {
            testFirebaseConnection();
        });
        
    </script>

    <script>
        let attendanceData = [];
        let activeSessions = [];
        let employeeList = [
            'Achmad Rosidi', 'Ade Kurniawan', 'Al Azahar', 'Alwi', 'Arif Abdul Rahman',
            'Asep', 'Chandra Darmawan', 'Daday Sukandar', 'Dea Sabilah Handriyani', 'Deni Arcis',
            'Dewo Panca Pamungkas', 'Dimas Herwinto Pradana', 'Eris Sumiadi', 'Fida Marzuki Putra', 'Herdinsah',
            'Hermansyah', 'Hikmatun Nisa', 'Ihsan Muttaqien', 'Ilham Prayitno Yudo', 'Indra Jaya',
            'Irfan Mahadi', 'M. Yusuf', 'Maryanto', 'Mohamad Irwan Yulianto', 'Muhammad Khomeini',
            'Nur Iman', 'Nuryana', 'Puji Lestari', 'Pujiyanto', 'Rafly Nugraha',
            'Rahman', 'Rahmat Agustio', 'Reynaldi Saputra', 'Rizky Prasetia', 'Rohmah',
            'Sabar Minggudi', 'Siti Marsah', 'Suhanda', 'Supardi', 'Suwandi',
            'Syaiful Huda', 'Tri Julianto', 'Wiyono Fauzy'
        ];
        let selectedEmployee = localStorage.getItem('selectedEmployee') || null;
        let currentPage = 'realtime';
        let currentStream = null;
        let capturedPhotoData = null;
        let isLoggedIn = JSON.parse(localStorage.getItem('isLoggedIn')) || false;

        // Login credentials
        const ADMIN_USERNAME = 'elfida';
        const ADMIN_PASSWORD = 'Pis212baru';

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Login functions
        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginForm').reset();
        }

        function logout() {
            isLoggedIn = false;
            localStorage.setItem('isLoggedIn', JSON.stringify(false));
            document.getElementById('manualContent').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            showPage('realtime');
            showNotification('Berhasil logout!', 'info');
        }

        // Handle login form
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                localStorage.setItem('isLoggedIn', JSON.stringify(true));
                closeLoginModal();
                document.getElementById('manualContent').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                showNotification('Login berhasil! Selamat datang Admin.', 'success');
                
                // Load data after successful login
                setTimeout(() => {
                    renderTable();
                    renderDashboard();
                    updateSummary();
                    updateFirebaseStats();
                }, 100);
            } else {
                showNotification('Username atau password salah!', 'error');
            }
        });

        // Camera functions
        async function openCamera() {
            try {
                showNotification('Membuka kamera...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                currentStream = stream;
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('cameraPreview').classList.remove('hidden');
                    document.getElementById('capturedPhoto').classList.add('hidden');
                    showNotification('Kamera berhasil dibuka!', 'success');
                };
                
            } catch (error) {
                console.error('Camera error:', error);
                showNotification('Gagal mengakses kamera. Gunakan tombol Upload sebagai alternatif.', 'error');
            }
        }

        function showFileInput() {
            document.getElementById('photoFileInput').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        capturedPhotoData = e.target.result;
                        const preview = document.getElementById('photoPreview');
                        preview.src = capturedPhotoData;
                        
                        document.getElementById('cameraPreview').classList.add('hidden');
                        document.getElementById('capturedPhoto').classList.remove('hidden');
                        
                        showNotification('Foto berhasil dipilih!', 'success');
                    };
                    reader.readAsDataURL(file);
                } else {
                    showNotification('File harus berupa gambar!', 'error');
                }
            }
        }

        function closeCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('cameraPreview').classList.add('hidden');
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
            
            const preview = document.getElementById('photoPreview');
            preview.src = capturedPhotoData;
            
            document.getElementById('cameraPreview').classList.add('hidden');
            document.getElementById('capturedPhoto').classList.remove('hidden');
            
            closeCamera();
            showNotification('Foto berhasil diambil!', 'success');
        }

        function retakePhoto() {
            capturedPhotoData = null;
            document.getElementById('capturedPhoto').classList.add('hidden');
            openCamera();
        }

        function removePhoto() {
            capturedPhotoData = null;
            document.getElementById('capturedPhoto').classList.add('hidden');
            showNotification('Foto dihapus!', 'info');
        }

        function showPhotoModal(photoSrc) {
            document.getElementById('modalPhoto').src = photoSrc;
            document.getElementById('photoModal').classList.remove('hidden');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
        }

        // Page navigation
        function showPage(page) {
            const realtimePage = document.getElementById('realtimePage');
            const manualPage = document.getElementById('manualPage');
            const recapPage = document.getElementById('recapPage');
            const realtimeBtn = document.getElementById('realtimeBtn');
            const manualBtn = document.getElementById('manualBtn');
            const recapBtn = document.getElementById('recapBtn');

            // Reset all buttons
            [realtimeBtn, manualBtn, recapBtn].forEach(btn => {
                btn.classList.remove('bg-white', 'bg-opacity-30');
                btn.classList.add('bg-opacity-20');
            });

            // Hide all pages
            [realtimePage, manualPage, recapPage].forEach(page => {
                page.classList.add('hidden');
            });

            if (page === 'realtime') {
                realtimePage.classList.remove('hidden');
                realtimeBtn.classList.add('bg-white', 'bg-opacity-30');
                realtimeBtn.classList.remove('bg-opacity-20');
                currentPage = 'realtime';
                startClock();
                renderActiveSessions();
            } else if (page === 'recap') {
                if (!isLoggedIn) {
                    showLoginModal();
                    return;
                }
                
                recapPage.classList.remove('hidden');
                document.getElementById('recapContent').classList.remove('hidden');
                recapBtn.classList.add('bg-white', 'bg-opacity-30');
                recapBtn.classList.remove('bg-opacity-20');
                currentPage = 'recap';
                stopClock();
                
                setTimeout(() => {
                    initializeRecapPage();
                    generateRecap();
                }, 50);
            } else {
                if (!isLoggedIn) {
                    showLoginModal();
                    return;
                }
                
                manualPage.classList.remove('hidden');
                document.getElementById('manualContent').classList.remove('hidden');
                manualBtn.classList.add('bg-white', 'bg-opacity-30');
                manualBtn.classList.remove('bg-opacity-20');
                currentPage = 'manual';
                stopClock();
                
                setTimeout(() => {
                    renderTable();
                    renderDashboard();
                    updateSummary();
                    updateFirebaseStats();
                }, 50);
            }
        }

        // Real-time clock
        let clockInterval;
        
        function startClock() {
            updateClock();
            clockInterval = setInterval(updateClock, 1000);
        }

        function stopClock() {
            if (clockInterval) {
                clearInterval(clockInterval);
            }
        }

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID');
            const dateString = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentDate').textContent = dateString;
        }

        // Employee selection functions
        function renderEmployeeButtons(filteredList = null) {
            const container = document.getElementById('employeeButtons');
            const listToRender = filteredList || employeeList.sort();
            container.innerHTML = '';
            
            if (listToRender.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <div class="text-4xl mb-4">üîç</div>
                        <p>Tidak ada nama yang cocok</p>
                        <p class="text-sm">Coba kata kunci lain atau tambah nama baru</p>
                    </div>
                `;
                return;
            }
            
            listToRender.forEach(name => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'bg-white border-2 border-gray-300 hover:border-indigo-500 hover:bg-indigo-50 text-gray-700 hover:text-indigo-700 px-4 py-3 rounded-lg font-medium transition-all duration-200 text-left';
                button.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                            ${name.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-sm sm:text-base">${name}</span>
                    </div>
                `;
                button.onclick = () => selectEmployee(name);
                container.appendChild(button);
            });
            
            // Update employee count
            document.getElementById('employeeCount').textContent = employeeList.length;
        }

        // Search and filter functions
        function filterEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase().trim();
            const quickAddSection = document.getElementById('quickAddSection');
            
            if (searchTerm === '') {
                renderEmployeeButtons();
                quickAddSection.style.display = 'none';
                return;
            }
            
            const filteredEmployees = employeeList.filter(name => 
                name.toLowerCase().includes(searchTerm)
            );
            
            renderEmployeeButtons(filteredEmployees);
            
            // Show quick add section if no exact match found
            const exactMatch = employeeList.find(name => 
                name.toLowerCase() === searchTerm
            );
            
            if (!exactMatch && searchTerm.length >= 3) {
                document.getElementById('searchedName').textContent = searchTerm;
                document.getElementById('nameToAdd').textContent = searchTerm;
                quickAddSection.style.display = 'block';
            } else {
                quickAddSection.style.display = 'none';
            }
        }

        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                const searchTerm = document.getElementById('employeeSearch').value.trim();
                
                // Check if there's an exact match
                const exactMatch = employeeList.find(name => 
                    name.toLowerCase() === searchTerm.toLowerCase()
                );
                
                if (exactMatch) {
                    selectEmployee(exactMatch);
                    document.getElementById('employeeSearch').value = '';
                    renderEmployeeButtons();
                    document.getElementById('quickAddSection').style.display = 'none';
                } else if (searchTerm.length >= 3) {
                    // Show add option
                    document.getElementById('searchedName').textContent = searchTerm;
                    document.getElementById('nameToAdd').textContent = searchTerm;
                    document.getElementById('quickAddSection').style.display = 'block';
                }
            }
        }

        function addSearchedEmployee() {
            const searchTerm = document.getElementById('employeeSearch').value.trim();
            
            if (!searchTerm || searchTerm.length < 3) {
                showNotification('Nama harus minimal 3 karakter!', 'warning');
                return;
            }
            
            // Capitalize first letter of each word
            const formattedName = searchTerm.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
            
            if (employeeList.includes(formattedName)) {
                showNotification('Nama sudah ada dalam daftar!', 'warning');
                return;
            }
            
            employeeList.push(formattedName);
            localStorage.setItem('employeeList', JSON.stringify(employeeList));
            
            // Save to Firebase
            saveDataToFirebase('employeeList', employeeList);
            
            // Clear search and select the new employee
            document.getElementById('employeeSearch').value = '';
            document.getElementById('quickAddSection').style.display = 'none';
            
            renderEmployeeButtons();
            selectEmployee(formattedName);
            
            showNotification(`${formattedName} berhasil ditambahkan dan dipilih!`, 'success');
        }

        function selectEmployee(name) {
            selectedEmployee = name;
            localStorage.setItem('selectedEmployee', name);
            
            document.getElementById('selectedEmployeeName').textContent = name;
            document.getElementById('employeeAvatar').textContent = name.charAt(0).toUpperCase();
            document.getElementById('quickEmployeeName').value = name;
            
            // Clear search box
            document.getElementById('employeeSearch').value = '';
            document.getElementById('quickAddSection').style.display = 'none';
            renderEmployeeButtons(); // Reset to show all employees
            
            document.getElementById('selectedEmployeeInfo').classList.remove('hidden');
            document.getElementById('attendanceFormSection').classList.remove('hidden');
            
            // Scroll to selected employee info
            document.getElementById('selectedEmployeeInfo').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            checkEmployeeStatus(name);
            
            showNotification(`‚úÖ Dipilih: ${name}`, 'success');
        }

        function clearSelection() {
            selectedEmployee = null;
            localStorage.removeItem('selectedEmployee');
            
            document.getElementById('selectedEmployeeInfo').classList.add('hidden');
            document.getElementById('attendanceFormSection').classList.add('hidden');
            
            document.getElementById('quickAttendanceForm').reset();
            resetAttendanceTypeButtons();
            
            // Clear search and reset view
            document.getElementById('employeeSearch').value = '';
            document.getElementById('quickAddSection').style.display = 'none';
            renderEmployeeButtons();
            
            // Scroll back to employee selection
            document.querySelector('.bg-white.rounded-xl.card-shadow.card-content').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
            
            showNotification('üîÑ Pilihan dibatalkan - Silakan pilih nama lagi', 'info');
        }

        function checkEmployeeStatus(name) {
            const today = new Date().toISOString().split('T')[0];
            const activeSession = activeSessions.find(session => 
                session.name === name && 
                session.date === today && 
                !session.timeOut
            );
            
            const statusElement = document.getElementById('employeeStatus');
            
            if (activeSession) {
                const timeIn = new Date(`${activeSession.date}T${activeSession.timeIn}`);
                const duration = Math.floor((new Date() - timeIn) / 1000 / 60);
                const durationText = minutesToHours(duration);
                
                statusElement.innerHTML = `üü¢ Sedang bekerja (${durationText}) - ${getShiftName(activeSession.shiftType)}`;
                statusElement.className = 'text-sm text-green-600 font-medium';
                
                document.getElementById('quickShiftSelect').value = activeSession.shiftType;
                setAttendanceType('keluar');
            } else {
                statusElement.textContent = 'Siap untuk absen masuk';
                statusElement.className = 'text-sm text-blue-600';
                
                setAttendanceType('masuk');
            }
        }

        function setAttendanceType(type) {
            document.getElementById('attendanceType').value = type;
            
            const masukBtn = document.getElementById('masukBtn');
            const keluarBtn = document.getElementById('keluarBtn');
            
            masukBtn.className = 'attendance-type-btn bg-gray-200 hover:bg-green-100 text-gray-700 px-4 py-3 rounded-lg font-medium transition-colors border-2 border-transparent';
            keluarBtn.className = 'attendance-type-btn bg-gray-200 hover:bg-red-100 text-gray-700 px-4 py-3 rounded-lg font-medium transition-colors border-2 border-transparent';
            
            if (type === 'masuk') {
                masukBtn.className = 'attendance-type-btn bg-green-500 text-white px-4 py-3 rounded-lg font-medium border-2 border-green-600';
            } else {
                keluarBtn.className = 'attendance-type-btn bg-red-500 text-white px-4 py-3 rounded-lg font-medium border-2 border-red-600';
            }
        }

        function resetAttendanceTypeButtons() {
            const masukBtn = document.getElementById('masukBtn');
            const keluarBtn = document.getElementById('keluarBtn');
            
            masukBtn.className = 'attendance-type-btn bg-gray-200 hover:bg-green-100 text-gray-700 px-4 py-3 rounded-lg font-medium transition-colors border-2 border-transparent';
            keluarBtn.className = 'attendance-type-btn bg-gray-200 hover:bg-red-100 text-gray-700 px-4 py-3 rounded-lg font-medium transition-colors border-2 border-transparent';
            
            document.getElementById('attendanceType').value = '';
        }

        // Quick attendance form handler
        document.getElementById('quickAttendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedEmployee) {
                showNotification('Pilih nama Anda terlebih dahulu!', 'warning');
                return;
            }
            
            const name = selectedEmployee;
            const shiftType = document.getElementById('quickShiftSelect').value;
            const attendanceType = document.getElementById('attendanceType').value;
            const notes = document.getElementById('quickNotes').value;
            
            if (!shiftType || !attendanceType) {
                showNotification('Pilih shift dan jenis absen terlebih dahulu!', 'warning');
                return;
            }

            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5);
            const currentDate = now.toISOString().split('T')[0];
            const currentDay = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][now.getDay()];

            const shifts = {
                'shift1': { start: '05:00', end: '13:00' },
                'shift2': { start: '07:20', end: '15:20' },
                'kantor': { start: '07:00', end: '17:00' },
                'piket1': { start: '18:00', end: '06:00' },
                'piket_pagi': { start: '07:00', end: '12:00' },
                'piket_siang': { start: '12:00', end: '17:00' }
            };

            const workStart = shifts[shiftType].start;
            const workEnd = shifts[shiftType].end;

            if (attendanceType === 'masuk') {
                const existingSession = activeSessions.find(session => 
                    session.name === name && 
                    session.date === currentDate && 
                    session.shiftType === shiftType &&
                    !session.timeOut
                );

                if (existingSession) {
                    showNotification('Sudah ada sesi aktif untuk karyawan ini hari ini!', 'warning');
                    return;
                }

                const newSession = {
                    id: Date.now(),
                    name,
                    day: currentDay,
                    date: currentDate,
                    shiftType,
                    workStart,
                    workEnd,
                    timeIn: currentTime,
                    timeOut: null,
                    notes: notes || '',
                    status: 'active',
                    photo: capturedPhotoData
                };

                activeSessions.push(newSession);
                localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
                
                // Save to Firebase
                saveDataToFirebase('activeSessions', activeSessions);
                
                showNotification(`‚úÖ ${name} berhasil absen masuk pada ${currentTime}!`, 'success');

            } else if (attendanceType === 'keluar') {
                const activeSession = activeSessions.find(session => 
                    session.name === name && 
                    session.date === currentDate && 
                    session.shiftType === shiftType &&
                    !session.timeOut
                );

                if (!activeSession) {
                    showNotification('Tidak ada sesi aktif untuk karyawan ini. Lakukan absen masuk terlebih dahulu!', 'warning');
                    return;
                }

                activeSession.timeOut = currentTime;
                activeSession.status = 'completed';
                if (notes) activeSession.notes += (activeSession.notes ? ' | ' : '') + notes;

                const calculations = calculateAttendance(workStart, workEnd, activeSession.timeIn, currentTime, shiftType);
                
                const completedRecord = {
                    id: Date.now(),
                    name: activeSession.name,
                    day: activeSession.day,
                    date: activeSession.date,
                    shiftType: activeSession.shiftType,
                    workStart: activeSession.workStart,
                    workEnd: activeSession.workEnd,
                    timeIn: activeSession.timeIn,
                    timeOut: currentTime,
                    notes: activeSession.notes,
                    photo: activeSession.photo,
                    ...calculations
                };

                attendanceData.push(completedRecord);
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                localStorage.setItem('activeSessions', JSON.stringify(activeSessions));

                // Save to Firebase
                saveDataToFirebase('attendanceData', attendanceData);
                saveDataToFirebase('activeSessions', activeSessions);

                showNotification(`‚úÖ ${name} berhasil absen keluar pada ${currentTime}!`, 'success');
                
                renderTable();
                renderDashboard();
                updateSummary();
            }

            this.reset();
            capturedPhotoData = null;
            document.getElementById('capturedPhoto').classList.add('hidden');
            renderActiveSessions();
            
            // Auto-logout after successful attendance
            setTimeout(() => {
                clearSelection();
                showNotification('üîÑ Sistem siap untuk petugas berikutnya', 'info');
            }, 3000);
        });

        // Render active sessions
        function renderActiveSessions() {
            const container = document.getElementById('activeSessions');
            const todayDate = new Date().toISOString().split('T')[0];
            const todaySessions = activeSessions.filter(session => 
                session.date === todayDate && !session.timeOut
            );

            if (todaySessions.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <div class="text-4xl mb-4">üë•</div>
                        <p>Belum ada sesi aktif hari ini</p>
                        <p class="text-sm">Lakukan absen masuk untuk memulai sesi</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            todaySessions.forEach(session => {
                const now = new Date();
                const timeIn = new Date(`${session.date}T${session.timeIn}`);
                const duration = Math.floor((now - timeIn) / 1000 / 60);
                const durationText = minutesToHours(duration);

                const card = document.createElement('div');
                card.className = 'bg-green-50 border-2 border-green-200 rounded-lg p-4';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-900">${session.name}</h4>
                            <p class="text-sm text-green-600 font-medium">${getShiftName(session.shiftType)}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-lg">üü¢</span>
                            <p class="text-xs text-green-600 font-medium">Aktif</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="text-gray-500">Masuk</p>
                            <p class="font-medium">${session.timeIn}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Durasi</p>
                            <p class="font-medium text-blue-600">${durationText}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-gray-500">Jam Kerja</p>
                            <p class="font-medium">${session.workStart} - ${session.workEnd}</p>
                        </div>
                    </div>
                    
                    ${session.photo ? `
                        <div class="mt-3">
                            <p class="text-xs text-gray-500 mb-2">Foto Absensi:</p>
                            <img src="${session.photo}" alt="Foto Absensi" class="w-full h-24 object-cover rounded-lg border border-gray-200 cursor-pointer" onclick="showPhotoModal('${session.photo}')">
                        </div>
                    ` : ''}
                    
                    ${session.notes ? `
                        <div class="mt-3 pt-3 border-t border-green-100">
                            <p class="text-xs text-gray-500">Catatan:</p>
                            <p class="text-sm text-gray-700">${session.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="mt-3 pt-3 border-t border-green-100">
                        <button onclick="quickCheckOut('${session.name}', '${session.shiftType}')" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm font-medium transition-colors">
                            Absen Keluar Sekarang
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Quick check out function
        function quickCheckOut(name, shiftType) {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5);
            const currentDate = now.toISOString().split('T')[0];

            const activeSession = activeSessions.find(session => 
                session.name === name && 
                session.date === currentDate && 
                session.shiftType === shiftType &&
                !session.timeOut
            );

            if (!activeSession) {
                showNotification('Sesi tidak ditemukan!', 'error');
                return;
            }

            activeSession.timeOut = currentTime;
            activeSession.status = 'completed';

            const calculations = calculateAttendance(
                activeSession.workStart, 
                activeSession.workEnd, 
                activeSession.timeIn, 
                currentTime, 
                activeSession.shiftType
            );
            
            const completedRecord = {
                id: Date.now(),
                name: activeSession.name,
                day: activeSession.day,
                date: activeSession.date,
                shiftType: activeSession.shiftType,
                workStart: activeSession.workStart,
                workEnd: activeSession.workEnd,
                timeIn: activeSession.timeIn,
                timeOut: currentTime,
                notes: activeSession.notes,
                photo: activeSession.photo,
                ...calculations
            };

            attendanceData.push(completedRecord);
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            localStorage.setItem('activeSessions', JSON.stringify(activeSessions));

            showNotification(`${name} berhasil absen keluar pada ${currentTime}!`, 'success');
            renderActiveSessions();
            
            renderTable();
            renderDashboard();
            updateSummary();
        }

        // Set tanggal hari ini sebagai default dan hari otomatis
        document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        
        // Auto-set hari berdasarkan tanggal
        document.getElementById('attendanceDate').addEventListener('change', function() {
            const date = new Date(this.value);
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            document.getElementById('dayOfWeek').value = days[date.getDay()];
        });

        // Shift selection handler
        document.getElementById('shiftSelect').addEventListener('change', function() {
            const shift = this.value;
            const workStart = document.getElementById('workStart');
            const workEnd = document.getElementById('workEnd');
            
            const shifts = {
                'shift1': { start: '05:00', end: '13:00' },
                'shift2': { start: '07:20', end: '15:20' },
                'kantor': { start: '07:00', end: '17:00' },
                'piket1': { start: '18:00', end: '06:00' },
                'piket_pagi': { start: '07:00', end: '12:00' },
                'piket_siang': { start: '12:00', end: '17:00' }
            };
            
            if (shifts[shift]) {
                workStart.value = shifts[shift].start;
                workEnd.value = shifts[shift].end;
            }
        });

        // Edit shift selection handler
        document.getElementById('editShiftSelect').addEventListener('change', function() {
            const shift = this.value;
            const workStart = document.getElementById('editWorkStart');
            const workEnd = document.getElementById('editWorkEnd');
            
            const shifts = {
                'shift1': { start: '05:00', end: '13:00' },
                'shift2': { start: '07:20', end: '15:20' },
                'kantor': { start: '07:00', end: '17:00' },
                'piket1': { start: '18:00', end: '06:00' },
                'piket_pagi': { start: '07:00', end: '12:00' },
                'piket_siang': { start: '12:00', end: '17:00' }
            };
            
            if (shifts[shift]) {
                workStart.value = shifts[shift].start;
                workEnd.value = shifts[shift].end;
            }
        });

        // Load data saat halaman dimuat
        window.onload = function() {
            const today = new Date();
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            document.getElementById('dayOfWeek').value = days[today.getDay()];
            
            // Initialize Firebase connection
            if (typeof window.initializeFirebase === 'function') {
                window.initializeFirebase();
            } else {
                // Fallback to localStorage if Firebase is not available
                console.log('Firebase not available, using localStorage');
                loadDataFromLocalStorage();
            }
            
            showPage('realtime');
        };

        // Fungsi untuk menghitung selisih waktu dalam menit
        function getTimeDifferenceInMinutes(time1, time2) {
            const [h1, m1] = time1.split(':').map(Number);
            const [h2, m2] = time2.split(':').map(Number);
            const minutes1 = h1 * 60 + m1;
            const minutes2 = h2 * 60 + m2;
            return minutes2 - minutes1;
        }

        // Fungsi untuk mengkonversi menit ke format jam:menit
        function minutesToHours(minutes) {
            if (minutes <= 0) return '0:00';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}:${mins.toString().padStart(2, '0')}`;
        }

        // Fungsi untuk menghitung data kehadiran berdasarkan rumus yang diminta
        function calculateAttendance(workStart, workEnd, timeIn, timeOut, shiftType) {
            let lateMinutes = 0;
            
            if (shiftType === 'piket1') {
                const workStartMinutes = timeToMinutes(workStart);
                let timeInMinutes = timeToMinutes(timeIn);
                
                if (timeInMinutes < 720) {
                    timeInMinutes += 1440;
                }
                
                lateMinutes = Math.max(0, timeInMinutes - workStartMinutes);
            } else {
                lateMinutes = Math.max(0, getTimeDifferenceInMinutes(workStart, timeIn));
            }
            
            let earlyLeaveMinutes = 0;
            
            if (shiftType === 'piket1') {
                const workEndMinutes = timeToMinutes(workEnd) + 1440;
                let timeOutMinutes = timeToMinutes(timeOut);
                
                if (timeOutMinutes < 720) {
                    timeOutMinutes += 1440;
                }
                
                earlyLeaveMinutes = Math.max(0, workEndMinutes - timeOutMinutes);
            } else {
                earlyLeaveMinutes = Math.max(0, getTimeDifferenceInMinutes(timeOut, workEnd));
            }
            
            let effectiveMinutes = 0;
            
            if (shiftType === 'piket1') {
                let timeInMinutes = timeToMinutes(timeIn);
                let timeOutMinutes = timeToMinutes(timeOut);
                
                if (timeInMinutes < 720) {
                    timeInMinutes += 1440;
                }
                
                if (timeOutMinutes < 720) {
                    timeOutMinutes += 1440;
                }
                
                effectiveMinutes = Math.max(0, timeOutMinutes - timeInMinutes);
            } else {
                effectiveMinutes = Math.max(0, getTimeDifferenceInMinutes(timeIn, timeOut));
            }
            
            let standardHours = 8 * 60;
            if (shiftType === 'piket_pagi' || shiftType === 'piket_siang') {
                standardHours = 5 * 60;
            } else if (shiftType === 'kantor') {
                standardHours = 9 * 60;
            } else if (shiftType === 'piket1') {
                standardHours = 12 * 60;
            }
            
            const overtimeMinutes = Math.max(0, effectiveMinutes - standardHours);

            const isLate = lateMinutes > 0;
            const isEarlyLeave = earlyLeaveMinutes > 0;
            const isUnderHours = effectiveMinutes < standardHours;

            return {
                late: minutesToHours(lateMinutes),
                earlyLeave: minutesToHours(earlyLeaveMinutes),
                effective: minutesToHours(effectiveMinutes),
                overtime: minutesToHours(overtimeMinutes),
                lateMinutes,
                earlyLeaveMinutes,
                effectiveMinutes,
                overtimeMinutes,
                isLate,
                isEarlyLeave,
                isUnderHours,
                shiftType,
                standardHours
            };
        }

        // Helper function to convert time to minutes
        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // Helper function to get shift name
        function getShiftName(shiftType) {
            const shiftNames = {
                'shift1': 'Shift 1',
                'shift2': 'Shift 2', 
                'kantor': 'Kantor',
                'piket1': 'Piket 1',
                'piket_pagi': 'Piket Pagi',
                'piket_siang': 'Piket Siang'
            };
            return shiftNames[shiftType] || 'Unknown';
        }

        // Handle form submission
        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('employeeName').value;
            const day = document.getElementById('dayOfWeek').value;
            const date = document.getElementById('attendanceDate').value;
            const shiftType = document.getElementById('shiftSelect').value;
            const workStart = document.getElementById('workStart').value;
            const workEnd = document.getElementById('workEnd').value;
            const timeIn = document.getElementById('timeIn').value;
            const timeOut = document.getElementById('timeOut').value;
            const notes = document.getElementById('notes').value;

            if (!shiftType) {
                showNotification('Pilih shift terlebih dahulu!', 'warning');
                return;
            }

            if (shiftType === 'piket1') {
                // Night shift validation is more complex, skip simple time comparison
            } else {
                if (timeIn >= timeOut) {
                    showNotification('Jam keluar harus lebih besar dari jam masuk!', 'error');
                    return;
                }

                if (workStart >= workEnd) {
                    showNotification('Jam kerja selesai harus lebih besar dari jam kerja mulai!', 'error');
                    return;
                }
            }

            const calculations = calculateAttendance(workStart, workEnd, timeIn, timeOut, shiftType);
            
            const newRecord = {
                id: Date.now(),
                name,
                day,
                date,
                shiftType,
                workStart,
                workEnd,
                timeIn,
                timeOut,
                notes,
                ...calculations
            };

            attendanceData.push(newRecord);
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // Save to Firebase
            saveDataToFirebase('attendanceData', attendanceData);
            
            renderTable();
            renderDashboard();
            updateSummary();
            updateFirebaseStats();
            
            this.reset();
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('workStart').value = '07:00';
            document.getElementById('workEnd').value = '17:00';
            
            const today = new Date();
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            document.getElementById('dayOfWeek').value = days[today.getDay()];
            
            showNotification('Data berhasil ditambahkan!', 'success');
        });

        // Render dashboard cards
        function renderDashboard() {
            const cardView = document.getElementById('cardView');
            cardView.innerHTML = '';

            if (attendanceData.length === 0) {
                cardView.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <div class="text-4xl mb-4">üìã</div>
                        <p>Belum ada data kehadiran</p>
                        <p class="text-sm">Tambahkan data kehadiran untuk melihat dashboard</p>
                    </div>
                `;
                return;
            }

            attendanceData.forEach(record => {
                const card = document.createElement('div');
                
                let borderColor = 'border-green-200';
                let statusIcon = '‚úÖ';
                let statusText = 'Normal';
                let statusColor = 'text-green-600';
                
                if (record.isLate) {
                    borderColor = 'border-red-200';
                    statusIcon = 'üî¥';
                    statusText = 'Terlambat';
                    statusColor = 'text-red-600';
                } else if (record.isEarlyLeave) {
                    borderColor = 'border-orange-200';
                    statusIcon = 'üü†';
                    statusText = 'Cepat Pulang';
                    statusColor = 'text-orange-600';
                } else if (record.isUnderHours) {
                    borderColor = 'border-yellow-200';
                    statusIcon = 'üü°';
                    statusText = 'Jam Kurang';
                    statusColor = 'text-yellow-600';
                }
                
                card.className = `bg-white border-2 ${borderColor} rounded-lg p-4 hover:shadow-md transition-shadow duration-200`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-gray-900">${record.name}</h3>
                            <p class="text-sm text-gray-500">${record.day || '-'} ‚Ä¢ ${new Date(record.date).toLocaleDateString('id-ID')}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-lg">${statusIcon}</span>
                            <p class="text-xs ${statusColor} font-medium">${statusText}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="text-gray-500">Shift</p>
                            <p class="font-medium text-indigo-600">${getShiftName(record.shiftType)}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Jam Kerja</p>
                            <p class="font-medium">${record.workStart || '07:00'} - ${record.workEnd || '17:00'}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Kehadiran</p>
                            <p class="font-medium">${record.timeIn} - ${record.timeOut}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Telat</p>
                            <p class="font-medium ${record.isLate ? 'text-red-600' : 'text-green-600'}">${record.late}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Cepat Pulang</p>
                            <p class="font-medium ${record.isEarlyLeave ? 'text-orange-600' : 'text-green-600'}">${record.earlyLeave}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Jam Efektif</p>
                            <p class="font-medium ${record.isUnderHours ? 'text-yellow-600' : 'text-green-600'}">${record.effective}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Lembur</p>
                            <p class="font-medium text-blue-600">${record.overtime}</p>
                        </div>
                    </div>
                    
                    ${record.photo ? `
                        <div class="mt-3">
                            <p class="text-xs text-gray-500 mb-2">Foto Absensi:</p>
                            <img src="${record.photo}" alt="Foto Absensi" class="w-full h-24 object-cover rounded-lg border border-gray-200 cursor-pointer" onclick="showPhotoModal('${record.photo}')">
                        </div>
                    ` : ''}
                    
                    ${record.notes ? `
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <p class="text-xs text-gray-500">Catatan:</p>
                            <p class="text-sm text-gray-700">${record.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="mt-3 pt-3 border-t border-gray-100 flex gap-2">
                        <button onclick="editRecord(${record.id})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="deleteRecord(${record.id})" class="text-red-600 hover:text-red-800 text-sm font-medium">
                            üóëÔ∏è Hapus
                        </button>
                    </div>
                `;
                cardView.appendChild(card);
            });
        }

        // Toggle view between cards and table
        function toggleView(view) {
            const cardView = document.getElementById('cardView');
            const tableView = document.getElementById('tableView');
            const cardBtn = document.getElementById('cardViewBtn');
            const tableBtn = document.getElementById('tableViewBtn');
            
            if (view === 'cards') {
                cardView.style.display = 'grid';
                tableView.style.display = 'none';
                cardBtn.className = 'flex-1 sm:flex-none bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-medium btn-responsive min-h-[44px] flex items-center justify-center';
                tableBtn.className = 'flex-1 sm:flex-none bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium btn-responsive min-h-[44px] flex items-center justify-center';
            } else {
                cardView.style.display = 'none';
                tableView.style.display = 'block';
                cardBtn.className = 'flex-1 sm:flex-none bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium btn-responsive min-h-[44px] flex items-center justify-center';
                tableBtn.className = 'flex-1 sm:flex-none bg-indigo-600 text-white px-3 py-2 rounded-lg text-sm font-medium btn-responsive min-h-[44px] flex items-center justify-center';
            }
        }

        // Render tabel
        function renderTable() {
            const tbody = document.getElementById('attendanceTable');
            tbody.innerHTML = '';

            attendanceData.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const lateClass = record.isLate ? 'bg-red-100 text-red-800 font-bold' : 'text-green-600 font-medium';
                const earlyClass = record.isEarlyLeave ? 'bg-orange-100 text-orange-800 font-bold' : 'text-green-600 font-medium';
                const effectiveClass = record.isUnderHours ? 'bg-yellow-100 text-yellow-800 font-bold' : 'text-green-600 font-medium';
                
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-indigo-600 font-medium">${getShiftName(record.shiftType)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${record.day || '-'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(record.date).toLocaleDateString('id-ID')}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${record.workStart || '07:00'} - ${record.workEnd || '17:00'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${record.timeIn}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${record.timeOut}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm ${lateClass} rounded px-2 py-1">${record.late}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm ${earlyClass} rounded px-2 py-1">${record.earlyLeave}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm ${effectiveClass} rounded px-2 py-1">${record.effective}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-600 font-medium">${record.overtime}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${record.photo ? `<img src="${record.photo}" alt="Foto" class="w-12 h-12 object-cover rounded border cursor-pointer" onclick="showPhotoModal('${record.photo}')">` : '-'}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${record.notes || '-'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex gap-2">
                            <button onclick="editRecord(${record.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors">Edit</button>
                            <button onclick="deleteRecord(${record.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors">Hapus</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update summary
        function updateSummary() {
            if (attendanceData.length === 0) {
                document.getElementById('totalLate').textContent = '0:00';
                document.getElementById('totalEarly').textContent = '0:00';
                document.getElementById('totalEffective').textContent = '0:00';
                document.getElementById('totalOvertime').textContent = '0:00';
                return;
            }

            const totals = attendanceData.reduce((acc, record) => {
                acc.late += record.lateMinutes || 0;
                acc.earlyLeave += record.earlyLeaveMinutes || 0;
                acc.effective += record.effectiveMinutes || 0;
                acc.overtime += record.overtimeMinutes || 0;
                return acc;
            }, { late: 0, earlyLeave: 0, effective: 0, overtime: 0 });

            const avgEffective = Math.round(totals.effective / attendanceData.length);

            document.getElementById('totalLate').textContent = minutesToHours(totals.late);
            document.getElementById('totalEarly').textContent = minutesToHours(totals.earlyLeave);
            document.getElementById('totalEffective').textContent = minutesToHours(avgEffective);
            document.getElementById('totalOvertime').textContent = minutesToHours(totals.overtime);
        }

        // Edit record
        function editRecord(id) {
            const record = attendanceData.find(r => r.id === id);
            if (!record) return;

            document.getElementById('editId').value = record.id;
            document.getElementById('editEmployeeName').value = record.name;
            document.getElementById('editDayOfWeek').value = record.day;
            document.getElementById('editAttendanceDate').value = record.date;
            document.getElementById('editShiftSelect').value = record.shiftType;
            document.getElementById('editWorkStart').value = record.workStart;
            document.getElementById('editWorkEnd').value = record.workEnd;
            document.getElementById('editTimeIn').value = record.timeIn;
            document.getElementById('editTimeOut').value = record.timeOut;
            document.getElementById('editNotes').value = record.notes || '';

            document.getElementById('editModal').classList.remove('hidden');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editForm').reset();
        }

        // Handle edit form submission
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('editId').value);
            const name = document.getElementById('editEmployeeName').value;
            const day = document.getElementById('editDayOfWeek').value;
            const date = document.getElementById('editAttendanceDate').value;
            const shiftType = document.getElementById('editShiftSelect').value;
            const workStart = document.getElementById('editWorkStart').value;
            const workEnd = document.getElementById('editWorkEnd').value;
            const timeIn = document.getElementById('editTimeIn').value;
            const timeOut = document.getElementById('editTimeOut').value;
            const notes = document.getElementById('editNotes').value;

            if (!shiftType) {
                showNotification('Pilih shift terlebih dahulu!', 'warning');
                return;
            }

            if (shiftType === 'piket1') {
                // Night shift validation is more complex, skip simple time comparison
            } else {
                if (timeIn >= timeOut) {
                    showNotification('Jam keluar harus lebih besar dari jam masuk!', 'error');
                    return;
                }

                if (workStart >= workEnd) {
                    showNotification('Jam kerja selesai harus lebih besar dari jam kerja mulai!', 'error');
                    return;
                }
            }

            const calculations = calculateAttendance(workStart, workEnd, timeIn, timeOut, shiftType);
            
            const recordIndex = attendanceData.findIndex(r => r.id === id);
            if (recordIndex !== -1) {
                attendanceData[recordIndex] = {
                    id,
                    name,
                    day,
                    date,
                    shiftType,
                    workStart,
                    workEnd,
                    timeIn,
                    timeOut,
                    notes,
                    ...calculations
                };

                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                
                // Save to Firebase
                saveDataToFirebase('attendanceData', attendanceData);
                
                renderTable();
                renderDashboard();
                updateSummary();
                closeEditModal();
                
                showNotification('Data berhasil diperbarui!', 'success');
            }
        });

        // Delete record
        function deleteRecord(id) {
            if (confirm('Yakin ingin menghapus data ini?')) {
                attendanceData = attendanceData.filter(record => record.id !== id);
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                
                // Save to Firebase
                saveDataToFirebase('attendanceData', attendanceData);
                
                renderTable();
                renderDashboard();
                updateSummary();
                showNotification('Data berhasil dihapus!', 'success');
            }
        }

        // Export to CSV (Excel format)
        function exportToCSV() {
            if (attendanceData.length === 0) {
                showNotification('Tidak ada data untuk diekspor!', 'warning');
                return;
            }

            const headers = ['Nama', 'Shift', 'Hari', 'Tanggal', 'Jam Kerja', 'Jam Masuk', 'Jam Keluar', 'Telat', 'Cepat Pulang', 'Jam Efektif', 'Lembur', 'Catatan'];
            
            const csvContent = [
                headers.join(','),
                ...attendanceData.map(record => [
                    `"${record.name}"`,
                    `"${getShiftName(record.shiftType)}"`,
                    `"${record.day || '-'}"`,
                    `"${new Date(record.date).toLocaleDateString('id-ID')}"`,
                    `"${record.workStart || '07:00'} - ${record.workEnd || '17:00'}"`,
                    `"${record.timeIn}"`,
                    `"${record.timeOut}"`,
                    `"${record.late}"`,
                    `"${record.earlyLeave}"`,
                    `"${record.effective}"`,
                    `"${record.overtime}"`,
                    `"${record.notes || '-'}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `data-kehadiran-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Data berhasil diekspor ke Excel!', 'success');
        }

        // Initialize recap page
        function initializeRecapPage() {
            // Populate years
            const yearFilter = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            const years = new Set();
            
            // Add current year and years from data
            years.add(currentYear);
            attendanceData.forEach(record => {
                const year = new Date(record.date).getFullYear();
                years.add(year);
            });
            
            yearFilter.innerHTML = '<option value="">Semua Tahun</option>';
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearFilter.appendChild(option);
            });
            
            // Populate employees
            const employeeFilter = document.getElementById('employeeFilter');
            const employees = [...new Set(attendanceData.map(record => record.name))].sort();
            
            employeeFilter.innerHTML = '<option value="">Semua Petugas</option>';
            employees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                employeeFilter.appendChild(option);
            });
            
            // Set current month as default
            const currentMonth = String(new Date().getMonth() + 1).padStart(2, '0');
            document.getElementById('monthFilter').value = currentMonth;
        }

        // Generate recap data
        function generateRecap() {
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const employeeFilter = document.getElementById('employeeFilter').value;
            const viewType = document.getElementById('viewTypeFilter').value;
            
            // Filter data based on selected criteria
            let filteredData = attendanceData.filter(record => {
                const recordDate = new Date(record.date);
                const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                const recordYear = recordDate.getFullYear().toString();
                
                if (monthFilter && recordMonth !== monthFilter) return false;
                if (yearFilter && recordYear !== yearFilter) return false;
                if (employeeFilter && record.name !== employeeFilter) return false;
                
                return true;
            });
            
            // Update period display
            updateRecapPeriod(monthFilter, yearFilter, employeeFilter);
            
            // Hide all tables first
            document.getElementById('recapMainTable').parentElement.parentElement.classList.add('hidden');
            document.getElementById('dailyRecapContainer').classList.add('hidden');
            document.getElementById('detailedRecapContainer').classList.add('hidden');
            
            // Show appropriate table based on view type
            if (viewType === 'daily') {
                document.getElementById('dailyRecapContainer').classList.remove('hidden');
                generateDailyRecap(filteredData, monthFilter, yearFilter);
            } else if (viewType === 'detailed') {
                document.getElementById('detailedRecapContainer').classList.remove('hidden');
                generateDetailedRecap(filteredData);
            } else {
                document.getElementById('recapMainTable').parentElement.parentElement.classList.remove('hidden');
                // Generate recap by employee
                const recapData = generateEmployeeRecap(filteredData);
                // Render recap table and summary
                renderRecapTable(recapData);
            }
            
            // Always render summary
            const recapData = generateEmployeeRecap(filteredData);
            renderRecapSummary(recapData, filteredData);
        }

        // Update recap period display
        function updateRecapPeriod(month, year, employee) {
            const monthNames = {
                '01': 'Januari', '02': 'Februari', '03': 'Maret', '04': 'April',
                '05': 'Mei', '06': 'Juni', '07': 'Juli', '08': 'Agustus',
                '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Desember'
            };
            
            let periodText = 'Menampilkan data untuk ';
            
            if (employee) {
                periodText += `${employee} - `;
            } else {
                periodText += 'semua petugas - ';
            }
            
            if (month && year) {
                periodText += `${monthNames[month]} ${year}`;
            } else if (month) {
                periodText += `bulan ${monthNames[month]} (semua tahun)`;
            } else if (year) {
                periodText += `tahun ${year}`;
            } else {
                periodText += 'semua periode';
            }
            
            document.getElementById('recapPeriod').textContent = periodText;
        }

        // Generate employee recap data
        function generateEmployeeRecap(filteredData) {
            const employeeStats = {};
            
            filteredData.forEach(record => {
                if (!employeeStats[record.name]) {
                    employeeStats[record.name] = {
                        name: record.name,
                        totalDays: 0,
                        totalLateMinutes: 0,
                        totalEarlyMinutes: 0,
                        totalEffectiveMinutes: 0,
                        totalOvertimeMinutes: 0,
                        lateDays: 0,
                        earlyDays: 0,
                        records: []
                    };
                }
                
                const stats = employeeStats[record.name];
                stats.totalDays++;
                stats.totalLateMinutes += record.lateMinutes || 0;
                stats.totalEarlyMinutes += record.earlyLeaveMinutes || 0;
                stats.totalEffectiveMinutes += record.effectiveMinutes || 0;
                stats.totalOvertimeMinutes += record.overtimeMinutes || 0;
                
                if (record.isLate) stats.lateDays++;
                if (record.isEarlyLeave) stats.earlyDays++;
                
                stats.records.push(record);
            });
            
            // Convert to array and sort by name
            return Object.values(employeeStats).sort((a, b) => a.name.localeCompare(b.name));
        }

        // Render recap table
        function renderRecapTable(recapData) {
            const tbody = document.getElementById('recapTable');
            const tfoot = document.getElementById('recapFooter');
            
            tbody.innerHTML = '';
            
            if (recapData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-4 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-4">üìä</div>
                            <p>Tidak ada data untuk periode yang dipilih</p>
                            <p class="text-sm">Pilih periode lain atau tambahkan data kehadiran</p>
                        </td>
                    </tr>
                `;
                tfoot.innerHTML = '';
                return;
            }
            
            // Calculate totals for footer
            const totals = recapData.reduce((acc, employee) => {
                acc.totalDays += employee.totalDays;
                acc.totalLateMinutes += employee.totalLateMinutes;
                acc.totalEarlyMinutes += employee.totalEarlyMinutes;
                acc.totalEffectiveMinutes += employee.totalEffectiveMinutes;
                acc.totalOvertimeMinutes += employee.totalOvertimeMinutes;
                acc.lateDays += employee.lateDays;
                acc.earlyDays += employee.earlyDays;
                return acc;
            }, {
                totalDays: 0,
                totalLateMinutes: 0,
                totalEarlyMinutes: 0,
                totalEffectiveMinutes: 0,
                totalOvertimeMinutes: 0,
                lateDays: 0,
                earlyDays: 0
            });
            
            // Render employee rows
            recapData.forEach(employee => {
                const avgHoursPerDay = employee.totalDays > 0 ? 
                    minutesToHours(Math.round(employee.totalEffectiveMinutes / employee.totalDays)) : '0:00';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white">${employee.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center text-blue-600 font-medium">${employee.totalDays}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center ${employee.totalLateMinutes > 0 ? 'text-red-600 font-bold' : 'text-green-600'}">${minutesToHours(employee.totalLateMinutes)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center ${employee.totalEarlyMinutes > 0 ? 'text-orange-600 font-bold' : 'text-green-600'}">${minutesToHours(employee.totalEarlyMinutes)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center text-green-600 font-medium">${minutesToHours(employee.totalEffectiveMinutes)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center text-blue-600 font-medium">${minutesToHours(employee.totalOvertimeMinutes)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center text-indigo-600 font-medium">${avgHoursPerDay}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center ${employee.lateDays > 0 ? 'text-red-600 font-bold' : 'text-green-600'}">${employee.lateDays}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center ${employee.earlyDays > 0 ? 'text-orange-600 font-bold' : 'text-green-600'}">${employee.earlyDays}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center">
                        <button onclick="showEmployeeDetail('${employee.name}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors">
                            Detail
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Render footer totals
            const avgOverallHours = totals.totalDays > 0 ? 
                minutesToHours(Math.round(totals.totalEffectiveMinutes / totals.totalDays)) : '0:00';
            
            tfoot.innerHTML = `
                <tr class="bg-gray-100">
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-gray-900 sticky left-0 bg-gray-100">TOTAL</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-blue-600">${totals.totalDays}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-red-600">${minutesToHours(totals.totalLateMinutes)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-orange-600">${minutesToHours(totals.totalEarlyMinutes)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-green-600">${minutesToHours(totals.totalEffectiveMinutes)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-blue-600">${minutesToHours(totals.totalOvertimeMinutes)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-indigo-600">${avgOverallHours}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-red-600">${totals.lateDays}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-orange-600">${totals.earlyDays}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold text-gray-600">-</td>
                </tr>
            `;
        }

        // Render recap summary cards
        function renderRecapSummary(recapData, filteredData) {
            const summaryContainer = document.getElementById('recapSummary');
            
            if (recapData.length === 0) {
                summaryContainer.innerHTML = '';
                return;
            }
            
            const totals = recapData.reduce((acc, employee) => {
                acc.totalEmployees = recapData.length;
                acc.totalDays += employee.totalDays;
                acc.totalLateMinutes += employee.totalLateMinutes;
                acc.totalEarlyMinutes += employee.totalEarlyMinutes;
                acc.totalEffectiveMinutes += employee.totalEffectiveMinutes;
                acc.totalOvertimeMinutes += employee.totalOvertimeMinutes;
                return acc;
            }, {
                totalEmployees: 0,
                totalDays: 0,
                totalLateMinutes: 0,
                totalEarlyMinutes: 0,
                totalEffectiveMinutes: 0,
                totalOvertimeMinutes: 0
            });
            
            summaryContainer.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-center">
                    <div class="text-blue-600 text-2xl font-bold">${totals.totalEmployees}</div>
                    <div class="text-blue-700 text-sm font-medium">Total Petugas</div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
                    <div class="text-green-600 text-2xl font-bold">${totals.totalDays}</div>
                    <div class="text-green-700 text-sm font-medium">Total Hari Kerja</div>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-center">
                    <div class="text-red-600 text-2xl font-bold">${minutesToHours(totals.totalLateMinutes)}</div>
                    <div class="text-red-700 text-sm font-medium">Total Keterlambatan</div>
                </div>
                <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
                    <div class="text-orange-600 text-2xl font-bold">${minutesToHours(totals.totalOvertimeMinutes)}</div>
                    <div class="text-orange-700 text-sm font-medium">Total Lembur</div>
                </div>
            `;
        }

        // Show employee detail modal
        function showEmployeeDetail(employeeName) {
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            
            // Filter data for this employee
            let employeeData = attendanceData.filter(record => {
                if (record.name !== employeeName) return false;
                
                const recordDate = new Date(record.date);
                const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                const recordYear = recordDate.getFullYear().toString();
                
                if (monthFilter && recordMonth !== monthFilter) return false;
                if (yearFilter && recordYear !== yearFilter) return false;
                
                return true;
            });
            
            // Sort by date (newest first)
            employeeData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Calculate totals
            const totals = employeeData.reduce((acc, record) => {
                acc.totalDays++;
                acc.totalLateMinutes += record.lateMinutes || 0;
                acc.totalEarlyMinutes += record.earlyLeaveMinutes || 0;
                acc.totalEffectiveMinutes += record.effectiveMinutes || 0;
                acc.totalOvertimeMinutes += record.overtimeMinutes || 0;
                return acc;
            }, {
                totalDays: 0,
                totalLateMinutes: 0,
                totalEarlyMinutes: 0,
                totalEffectiveMinutes: 0,
                totalOvertimeMinutes: 0
            });
            
            // Update modal content
            document.getElementById('employeeDetailName').textContent = `Detail: ${employeeName}`;
            
            let periodText = '';
            if (monthFilter && yearFilter) {
                const monthNames = {
                    '01': 'Januari', '02': 'Februari', '03': 'Maret', '04': 'April',
                    '05': 'Mei', '06': 'Juni', '07': 'Juli', '08': 'Agustus',
                    '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Desember'
                };
                periodText = `${monthNames[monthFilter]} ${yearFilter}`;
            } else if (monthFilter) {
                periodText = `Bulan ${monthFilter}`;
            } else if (yearFilter) {
                periodText = `Tahun ${yearFilter}`;
            } else {
                periodText = 'Semua Periode';
            }
            document.getElementById('employeeDetailPeriod').textContent = `Periode: ${periodText}`;
            
            // Update summary cards
            document.getElementById('detailTotalDays').textContent = totals.totalDays;
            document.getElementById('detailTotalLate').textContent = minutesToHours(totals.totalLateMinutes);
            document.getElementById('detailTotalEarly').textContent = minutesToHours(totals.totalEarlyMinutes);
            document.getElementById('detailTotalEffective').textContent = minutesToHours(totals.totalEffectiveMinutes);
            
            // Render detail table
            const detailTable = document.getElementById('employeeDetailTable');
            detailTable.innerHTML = '';
            
            employeeData.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const lateClass = record.isLate ? 'text-red-600 font-bold' : 'text-green-600';
                const earlyClass = record.isEarlyLeave ? 'text-orange-600 font-bold' : 'text-green-600';
                const effectiveClass = record.isUnderHours ? 'text-yellow-600 font-bold' : 'text-green-600';
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${new Date(record.date).toLocaleDateString('id-ID')}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.day || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-indigo-600">${getShiftName(record.shiftType)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.timeIn}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.timeOut}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${lateClass}">${record.late}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${earlyClass}">${record.earlyLeave}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${effectiveClass}">${record.effective}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-blue-600">${record.overtime}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.notes || '-'}</td>
                `;
                detailTable.appendChild(row);
            });
            
            // Show modal
            document.getElementById('employeeDetailModal').classList.remove('hidden');
        }

        // Close employee detail modal
        function closeEmployeeDetailModal() {
            document.getElementById('employeeDetailModal').classList.add('hidden');
        }

        // Generate daily recap
        function generateDailyRecap(filteredData, monthFilter, yearFilter) {
            if (!monthFilter || !yearFilter) {
                document.getElementById('dailyRecapTable').innerHTML = `
                    <tr>
                        <td colspan="100%" class="px-4 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-4">üìÖ</div>
                            <p>Pilih bulan dan tahun untuk melihat rekap harian</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Get all days in the selected month
            const year = parseInt(yearFilter);
            const month = parseInt(monthFilter);
            const daysInMonth = new Date(year, month, 0).getDate();
            const monthName = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                             'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][month];
            
            // Update period display
            document.getElementById('dailyRecapPeriod').textContent = `Rekap harian untuk ${monthName} ${year}`;
            
            // Get unique employees
            const employees = [...new Set(filteredData.map(record => record.name))].sort();
            
            if (employees.length === 0) {
                document.getElementById('dailyRecapTable').innerHTML = `
                    <tr>
                        <td colspan="100%" class="px-4 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-4">üìä</div>
                            <p>Tidak ada data kehadiran untuk ${monthName} ${year}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Generate table headers
            let headerHtml = '<tr><th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Nama</th>';
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayName = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'][date.getDay()];
                headerHtml += `<th class="px-1 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[60px]">
                    <div>${day}</div>
                    <div class="text-xs text-gray-400">${dayName}</div>
                </th>`;
            }
            headerHtml += '<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th></tr>';
            document.getElementById('dailyRecapHead').innerHTML = headerHtml;
            
            // Generate table body
            const tbody = document.getElementById('dailyRecapTable');
            tbody.innerHTML = '';
            
            const dailyTotals = new Array(daysInMonth).fill(0);
            let grandTotal = 0;
            
            employees.forEach(employeeName => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                let rowHtml = `<td class="px-2 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white">${employeeName}</td>`;
                let employeeTotal = 0;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayRecords = filteredData.filter(record => 
                        record.name === employeeName && record.date === dateStr
                    );
                    
                    if (dayRecords.length > 0) {
                        const record = dayRecords[0]; // Take first record if multiple
                        let cellClass = 'bg-green-50 text-green-800';
                        let cellContent = '‚úì';
                        let title = `${record.timeIn} - ${record.timeOut}`;
                        
                        if (record.isLate) {
                            cellClass = 'bg-red-50 text-red-800';
                            cellContent = 'T';
                            title += ` | Terlambat: ${record.late}`;
                        } else if (record.isEarlyLeave) {
                            cellClass = 'bg-orange-50 text-orange-800';
                            cellContent = 'C';
                            title += ` | Cepat pulang: ${record.earlyLeave}`;
                        } else if (record.isUnderHours) {
                            cellClass = 'bg-yellow-50 text-yellow-800';
                            cellContent = 'K';
                            title += ` | Jam kurang: ${record.effective}`;
                        }
                        
                        if (record.overtimeMinutes > 0) {
                            cellContent += '+';
                            title += ` | Lembur: ${record.overtime}`;
                        }
                        
                        rowHtml += `<td class="px-1 py-3 text-center text-xs font-bold ${cellClass}" title="${title}">${cellContent}</td>`;
                        employeeTotal++;
                        dailyTotals[day - 1]++;
                    } else {
                        rowHtml += `<td class="px-1 py-3 text-center text-xs text-gray-300">-</td>`;
                    }
                }
                
                rowHtml += `<td class="px-2 py-3 text-center text-sm font-bold text-blue-600">${employeeTotal}</td>`;
                row.innerHTML = rowHtml;
                tbody.appendChild(row);
                grandTotal += employeeTotal;
            });
            
            // Generate footer with daily totals
            let footerHtml = '<tr class="bg-gray-100"><td class="px-2 py-3 text-sm font-bold text-gray-900 sticky left-0 bg-gray-100">TOTAL</td>';
            for (let day = 0; day < daysInMonth; day++) {
                footerHtml += `<td class="px-1 py-3 text-center text-xs font-bold text-blue-600">${dailyTotals[day]}</td>`;
            }
            footerHtml += `<td class="px-2 py-3 text-center text-sm font-bold text-indigo-600">${grandTotal}</td></tr>`;
            document.getElementById('dailyRecapFooter').innerHTML = footerHtml;
        }
        
        // Generate detailed recap
        function generateDetailedRecap(filteredData) {
            const tbody = document.getElementById('detailedRecapTable');
            tbody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                            <div class="text-4xl mb-4">üìä</div>
                            <p>Tidak ada data untuk periode yang dipilih</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by date (newest first) then by name
            const sortedData = [...filteredData].sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                return a.name.localeCompare(b.name);
            });
            
            sortedData.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const lateClass = record.isLate ? 'text-red-600 font-bold' : 'text-green-600';
                const earlyClass = record.isEarlyLeave ? 'text-orange-600 font-bold' : 'text-green-600';
                const effectiveClass = record.isUnderHours ? 'text-yellow-600 font-bold' : 'text-green-600';
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white">${record.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${new Date(record.date).toLocaleDateString('id-ID')}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.day || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-indigo-600">${getShiftName(record.shiftType)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.workStart || '07:00'} - ${record.workEnd || '17:00'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.timeIn}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.timeOut}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${lateClass}">${record.late}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${earlyClass}">${record.earlyLeave}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${effectiveClass}">${record.effective}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-blue-600">${record.overtime}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.notes || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Generate monthly report
        function generateMonthlyReport() {
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            
            if (!monthFilter || !yearFilter) {
                showNotification('Pilih bulan dan tahun untuk membuat laporan!', 'warning');
                return;
            }
            
            // Filter data for the selected month
            let filteredData = attendanceData.filter(record => {
                const recordDate = new Date(record.date);
                const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                const recordYear = recordDate.getFullYear().toString();
                
                return recordMonth === monthFilter && recordYear === yearFilter;
            });
            
            if (filteredData.length === 0) {
                showNotification('Tidak ada data untuk periode yang dipilih!', 'warning');
                return;
            }
            
            const monthNames = {
                '01': 'Januari', '02': 'Februari', '03': 'Maret', '04': 'April',
                '05': 'Mei', '06': 'Juni', '07': 'Juli', '08': 'Agustus',
                '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Desember'
            };
            
            const recapData = generateEmployeeRecap(filteredData);
            
            // Create comprehensive CSV report
            const headers = [
                'LAPORAN KEHADIRAN BULANAN',
                `Periode: ${monthNames[monthFilter]} ${yearFilter}`,
                `Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`,
                '',
                'RINGKASAN KEHADIRAN PER PETUGAS',
                'Nama Petugas,Total Hari Kerja,Total Keterlambatan,Total Pulang Cepat,Total Jam Efektif,Total Lembur,Rata-rata Jam/Hari,Hari Terlambat,Hari Pulang Cepat'
            ];
            
            const summaryData = recapData.map(employee => {
                const avgHoursPerDay = employee.totalDays > 0 ? 
                    minutesToHours(Math.round(employee.totalEffectiveMinutes / employee.totalDays)) : '0:00';
                
                return [
                    `"${employee.name}"`,
                    employee.totalDays,
                    `"${minutesToHours(employee.totalLateMinutes)}"`,
                    `"${minutesToHours(employee.totalEarlyMinutes)}"`,
                    `"${minutesToHours(employee.totalEffectiveMinutes)}"`,
                    `"${minutesToHours(employee.totalOvertimeMinutes)}"`,
                    `"${avgHoursPerDay}"`,
                    employee.lateDays,
                    employee.earlyDays
                ].join(',');
            });
            
            const detailHeaders = [
                '',
                'DETAIL KEHADIRAN HARIAN',
                'Nama,Tanggal,Hari,Shift,Jam Kerja,Jam Masuk,Jam Keluar,Telat,Cepat Pulang,Jam Efektif,Lembur,Catatan'
            ];
            
            const detailData = filteredData
                .sort((a, b) => new Date(a.date) - new Date(b.date) || a.name.localeCompare(b.name))
                .map(record => [
                    `"${record.name}"`,
                    `"${new Date(record.date).toLocaleDateString('id-ID')}"`,
                    `"${record.day || '-'}"`,
                    `"${getShiftName(record.shiftType)}"`,
                    `"${record.workStart || '07:00'} - ${record.workEnd || '17:00'}"`,
                    `"${record.timeIn}"`,
                    `"${record.timeOut}"`,
                    `"${record.late}"`,
                    `"${record.earlyLeave}"`,
                    `"${record.effective}"`,
                    `"${record.overtime}"`,
                    `"${record.notes || '-'}"`
                ].join(','));
            
            const csvContent = [
                ...headers,
                ...summaryData,
                ...detailHeaders,
                ...detailData
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `laporan-kehadiran-${yearFilter}-${monthFilter}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Laporan ${monthNames[monthFilter]} ${yearFilter} berhasil dibuat!`, 'success');
        }

        // Clear data functions
        function showClearDataModal() {
            document.getElementById('clearDataModal').classList.remove('hidden');
            document.getElementById('confirmDelete').checked = false;
            document.getElementById('confirmDeleteBtn').disabled = true;
        }

        function closeClearDataModal() {
            document.getElementById('clearDataModal').classList.add('hidden');
            document.getElementById('confirmDelete').checked = false;
            document.getElementById('confirmDeleteBtn').disabled = true;
        }

        // Enable/disable delete button based on checkbox
        document.addEventListener('DOMContentLoaded', function() {
            const confirmCheckbox = document.getElementById('confirmDelete');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            if (confirmCheckbox && confirmBtn) {
                confirmCheckbox.addEventListener('change', function() {
                    confirmBtn.disabled = !this.checked;
                });
            }
        });

        // Clear all data from Firebase and localStorage
        async function clearAllData() {
            const confirmCheckbox = document.getElementById('confirmDelete');
            if (!confirmCheckbox.checked) {
                showNotification('Centang kotak konfirmasi terlebih dahulu!', 'warning');
                return;
            }

            try {
                showNotification('Menghapus semua data...', 'info');
                
                // Clear Firebase data
                if (isFirebaseConnected && window.firebaseDatabase) {
                    const attendanceRef = window.firebaseRef(window.firebaseDatabase, 'attendanceData');
                    const sessionsRef = window.firebaseRef(window.firebaseDatabase, 'activeSessions');
                    const employeesRef = window.firebaseRef(window.firebaseDatabase, 'employeeList');
                    const selectedRef = window.firebaseRef(window.firebaseDatabase, 'selectedEmployee');
                    
                    await window.firebaseSet(attendanceRef, null);
                    await window.firebaseSet(sessionsRef, null);
                    await window.firebaseSet(employeesRef, null);
                    await window.firebaseSet(selectedRef, null);
                    
                    console.log('‚úÖ Firebase data cleared successfully');
                }
                
                // Clear localStorage
                localStorage.removeItem('attendanceData');
                localStorage.removeItem('activeSessions');
                localStorage.removeItem('employeeList');
                localStorage.removeItem('selectedEmployee');
                
                // Reset global variables
                attendanceData = [];
                activeSessions = [];
                employeeList = [
                    'Achmad Rosidi', 'Ade Kurniawan', 'Al Azahar', 'Alwi', 'Arif Abdul Rahman',
                    'Asep', 'Chandra Darmawan', 'Daday Sukandar', 'Dea Sabilah Handriyani', 'Deni Arcis',
                    'Dewo Panca Pamungkas', 'Dimas Herwinto Pradana', 'Eris Sumiadi', 'Fida Marzuki Putra', 'Herdinsah',
                    'Hermansyah', 'Hikmatun Nisa', 'Ihsan Muttaqien', 'Ilham Prayitno Yudo', 'Indra Jaya',
                    'Irfan Mahadi', 'M. Yusuf', 'Maryanto', 'Mohamad Irwan Yulianto', 'Muhammad Khomeini',
                    'Nur Iman', 'Nuryana', 'Puji Lestari', 'Pujiyanto', 'Rafly Nugraha',
                    'Rahman', 'Rahmat Agustio', 'Reynaldi Saputra', 'Rizky Prasetia', 'Rohmah',
                    'Sabar Minggudi', 'Siti Marsah', 'Suhanda', 'Supardi', 'Suwandi',
                    'Syaiful Huda', 'Tri Julianto', 'Wiyono Fauzy'
                ];
                selectedEmployee = null;
                
                // Update UI
                renderTable();
                renderDashboard();
                updateSummary();
                renderActiveSessions();
                renderEmployeeButtons();
                clearSelection();
                
                // Close modal
                closeClearDataModal();
                
                showNotification('‚úÖ Semua data berhasil dihapus!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error clearing data:', error);
                showNotification('‚ùå Gagal menghapus data: ' + error.message, 'error');
            }
        }

        // Export recap to CSV
        function exportRecapToCSV() {
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const employeeFilter = document.getElementById('employeeFilter').value;
            const viewType = document.getElementById('viewTypeFilter').value;
            
            // Filter data
            let filteredData = attendanceData.filter(record => {
                const recordDate = new Date(record.date);
                const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
                const recordYear = recordDate.getFullYear().toString();
                
                if (monthFilter && recordMonth !== monthFilter) return false;
                if (yearFilter && recordYear !== yearFilter) return false;
                if (employeeFilter && record.name !== employeeFilter) return false;
                
                return true;
            });
            
            if (filteredData.length === 0) {
                showNotification('Tidak ada data untuk diekspor!', 'warning');
                return;
            }
            
            let csvContent = '';
            let filename = 'rekap-kehadiran';
            
            if (viewType === 'detailed') {
                // Export detailed view
                const headers = [
                    'Nama', 'Tanggal', 'Hari', 'Shift', 'Jam Kerja', 'Jam Masuk', 'Jam Keluar', 
                    'Telat', 'Cepat Pulang', 'Jam Efektif', 'Lembur', 'Catatan'
                ];
                
                csvContent = [
                    headers.join(','),
                    ...filteredData
                        .sort((a, b) => new Date(b.date) - new Date(a.date) || a.name.localeCompare(b.name))
                        .map(record => [
                            `"${record.name}"`,
                            `"${new Date(record.date).toLocaleDateString('id-ID')}"`,
                            `"${record.day || '-'}"`,
                            `"${getShiftName(record.shiftType)}"`,
                            `"${record.workStart || '07:00'} - ${record.workEnd || '17:00'}"`,
                            `"${record.timeIn}"`,
                            `"${record.timeOut}"`,
                            `"${record.late}"`,
                            `"${record.earlyLeave}"`,
                            `"${record.effective}"`,
                            `"${record.overtime}"`,
                            `"${record.notes || '-'}"`
                        ].join(','))
                ].join('\n');
                filename += '-detail';
            } else {
                // Export summary view
                const recapData = generateEmployeeRecap(filteredData);
                
                const headers = [
                    'Nama Petugas', 'Total Hari Kerja', 'Total Keterlambatan', 'Total Pulang Cepat', 
                    'Total Jam Efektif', 'Total Lembur', 'Rata-rata Jam/Hari', 'Hari Terlambat', 'Hari Pulang Cepat'
                ];
                
                csvContent = [
                    headers.join(','),
                    ...recapData.map(employee => {
                        const avgHoursPerDay = employee.totalDays > 0 ? 
                            minutesToHours(Math.round(employee.totalEffectiveMinutes / employee.totalDays)) : '0:00';
                        
                        return [
                            `"${employee.name}"`,
                            employee.totalDays,
                            `"${minutesToHours(employee.totalLateMinutes)}"`,
                            `"${minutesToHours(employee.totalEarlyMinutes)}"`,
                            `"${minutesToHours(employee.totalEffectiveMinutes)}"`,
                            `"${minutesToHours(employee.totalOvertimeMinutes)}"`,
                            `"${avgHoursPerDay}"`,
                            employee.lateDays,
                            employee.earlyDays
                        ].join(',');
                    })
                ].join('\n');
            }
            
            if (monthFilter && yearFilter) {
                filename += `-${yearFilter}-${monthFilter}`;
            } else if (yearFilter) {
                filename += `-${yearFilter}`;
            } else if (monthFilter) {
                filename += `-bulan-${monthFilter}`;
            }
            filename += '.csv';
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Rekap berhasil diekspor ke Excel!', 'success');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'973a142ed51f9c21',t:'MTc1NTk0NjUzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
