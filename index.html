<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi PPSU Pisangan Baru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration - GANTI DENGAN CONFIG ANDA
        const firebaseConfig = {
            apiKey: "your-api-key-here",
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase functions globally available
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where, onSnapshot };
    </script>
    <style>
        :root {
            --primary-purple: #6366f1;
            --dark-purple: #4338ca;
            --light-purple: #8b5cf6;
            --purple-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --dark-gradient: linear-gradient(135deg, #2d1b69 0%, #11047a 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        
        body {
            background: var(--dark-gradient);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: var(--purple-gradient);
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 102, 241, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 102, 241, 0.4);
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        .camera-preview {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px dashed var(--primary-purple);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .camera-preview:hover {
            border-color: var(--dark-purple);
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            transform: scale(1.02);
        }
        .captured-photo {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
        }
        .photo-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--primary-purple);
        }
        .photo-thumbnail:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 102, 241, 0.3);
        }
        
        .modern-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 102, 241, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .modern-input:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(102, 102, 241, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            .mobile-card {
                display: block;
            }
            .desktop-table {
                display: none;
            }
        }
        @media (min-width: 769px) {
            .mobile-card {
                display: none;
            }
            .desktop-table {
                display: table;
            }
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-hadir { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .status-terlambat { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: white; 
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        .status-lembur { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .status-belum-pulang { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white; 
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 102, 241, 0.3);
            border-top: 3px solid var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .attendance-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
        }
        .attendance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .attendance-card.hadir {
            border-left-color: #10b981;
            background: linear-gradient(135deg, rgba(236, 253, 245, 0.9), rgba(255, 255, 255, 0.95));
        }
        .attendance-card.terlambat {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, rgba(255, 251, 235, 0.9), rgba(255, 255, 255, 0.95));
        }
        .attendance-card.belum-pulang {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, rgba(254, 242, 242, 0.9), rgba(255, 255, 255, 0.95));
        }
        
        .sync-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 40;
            transition: all 0.3s ease;
        }
        
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--dark-gradient);
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }
        
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        
        .shape {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }
        
        .shape:nth-child(1) {
            width: 80px;
            height: 80px;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }
        
        .shape:nth-child(2) {
            width: 120px;
            height: 120px;
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }
        
        .shape:nth-child(3) {
            width: 60px;
            height: 60px;
            bottom: 20%;
            left: 20%;
            animation-delay: 4s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .modern-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
        }
        
        .modern-table th {
            background: var(--purple-gradient);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .modern-table tr:hover {
            background: rgba(102, 102, 241, 0.05);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Floating Background Shapes -->
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>


    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold gradient-text mb-2">Admin Login</h1>
                <p class="text-gray-600">Masuk ke panel admin PPSU Pisangan Baru</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <div class="relative">
                        <input type="text" id="loginUsername" class="modern-input w-full px-4 py-3 pl-12 focus:outline-none" placeholder="Masukkan username" required>
                        <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2 text-purple-500"></i>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="loginPassword" class="modern-input w-full px-4 py-3 pl-12 pr-12 focus:outline-none" placeholder="Masukkan password" required>
                        <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-purple-500"></i>
                        <button type="button" onclick="togglePassword()" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-purple-500">
                            <i id="passwordToggleIcon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="btn-primary w-full py-3 px-6 rounded-xl text-white font-semibold text-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>Masuk Admin
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <button onclick="showPage('home')" class="text-purple-600 hover:text-purple-800 font-medium">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali ke Home
                </button>
            </div>
        </div>
    </div>

    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator hidden">
        <div class="glass-card rounded-lg shadow-lg px-3 py-2 flex items-center">
            <div id="syncIcon" class="mr-2"></div>
            <span id="syncText" class="text-sm font-medium"></span>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="glass-nav sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-3">
                        <i class="fas fa-clipboard-check text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Absensi PPSU Pisangan Baru</h1>
                        <p class="text-xs text-purple-200">Real-time Attendance System</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="glass-card px-3 py-2 rounded-lg mr-4 hidden sm:block">
                        <div class="text-center">
                            <div id="currentTime" class="text-lg font-bold gradient-text"></div>
                            <div id="currentDate" class="text-xs text-purple-300"></div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div id="syncStatus" class="text-xs text-purple-200 hidden sm:block">
                        <i class="fas fa-sync-alt text-green-400"></i> Tersinkron
                    </div>
                    <button onclick="showPage('home')" class="nav-btn px-3 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition-all text-sm sm:text-base">
                        <i class="fas fa-home mr-1 sm:mr-2"></i><span class="hidden sm:inline">Home</span>
                    </button>
                    <button onclick="showAdminPage()" class="nav-btn px-3 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition-all text-sm sm:text-base">
                        <i class="fas fa-user-shield mr-1 sm:mr-2"></i><span class="hidden sm:inline">Admin</span>
                    </button>
                    <button id="logoutBtn" onclick="logout()" class="nav-btn px-3 py-2 rounded-lg text-red-300 hover:bg-red-500 hover:bg-opacity-20 transition-all text-sm sm:text-base hidden">
                        <i class="fas fa-sign-out-alt mr-1 sm:mr-2"></i><span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="homePage" class="page">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Mobile Time Display -->
            <div class="glass-card rounded-xl p-4 mb-6 sm:hidden">
                <div class="text-center">
                    <div id="currentTimeMobile" class="text-2xl font-bold gradient-text"></div>
                    <div id="currentDateMobile" class="text-sm text-purple-600"></div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="stats-card p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 shadow-lg">
                            <i class="fas fa-user-check text-white text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-semibold text-gray-600">Hadir Hari Ini</p>
                            <p id="hadirHariIni" class="text-3xl font-bold gradient-text">0</p>
                        </div>
                    </div>
                </div>
                <div class="stats-card p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-gradient-to-r from-yellow-500 to-orange-600 shadow-lg">
                            <i class="fas fa-clock text-white text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-semibold text-gray-600">Terlambat</p>
                            <p id="terlambatHariIni" class="text-3xl font-bold gradient-text">0</p>
                        </div>
                    </div>
                </div>
                <div class="stats-card p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-gradient-to-r from-red-500 to-pink-600 shadow-lg">
                            <i class="fas fa-user-clock text-white text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-semibold text-gray-600">Belum Pulang</p>
                            <p id="belumPulangHariIni" class="text-3xl font-bold gradient-text">0</p>
                        </div>
                    </div>
                </div>
                <div class="stats-card p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-gradient-to-r from-purple-500 to-indigo-600 shadow-lg">
                            <i class="fas fa-users text-white text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-semibold text-gray-600">Total Petugas</p>
                            <p class="text-3xl font-bold gradient-text">43</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Form Absensi -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-2xl font-bold gradient-text mb-6 flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-3">
                            <i class="fas fa-user-clock text-white"></i>
                        </div>
                        Form Absensi
                    </h2>
                    
                    <form id="absensiForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Petugas *</label>
                            <select id="namaPetugas" class="modern-input w-full px-4 py-3 focus:outline-none" required>
                                <option value="">Pilih Nama Petugas</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Shift *</label>
                            <select id="shift" class="modern-input w-full px-4 py-3 focus:outline-none" required>
                                <option value="">Pilih Shift</option>
                                <option value="Shift 1">Shift 1 (05:00 - 13:00)</option>
                                <option value="Shift 2">Shift 2 (07:20 - 15:20)</option>
                                <option value="Shift Piket">Shift Piket (18:00 - 06:00)</option>
                                <option value="Shift Piket Pagi">Shift Piket Pagi (07:00 - 12:00)</option>
                                <option value="Shift Piket Siang">Shift Piket Siang (12:00 - 17:00)</option>
                                <option value="Shift Kantor">Shift Kantor (07:00 - 17:00)</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Jam Masuk *</label>
                                <div class="relative">
                                    <input type="time" id="jamMasuk" class="modern-input w-full px-4 py-3 pr-12 focus:outline-none" required>
                                    <button type="button" onclick="setCurrentTime('jamMasuk')" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-3 py-1 rounded-lg text-xs hover:shadow-lg transition-all" title="Isi waktu sekarang">
                                        <i class="fas fa-clock"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Jam Pulang</label>
                                <div class="relative">
                                    <input type="time" id="jamPulang" class="modern-input w-full px-4 py-3 pr-12 focus:outline-none">
                                    <button type="button" onclick="setCurrentTime('jamPulang')" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-3 py-1 rounded-lg text-xs hover:shadow-lg transition-all" title="Isi waktu sekarang">
                                        <i class="fas fa-clock"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Foto Absen Masuk</label>
                                <div class="camera-container">
                                    <div id="fotoMasukPreview" class="camera-preview" onclick="startCamera('masuk')">
                                        <div class="text-center">
                                            <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                                            <p class="text-gray-500 text-sm">Klik untuk kamera live</p>
                                        </div>
                                    </div>
                                    <video id="videoMasuk" class="hidden w-full h-48 object-cover rounded-lg"></video>
                                    <canvas id="canvasMasuk" class="hidden"></canvas>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Foto Absen Pulang</label>
                                <div class="camera-container">
                                    <div id="fotoPulangPreview" class="camera-preview" onclick="startCamera('pulang')">
                                        <div class="text-center">
                                            <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                                            <p class="text-gray-500 text-sm">Klik untuk kamera live</p>
                                        </div>
                                    </div>
                                    <video id="videoPulang" class="hidden w-full h-48 object-cover rounded-lg"></video>
                                    <canvas id="canvasPulang" class="hidden"></canvas>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Catatan</label>
                            <textarea id="catatan" rows="3" class="modern-input w-full px-4 py-3 focus:outline-none" placeholder="Catatan tambahan (opsional)"></textarea>
                        </div>

                        <button type="submit" class="btn-primary w-full py-3 px-6 rounded-xl text-white font-semibold text-lg flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i>Simpan Absensi
                        </button>
                    </form>
                </div>

                <!-- Data Absensi Hari Ini -->
                <div class="glass-card rounded-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold gradient-text flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 flex items-center justify-center mr-3">
                                <i class="fas fa-list text-white"></i>
                            </div>
                            Absensi Hari Ini
                        </h2>
                        <button onclick="refreshData()" class="p-2 rounded-lg bg-gradient-to-r from-purple-500 to-blue-600 text-white hover:shadow-lg transition-all">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div id="absensiHariIni" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Data akan dimuat di sini -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="page hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="glass-card rounded-xl p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold gradient-text flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 flex items-center justify-center mr-3">
                            <i class="fas fa-chart-bar text-white"></i>
                        </div>
                        Rekap Absensi
                    </h2>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="exportToExcel()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-xl hover:shadow-lg transition-all text-sm font-semibold">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button onclick="exportToCSV()" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-xl hover:shadow-lg transition-all text-sm font-semibold">
                            <i class="fas fa-file-csv mr-2"></i>Export CSV
                        </button>
                        <button onclick="clearAllData()" class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-4 py-2 rounded-xl hover:shadow-lg transition-all text-sm font-semibold">
                            <i class="fas fa-trash mr-2"></i>Hapus Semua
                        </button>

                    </div>
                </div>

                <!-- Filter -->
                <div class="mb-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                        <select id="filterTipeRekap" class="modern-input px-4 py-2 focus:outline-none" onchange="toggleFilterType()">
                            <option value="harian">Rekap Harian</option>
                            <option value="bulanan">Rekap Bulanan</option>
                        </select>
                        <input type="date" id="filterTanggalMulai" class="modern-input px-4 py-2 focus:outline-none" placeholder="Tanggal Mulai">
                        <input type="date" id="filterTanggalAkhir" class="modern-input px-4 py-2 focus:outline-none" placeholder="Tanggal Akhir">
                        <select id="filterNama" class="modern-input px-4 py-2 focus:outline-none">
                            <option value="">Semua Petugas</option>
                        </select>
                        <button onclick="applyFilter()" class="btn-primary px-4 py-2 rounded-xl text-white font-semibold">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                    </div>
                    
                    <!-- Monthly Filter Options -->
                    <div id="monthlyFilterOptions" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <select id="filterBulan" class="modern-input px-4 py-2 focus:outline-none">
                            <option value="">Pilih Bulan</option>
                            <option value="01">Januari</option>
                            <option value="02">Februari</option>
                            <option value="03">Maret</option>
                            <option value="04">April</option>
                            <option value="05">Mei</option>
                            <option value="06">Juni</option>
                            <option value="07">Juli</option>
                            <option value="08">Agustus</option>
                            <option value="09">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                        <select id="filterTahun" class="modern-input px-4 py-2 focus:outline-none">
                            <option value="">Pilih Tahun</option>
                        </select>
                        <select id="filterNamaBulanan" class="modern-input px-4 py-2 focus:outline-none">
                            <option value="">Pilih Petugas</option>
                        </select>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div id="summaryStats" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- Stats akan dimuat di sini -->
                </div>

                <!-- Monthly Summary Table -->
                <div id="monthlySummaryTable" class="hidden mb-6 bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Ringkasan Bulanan</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 bg-white">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-sm font-medium text-gray-700">Nama Petugas</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-sm font-medium text-gray-700">Shift</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-sm font-medium text-gray-700">Total Hari Kerja</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-sm font-medium text-gray-700">Total Jam Kerja/Bulan</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-sm font-medium text-gray-700">Keterlambatan</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-sm font-medium text-gray-700">Lembur</th>
                                </tr>
                            </thead>
                            <tbody id="monthlySummaryBody">
                                <!-- Data akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabel Desktop -->
                <div class="table-container">
                    <table class="modern-table desktop-table w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Nama</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Shift</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Jam Masuk</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Jam Pulang</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Foto</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Keterlambatan</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Lembur</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider" id="totalJamHeader">Total Jam/Hari</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="rekapTableBody">
                            <!-- Data akan dimuat di sini -->
                        </tbody>
                    </table>
                </div>

                <!-- Cards Mobile -->
                <div id="rekapMobileCards" class="mobile-card space-y-4">
                    <!-- Data akan dimuat di sini -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-card rounded-xl max-w-md w-full p-6 max-h-screen overflow-y-auto">
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mr-3">
                    <i class="fas fa-edit text-white"></i>
                </div>
                <h3 class="text-xl font-bold gradient-text">Edit Absensi</h3>
            </div>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editId">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Jam Masuk</label>
                    <input type="time" id="editJamMasuk" class="modern-input w-full px-4 py-3 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Jam Pulang</label>
                    <input type="time" id="editJamPulang" class="modern-input w-full px-4 py-3 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Catatan</label>
                    <textarea id="editCatatan" rows="3" class="modern-input w-full px-4 py-3 focus:outline-none" placeholder="Catatan tambahan..."></textarea>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="btn-primary flex-1 py-3 px-4 rounded-xl text-white font-semibold">
                        <i class="fas fa-save mr-2"></i>Simpan Perubahan
                    </button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-4 rounded-xl hover:shadow-lg transition-all font-semibold">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="photo-modal hidden" onclick="closePhotoModal()">
        <img id="photoModalImage" src="" alt="Foto Absensi">
        <button onclick="closePhotoModal()" class="absolute top-4 right-4 bg-white text-gray-800 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-100">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass-card rounded-xl p-8 flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
            <span class="text-lg font-semibold gradient-text">Memproses data...</span>
            <p class="text-sm text-gray-600 mt-2">Mohon tunggu sebentar</p>
        </div>
    </div>

    <script>
        // Data petugas PPSU Pisangan Baru
        const petugasList = [
            'Achmad Rosidi', 'Ade Kurniawan', 'Al Azahar', 'Alwi', 'Arif Abdul Rahman',
            'Asep', 'Chandra Darmawan', 'Daday Sukandar', 'Dea Sabilah Handriyani', 'Deni Arcis',
            'Dewo Panca Pamungkas', 'Dimas Herwinto Pradana', 'Eris Sumiadi', 'Fida Marzuki Putra', 'Herdinsah',
            'Hermansyah', 'Hikmatun Nisa', 'Ihsan Muttaqien', 'Ilham Prayitno Yudo', 'Indra Jaya',
            'Irfan Mahadi', 'M. Yusuf', 'Maryanto', 'Mohamad Irwan Yulianto', 'Muhammad Khomeini',
            'Nur Iman', 'Nuryana', 'Puji Lestari', 'Pujiyanto', 'Rafly Nugraha',
            'Rahman', 'Rahmat Agustio', 'Reynaldi Saputra', 'Rizky Prasetia', 'Rohmah',
            'Sabar Minggudi', 'Siti Marsah', 'Suhanda', 'Supardi', 'Suwandi',
            'Syaiful Huda', 'Tri Julianto', 'Wiyono Fauzy'
        ];

        // Jadwal shift
        const shiftSchedule = {
            'Shift 1': { start: '05:00', end: '13:00', name: 'Shift 1 (05:00 - 13:00)' },
            'Shift 2': { start: '07:20', end: '15:20', name: 'Shift 2 (07:20 - 15:20)' },
            'Shift Piket': { start: '18:00', end: '06:00', name: 'Shift Piket (18:00 - 06:00)' },
            'Shift Piket Pagi': { start: '07:00', end: '12:00', name: 'Shift Piket Pagi (07:00 - 12:00)' },
            'Shift Piket Siang': { start: '12:00', end: '17:00', name: 'Shift Piket Siang (12:00 - 17:00)' },
            'Shift Kantor': { start: '07:00', end: '17:00', name: 'Shift Kantor (07:00 - 17:00)' }
        };

        // Inisialisasi data
        let absensiData = [];
        let currentEditId = null;
        let isLoading = false;
        let syncInterval = null;
        let firebaseReady = false;

        // Firebase Functions
        async function initializeFirebase() {
            try {
                // Wait for Firebase to be ready
                await new Promise(resolve => {
                    const checkFirebase = () => {
                        if (window.db && window.firestore) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
                
                firebaseReady = true;
                showSyncIndicator('success', 'Firebase terhubung!');
                
                // Load data from Firebase
                await loadDataFromFirebase();
                
                // Setup real-time listener
                setupRealtimeListener();
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showSyncIndicator('error', 'Firebase gagal terhubung - menggunakan mode offline');
                
                // Fallback to localStorage
                absensiData = JSON.parse(localStorage.getItem('absensiPPSUData')) || [];
                firebaseReady = false;
            }
        }

        // Load data from Firebase
        async function loadDataFromFirebase() {
            if (!firebaseReady) return;
            
            try {
                showSyncIndicator('syncing', 'Memuat data dari Firebase...');
                
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'absensi'),
                    window.firestore.orderBy('timestamp', 'desc')
                );
                
                const querySnapshot = await window.firestore.getDocs(q);
                absensiData = [];
                
                querySnapshot.forEach((doc) => {
                    absensiData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Update UI
                loadAbsensiHariIni();
                loadRekapData();
                updateStats();
                updateSummaryStats();
                
                showSyncIndicator('success', `${absensiData.length} data dimuat dari Firebase`);
                
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                showSyncIndicator('error', 'Gagal memuat dari Firebase');
                
                // Fallback to localStorage
                absensiData = JSON.parse(localStorage.getItem('absensiPPSUData')) || [];
            }
        }

        // Save data to Firebase
        async function saveToFirebase(data) {
            if (!firebaseReady) {
                // Fallback to localStorage
                localStorage.setItem('absensiPPSUData', JSON.stringify(absensiData));
                return;
            }
            
            try {
                showSyncIndicator('syncing', 'Menyimpan ke Firebase...');
                
                const docRef = await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'absensi'),
                    data
                );
                
                // Update local data with Firebase ID
                const index = absensiData.findIndex(item => item.id === data.id);
                if (index !== -1) {
                    absensiData[index].id = docRef.id;
                }
                
                showSyncIndicator('success', 'Data tersimpan ke Firebase!');
                
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                showSyncIndicator('error', 'Gagal menyimpan ke Firebase');
                
                // Fallback to localStorage
                localStorage.setItem('absensiPPSUData', JSON.stringify(absensiData));
            }
        }

        // Update data in Firebase
        async function updateInFirebase(id, data) {
            if (!firebaseReady) {
                // Fallback to localStorage
                localStorage.setItem('absensiPPSUData', JSON.stringify(absensiData));
                return;
            }
            
            try {
                showSyncIndicator('syncing', 'Mengupdate di Firebase...');
                
                const docRef = window.firestore.doc(window.db, 'absensi', id);
                await window.firestore.updateDoc(docRef, data);
                
                showSyncIndicator('success', 'Data terupdate di Firebase!');
                
            } catch (error) {
                console.error('Error updating in Firebase:', error);
                showSyncIndicator('error', 'Gagal update di Firebase');
                
                // Fallback to localStorage
                localStorage.setItem('absensiPPSUData', JSON.stringify(absensiData));
            }
        }

        // Delete data from Firebase
        async function deleteFromFirebase(id) {
            if (!firebaseReady) {
                // Fallback to localStorage
                localStorage.setItem('absensiPPSUData', JSON.stringify(absensiData));
                return;
            }
            
            try {
                showSyncIndicator('syncing', 'Menghapus dari Firebase...');
                
                const docRef = window.firestore.doc(window.db, 'absensi', id);
                await window.firestore.deleteDoc(docRef);
                
                showSyncIndicator('success', 'Data terhapus dari Firebase!');
                
            } catch (error) {
                console.error('Error deleting from Firebase:', error);
                showSyncIndicator('error', 'Gagal hapus dari Firebase');
                
                // Fallback to localStorage
                localStorage.setItem('absensiPPSUData', JSON.stringify(absensiData));
            }
        }

        // Setup real-time listener
        function setupRealtimeListener() {
            if (!firebaseReady) return;
            
            try {
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'absensi'),
                    window.firestore.orderBy('timestamp', 'desc')
                );
                
                window.firestore.onSnapshot(q, (querySnapshot) => {
                    const newData = [];
                    querySnapshot.forEach((doc) => {
                        newData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Only update if data actually changed
                    if (JSON.stringify(newData) !== JSON.stringify(absensiData)) {
                        absensiData = newData;
                        
                        // Update UI
                        loadAbsensiHariIni();
                        loadRekapData();
                        updateStats();
                        updateSummaryStats();
                        
                        showSyncIndicator('success', 'Data tersinkron real-time');
                    }
                });
                
            } catch (error) {
                console.error('Error setting up real-time listener:', error);
            }
        }

        // Clear all data from Firebase
        async function clearAllFirebaseData() {
            if (!firebaseReady) {
                localStorage.removeItem('absensiPPSUData');
                return;
            }
            
            try {
                showSyncIndicator('syncing', 'Menghapus semua data dari Firebase...');
                
                const q = window.firestore.query(window.firestore.collection(window.db, 'absensi'));
                const querySnapshot = await window.firestore.getDocs(q);
                
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(window.firestore.deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                
                showSyncIndicator('success', 'Semua data terhapus dari Firebase!');
                
            } catch (error) {
                console.error('Error clearing Firebase data:', error);
                showSyncIndicator('error', 'Gagal hapus data dari Firebase');
            }
        }

        // Inisialisasi aplikasi
        document.addEventListener('DOMContentLoaded', async function() {
            // Check login status first
            checkLoginStatus();
            
            initializePetugasOptions();
            initializeYearOptions();
            updateRealTimeClock();
            
            // Set tanggal hari ini untuk filter
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterTanggalMulai').value = today;
            document.getElementById('filterTanggalAkhir').value = today;
            
            // Update jam real-time setiap detik
            setInterval(updateRealTimeClock, 1000);
            
            // Initialize Firebase
            await initializeFirebase();
            
            // Sync saat window focus
            window.addEventListener('focus', loadDataFromFirebase);
            
            // Sync saat online
            window.addEventListener('online', loadDataFromFirebase);
        });

        // Start auto sync
        function startAutoSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(syncData, 10000); // Sync setiap 10 detik
        }

        // Show sync indicator
        function showSyncIndicator(type, message) {
            const indicator = document.getElementById('syncIndicator');
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncText');
            
            indicator.classList.remove('hidden');
            
            switch(type) {
                case 'syncing':
                    icon.innerHTML = '<i class="fas fa-sync-alt fa-spin text-blue-500"></i>';
                    text.textContent = message || 'Sinkronisasi...';
                    break;
                case 'success':
                    icon.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                    text.textContent = message || 'Tersinkron';
                    break;
                case 'error':
                    icon.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
                    text.textContent = message || 'Gagal sinkron';
                    break;
            }
            
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 3000);
        }

        // Update jam real-time
        function updateRealTimeClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const dateString = now.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Update desktop
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');
            if (timeElement) timeElement.textContent = timeString;
            if (dateElement) dateElement.textContent = dateString;
            
            // Update mobile
            const timeMobileElement = document.getElementById('currentTimeMobile');
            const dateMobileElement = document.getElementById('currentDateMobile');
            if (timeMobileElement) timeMobileElement.textContent = timeString;
            if (dateMobileElement) dateMobileElement.textContent = dateString;
        }

        // Set waktu saat ini ke input
        function setCurrentTime(inputId) {
            const now = new Date();
            const timeString = now.toTimeString().slice(0, 5);
            document.getElementById(inputId).value = timeString;
        }

        // Inisialisasi opsi tahun
        function initializeYearOptions() {
            const yearSelect = document.getElementById('filterTahun');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = new Option(year, year);
                yearSelect.add(option);
            }
            yearSelect.value = currentYear;
        }

        // Inisialisasi dropdown petugas
        function initializePetugasOptions() {
            const namaPetugasSelect = document.getElementById('namaPetugas');
            const filterNamaSelect = document.getElementById('filterNama');
            const filterNamaBulananSelect = document.getElementById('filterNamaBulanan');
            
            petugasList.forEach(nama => {
                const option1 = new Option(nama, nama);
                const option2 = new Option(nama, nama);
                const option3 = new Option(nama, nama);
                namaPetugasSelect.add(option1);
                filterNamaSelect.add(option2);
                filterNamaBulananSelect.add(option3);
            });
        }

        // Variabel untuk kamera
        let currentStream = null;
        let currentCameraType = null;

        // Login credentials
        const ADMIN_CREDENTIALS = {
            username: 'elfida',
            password: 'Pis212baru'
        };

        // Check login status on page load
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            const loginPage = document.getElementById('loginPage');
            const homePage = document.getElementById('homePage');
            const adminPage = document.getElementById('adminPage');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (isLoggedIn) {
                loginPage.classList.add('hidden');
                homePage.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                loginPage.classList.remove('hidden');
                homePage.classList.add('hidden');
                adminPage.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        // Show admin page with login check
        function showAdminPage() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            
            if (!isLoggedIn) {
                showPage('login');
                return;
            }
            
            showPage('admin');
        }

        // Show page with login protection
        function showPage(page) {
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            
            // Protect admin page
            if (page === 'admin' && !isLoggedIn) {
                showPage('login');
                return;
            }
            
            // Hide all pages
            document.querySelectorAll('.page, #loginPage').forEach(p => p.classList.add('hidden'));
            
            // Show requested page
            if (page === 'login') {
                document.getElementById('loginPage').classList.remove('hidden');
            } else {
                document.getElementById(page + 'Page').classList.remove('hidden');
            }
            
            // Update data based on page
            if (page === 'admin') {
                loadRekapData();
                updateSummaryStats();
            } else if (page === 'home') {
                loadAbsensiHariIni();
                updateStats();
            }
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memverifikasi...';
            submitBtn.disabled = true;
            
            // Simulate authentication delay
            setTimeout(() => {
                if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                    // Login successful
                    localStorage.setItem('adminLoggedIn', 'true');
                    localStorage.setItem('adminLoginTime', new Date().toISOString());
                    
                    // Show success message
                    showSyncIndicator('success', 'Login berhasil!');
                    
                    // Reset form
                    this.reset();
                    
                    // Show home page and update UI
                    showPage('home');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    
                } else {
                    // Login failed
                    showSyncIndicator('error', 'Username atau password salah!');
                    
                    // Shake animation for error
                    const loginCard = document.querySelector('.login-card');
                    loginCard.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        loginCard.style.animation = '';
                    }, 500);
                }
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 1500);
        });

        // Logout function
        function logout() {
            if (confirm('Yakin ingin keluar dari admin panel?')) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminLoginTime');
                
                showSyncIndicator('success', 'Logout berhasil!');
                showPage('login');
                document.getElementById('logoutBtn').classList.add('hidden');
            }
        }

        // Toggle password visibility
        function togglePassword() {
            const passwordInput = document.getElementById('loginPassword');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        // Mulai kamera live
        async function startCamera(type) {
            try {
                // Stop kamera sebelumnya jika ada
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                // Minta akses kamera
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user', // Kamera depan
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });

                currentStream = stream;
                currentCameraType = type;

                const video = document.getElementById('video' + (type === 'masuk' ? 'Masuk' : 'Pulang'));
                const preview = document.getElementById('foto' + (type === 'masuk' ? 'Masuk' : 'Pulang') + 'Preview');

                video.srcObject = stream;
                video.play();

                // Sembunyikan preview dan tampilkan video
                preview.classList.add('hidden');
                video.classList.remove('hidden');

                // Tambahkan tombol capture
                const captureButton = document.createElement('button');
                captureButton.type = 'button';
                captureButton.className = 'absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition-colors';
                captureButton.innerHTML = '<i class="fas fa-camera mr-2"></i>Ambil Foto';
                captureButton.onclick = () => capturePhoto(type);

                const container = video.parentElement;
                container.style.position = 'relative';
                container.appendChild(captureButton);

            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Tidak dapat mengakses kamera. Pastikan browser memiliki izin kamera.');
            }
        }

        // Ambil foto dari kamera live
        function capturePhoto(type) {
            const video = document.getElementById('video' + (type === 'masuk' ? 'Masuk' : 'Pulang'));
            const canvas = document.getElementById('canvas' + (type === 'masuk' ? 'Masuk' : 'Pulang'));
            const preview = document.getElementById('foto' + (type === 'masuk' ? 'Masuk' : 'Pulang') + 'Preview');

            // Set ukuran canvas sesuai video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Gambar frame video ke canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Konversi ke base64
            const photoData = canvas.toDataURL('image/jpeg', 0.8);

            // Tampilkan hasil foto
            preview.innerHTML = `
                <img src="${photoData}" class="captured-photo" alt="Foto ${type}">
                <div class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer text-xs" onclick="removePhoto('${type}')">
                    <i class="fas fa-times"></i>
                </div>
                <div class="absolute bottom-2 left-2 bg-green-500 text-white px-2 py-1 rounded text-xs">
                    <i class="fas fa-check mr-1"></i>Tersimpan
                </div>
            `;

            // Stop kamera dan sembunyikan video
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }

            video.classList.add('hidden');
            preview.classList.remove('hidden');

            // Hapus tombol capture
            const captureButton = video.parentElement.querySelector('button');
            if (captureButton) {
                captureButton.remove();
            }
        }

        // Show photo modal
        function showPhotoModal(photoSrc) {
            const modal = document.getElementById('photoModal');
            const image = document.getElementById('photoModalImage');
            image.src = photoSrc;
            modal.classList.remove('hidden');
        }

        // Close photo modal
        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
        }

        // This function is now defined above in the login section

        // Toggle filter type
        function toggleFilterType() {
            const filterType = document.getElementById('filterTipeRekap').value;
            const monthlyOptions = document.getElementById('monthlyFilterOptions');
            const monthlySummaryTable = document.getElementById('monthlySummaryTable');
            const totalJamHeader = document.getElementById('totalJamHeader');
            
            if (filterType === 'bulanan') {
                monthlyOptions.classList.remove('hidden');
                monthlySummaryTable.classList.remove('hidden');
                totalJamHeader.textContent = 'Total Jam/Bulan';
                loadMonthlySummary();
            } else {
                monthlyOptions.classList.add('hidden');
                monthlySummaryTable.classList.add('hidden');
                totalJamHeader.textContent = 'Total Jam/Hari';
            }
            loadRekapData();
        }

        // Load monthly summary
        function loadMonthlySummary() {
            const bulan = document.getElementById('filterBulan').value;
            const tahun = document.getElementById('filterTahun').value;
            const nama = document.getElementById('filterNamaBulanan').value;
            
            if (!bulan || !tahun) return;
            
            const monthlyData = {};
            
            // Filter data berdasarkan bulan dan tahun
            const filteredData = absensiData.filter(item => {
                const itemDate = new Date(item.tanggal);
                const itemMonth = String(itemDate.getMonth() + 1).padStart(2, '0');
                const itemYear = itemDate.getFullYear();
                
                const matchMonth = itemMonth === bulan;
                const matchYear = itemYear == tahun;
                const matchName = !nama || item.nama === nama;
                
                return matchMonth && matchYear && matchName && item.jamMasuk;
            });
            
            // Group by nama
            filteredData.forEach(item => {
                if (!monthlyData[item.nama]) {
                    monthlyData[item.nama] = {
                        shift: item.shift,
                        totalHari: 0,
                        totalJam: 0,
                        totalMenitTerlambat: 0,
                        totalMenitLembur: 0
                    };
                }
                
                const stats = calculateWorkStats(item.jamMasuk, item.jamPulang, item.shift);
                monthlyData[item.nama].totalHari++;
                
                if (stats.totalJam !== '-') {
                    monthlyData[item.nama].totalJam += parseFloat(stats.totalJam);
                }
                
                // Hitung total menit keterlambatan
                if (stats.keterlambatan !== '-') {
                    const menitTerlambat = parseInt(stats.keterlambatan);
                    if (menitTerlambat > 0) {
                        monthlyData[item.nama].totalMenitTerlambat += menitTerlambat;
                    }
                }
                
                // Hitung total menit lembur
                if (stats.lembur !== '-') {
                    const menitLembur = parseInt(stats.lembur);
                    if (menitLembur > 0) {
                        monthlyData[item.nama].totalMenitLembur += menitLembur;
                    }
                }
            });
            
            // Render table
            const tbody = document.getElementById('monthlySummaryBody');
            tbody.innerHTML = Object.keys(monthlyData).map(nama => {
                const data = monthlyData[nama];
                
                // Format menit ke jam:menit untuk tampilan yang lebih baik
                const formatMenitKeJam = (totalMenit) => {
                    if (totalMenit === 0) return '-';
                    const jam = Math.floor(totalMenit / 60);
                    const menit = totalMenit % 60;
                    if (jam > 0) {
                        return `${jam}j ${menit}m (${totalMenit} menit)`;
                    } else {
                        return `${totalMenit} menit`;
                    }
                };
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 font-medium">${nama}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">${data.shift}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">${data.totalHari} hari</td>
                        <td class="border border-gray-300 px-4 py-3 text-center font-semibold text-blue-600">${data.totalJam.toFixed(1)} jam</td>
                        <td class="border border-gray-300 px-4 py-3 text-center ${data.totalMenitTerlambat > 0 ? 'text-red-600 font-semibold' : 'text-gray-500'}">${formatMenitKeJam(data.totalMenitTerlambat)}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center ${data.totalMenitLembur > 0 ? 'text-green-600 font-semibold' : 'text-gray-500'}">${formatMenitKeJam(data.totalMenitLembur)}</td>
                    </tr>
                `;
            }).join('');
            
            if (Object.keys(monthlyData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">Tidak ada data untuk periode yang dipilih</td></tr>';
            }
        }

        // Hapus foto
        function removePhoto(type) {
            const preview = document.getElementById('foto' + (type === 'masuk' ? 'Masuk' : 'Pulang') + 'Preview');
            const video = document.getElementById('video' + (type === 'masuk' ? 'Masuk' : 'Pulang'));
            
            // Stop kamera jika sedang aktif
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // Sembunyikan video dan tampilkan preview
            video.classList.add('hidden');
            preview.classList.remove('hidden');
            
            // Reset preview
            preview.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-500 text-sm">Klik untuk kamera live</p>
                </div>
            `;
            
            // Hapus tombol capture jika ada
            const captureButton = video.parentElement.querySelector('button');
            if (captureButton) {
                captureButton.remove();
            }
        }

        // Submit form absensi
        document.getElementById('absensiForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            const formData = {
                id: Date.now().toString(),
                tanggal: new Date().toISOString().split('T')[0],
                nama: document.getElementById('namaPetugas').value,
                shift: document.getElementById('shift').value,
                jamMasuk: document.getElementById('jamMasuk').value,
                jamPulang: document.getElementById('jamPulang').value,
                fotoMasuk: document.querySelector('#fotoMasukPreview img')?.src || '',
                fotoPulang: document.querySelector('#fotoPulangPreview img')?.src || '',
                catatan: document.getElementById('catatan').value,
                timestamp: new Date().toISOString()
            };

            // Validasi
            if (!formData.nama || !formData.shift || !formData.jamMasuk) {
                alert('Mohon lengkapi data yang wajib diisi (Nama, Shift, Jam Masuk)!');
                return;
            }

            // Cek duplikasi absensi hari ini
            const existingAbsensi = absensiData.find(item => 
                item.nama === formData.nama && 
                item.tanggal === formData.tanggal &&
                item.jamMasuk // Sudah absen masuk
            );

            if (existingAbsensi && !formData.jamPulang) {
                alert('Petugas sudah melakukan absensi masuk hari ini!');
                return;
            }

            showLoading(true);
            showSyncIndicator('syncing', 'Menyimpan data...');
            
            // Simulasi delay untuk menunjukkan loading
            setTimeout(async () => {
                try {
                    // Jika sudah ada absensi masuk, update dengan jam pulang
                    if (existingAbsensi && formData.jamPulang) {
                        const index = absensiData.findIndex(item => item.id === existingAbsensi.id);
                        absensiData[index].jamPulang = formData.jamPulang;
                        absensiData[index].fotoPulang = formData.fotoPulang;
                        if (formData.catatan) {
                            absensiData[index].catatan = formData.catatan;
                        }
                        
                        // Update di Firebase
                        await updateInFirebase(existingAbsensi.id, {
                            jamPulang: formData.jamPulang,
                            fotoPulang: formData.fotoPulang,
                            catatan: formData.catatan
                        });
                    } else {
                        // Tambah absensi baru
                        absensiData.push(formData);
                        
                        // Simpan ke Firebase
                        await saveToFirebase(formData);
                    }
                    
                    // Reset form
                    this.reset();
                    resetPhotoPreview();
                    
                    showLoading(false);
                    showSyncIndicator('success', 'Data tersimpan!');
                    
                    // Update UI jika tidak menggunakan real-time listener
                    if (!firebaseReady) {
                        loadAbsensiHariIni();
                        updateStats();
                    }
                    
                } catch (error) {
                    console.error('Error saving data:', error);
                    showLoading(false);
                    showSyncIndicator('error', 'Gagal menyimpan data!');
                }
            }, 1000);
        });

        // Reset preview foto
        function resetPhotoPreview() {
            // Stop kamera jika sedang aktif
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            ['fotoMasukPreview', 'fotoPulangPreview'].forEach(id => {
                const preview = document.getElementById(id);
                const videoId = id.replace('Preview', '').replace('foto', 'video');
                const video = document.getElementById(videoId);
                
                // Sembunyikan video dan tampilkan preview
                if (video) {
                    video.classList.add('hidden');
                }
                preview.classList.remove('hidden');
                
                preview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500 text-sm">Klik untuk kamera live</p>
                    </div>
                `;
                
                // Hapus tombol capture jika ada
                const captureButton = preview.parentElement.querySelector('button');
                if (captureButton) {
                    captureButton.remove();
                }
            });
        }

        // Show/hide loading
        function showLoading(show) {
            isLoading = show;
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        // Load absensi hari ini
        function loadAbsensiHariIni() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = absensiData.filter(item => item.tanggal === today);
            
            // Sort berdasarkan jam masuk (yang sudah absen masuk di atas)
            todayData.sort((a, b) => {
                // Prioritas: sudah absen masuk dan pulang > sudah absen masuk > belum absen
                const aComplete = a.jamMasuk && a.jamPulang;
                const bComplete = b.jamMasuk && b.jamPulang;
                const aStarted = a.jamMasuk && !a.jamPulang;
                const bStarted = b.jamMasuk && !b.jamPulang;
                
                if (aStarted && !bStarted) return -1;
                if (!aStarted && bStarted) return 1;
                if (aComplete && !bComplete) return 1;
                if (!aComplete && bComplete) return -1;
                
                // Jika sama-sama sudah mulai, urutkan berdasarkan jam masuk
                if (a.jamMasuk && b.jamMasuk) {
                    return a.jamMasuk.localeCompare(b.jamMasuk);
                }
                
                return a.nama.localeCompare(b.nama);
            });
            
            const container = document.getElementById('absensiHariIni');
            
            if (todayData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Belum ada absensi hari ini</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = todayData.map(item => {
                const stats = calculateWorkStats(item.jamMasuk, item.jamPulang, item.shift);
                const status = getAttendanceStatus(item.jamMasuk, item.jamPulang, item.shift);
                
                let cardClass = 'attendance-card';
                if (item.jamMasuk && item.jamPulang) {
                    cardClass += ' hadir';
                } else if (item.jamMasuk && !item.jamPulang) {
                    cardClass += ' belum-pulang';
                } else {
                    cardClass += ' terlambat';
                }
                
                return `
                    <div class="${cardClass} border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">${item.nama}</h3>
                                <p class="text-sm text-gray-600">${shiftSchedule[item.shift]?.name || item.shift}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${item.fotoMasuk ? `<img src="${item.fotoMasuk}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoMasuk}')" title="Foto Masuk">` : ''}
                                ${item.fotoPulang ? `<img src="${item.fotoPulang}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoPulang}')" title="Foto Pulang">` : ''}
                                <span class="status-badge ${status.class}">${status.text}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Masuk:</span>
                                <span class="font-medium ml-2 ${item.jamMasuk ? 'text-green-600' : 'text-red-500'}">${item.jamMasuk || 'Belum absen'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Pulang:</span>
                                <span class="font-medium ml-2 ${item.jamPulang ? 'text-blue-600' : 'text-gray-400'}">${item.jamPulang || 'Belum absen'}</span>
                            </div>
                        </div>
                        ${stats.totalJam !== '-' ? `
                            <div class="mt-2 text-sm">
                                <span class="text-gray-600">Total Jam:</span>
                                <span class="font-medium ml-2 text-blue-600">${stats.totalJam}</span>
                            </div>
                        ` : ''}
                        ${stats.keterlambatan !== '-' ? `
                            <div class="mt-1 text-sm">
                                <span class="text-gray-600">Terlambat:</span>
                                <span class="font-medium ml-2 text-orange-600">${stats.keterlambatan}</span>
                            </div>
                        ` : ''}
                        ${stats.lembur !== '-' ? `
                            <div class="mt-1 text-sm">
                                <span class="text-gray-600">Lembur:</span>
                                <span class="font-medium ml-2 text-purple-600">${stats.lembur}</span>
                            </div>
                        ` : ''}
                        ${item.catatan ? `<p class="text-sm text-gray-600 mt-2 italic">"${item.catatan}"</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Get attendance status
        function getAttendanceStatus(jamMasuk, jamPulang, shift) {
            if (!jamMasuk) return { text: 'Belum Absen', class: 'status-badge bg-gray-100 text-gray-600' };
            
            if (!jamPulang) return { text: 'Belum Pulang', class: 'status-belum-pulang' };
            
            const stats = calculateWorkStats(jamMasuk, jamPulang, shift);
            
            if (stats.keterlambatan !== '-' && parseInt(stats.keterlambatan) > 0) {
                return { text: 'Terlambat', class: 'status-terlambat' };
            }
            
            if (stats.lembur !== '-' && parseInt(stats.lembur) > 0) {
                return { text: 'Lembur', class: 'status-lembur' };
            }
            
            return { text: 'Hadir', class: 'status-hadir' };
        }

        // Update stats cards
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = absensiData.filter(item => item.tanggal === today);
            
            let hadir = 0, terlambat = 0, belumPulang = 0;
            
            todayData.forEach(item => {
                if (item.jamMasuk) hadir++;
                if (item.jamMasuk && !item.jamPulang) belumPulang++;
                
                const stats = calculateWorkStats(item.jamMasuk, item.jamPulang, item.shift);
                if (stats.keterlambatan !== '-' && parseInt(stats.keterlambatan) > 0) terlambat++;
            });
            
            document.getElementById('hadirHariIni').textContent = hadir;
            document.getElementById('terlambatHariIni').textContent = terlambat;
            document.getElementById('belumPulangHariIni').textContent = belumPulang;
        }

        // Hitung statistik kerja
        function calculateWorkStats(jamMasuk, jamPulang, shift) {
            if (!jamMasuk || !jamPulang) {
                return {
                    totalJam: '-',
                    keterlambatan: '-',
                    pulangCepat: '-',
                    lembur: '-'
                };
            }

            const masuk = new Date(`2000-01-01 ${jamMasuk}`);
            const pulang = new Date(`2000-01-01 ${jamPulang}`);
            
            // Handle shift yang melewati tengah malam
            if ((shift === 'Shift Piket') && pulang < masuk) {
                pulang.setDate(pulang.getDate() + 1);
            }

            // Hitung total jam kerja (dikurangi 1 jam istirahat)
            const totalMenit = (pulang - masuk) / (1000 * 60) - 60;
            const totalJam = Math.max(0, totalMenit / 60);

            const schedule = shiftSchedule[shift];
            if (!schedule) {
                return {
                    totalJam: totalJam.toFixed(1) + ' jam',
                    keterlambatan: '-',
                    pulangCepat: '-',
                    lembur: '-'
                };
            }

            const scheduledStart = new Date(`2000-01-01 ${schedule.start}`);
            const scheduledEnd = new Date(`2000-01-01 ${schedule.end}`);
            
            if (shift === 'Shift Piket') {
                scheduledEnd.setDate(scheduledEnd.getDate() + 1);
            }

            // Hitung keterlambatan
            const keterlambatan = Math.max(0, (masuk - scheduledStart) / (1000 * 60));
            
            // Hitung pulang cepat
            const pulangCepat = Math.max(0, (scheduledEnd - pulang) / (1000 * 60));
            
            // Hitung lembur
            const lembur = Math.max(0, (pulang - scheduledEnd) / (1000 * 60));

            return {
                totalJam: totalJam.toFixed(1) + ' jam',
                keterlambatan: keterlambatan > 0 ? Math.floor(keterlambatan) + ' menit' : '-',
                pulangCepat: pulangCepat > 0 ? Math.floor(pulangCepat) + ' menit' : '-',
                lembur: lembur > 0 ? Math.floor(lembur) + ' menit' : '-'
            };
        }

        // Load rekap data
        function loadRekapData() {
            const tableBody = document.getElementById('rekapTableBody');
            const mobileCards = document.getElementById('rekapMobileCards');
            const filterType = document.getElementById('filterTipeRekap').value;
            
            if (absensiData.length === 0) {
                const emptyMessage = `
                    <div class="text-center py-8">
                        <i class="fas fa-chart-line text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Belum ada data absensi</p>
                    </div>
                `;
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">Belum ada data absensi</td></tr>';
                mobileCards.innerHTML = emptyMessage;
                return;
            }

            // Sort data by date (newest first)
            const sortedData = [...absensiData].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            
            // Desktop table
            tableBody.innerHTML = sortedData.map(item => {
                const stats = calculateWorkStats(item.jamMasuk, item.jamPulang, item.shift);
                const totalJamDisplay = filterType === 'bulanan' ? 
                    (stats.totalJam !== '-' ? stats.totalJam : '-') : 
                    stats.totalJam;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 text-sm font-medium">${item.nama}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm">${item.shift}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm">${item.jamMasuk || '-'}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm">${item.jamPulang || '-'}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            <div class="flex gap-1 justify-center">
                                ${item.fotoMasuk ? `<img src="${item.fotoMasuk}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoMasuk}')" title="Foto Masuk">` : '<span class="text-gray-400 text-xs">-</span>'}
                                ${item.fotoPulang ? `<img src="${item.fotoPulang}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoPulang}')" title="Foto Pulang">` : ''}
                            </div>
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-sm">${stats.keterlambatan}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm">${stats.lembur}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm font-semibold text-blue-600">${totalJamDisplay}</td>
                        <td class="border border-gray-300 px-4 py-3">
                            <div class="flex gap-1">
                                <button onclick="editAbsensi('${item.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteAbsensi('${item.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Mobile cards
            mobileCards.innerHTML = sortedData.map(item => {
                const stats = calculateWorkStats(item.jamMasuk, item.jamPulang, item.shift);
                const totalJamDisplay = filterType === 'bulanan' ? 
                    (stats.totalJam !== '-' ? stats.totalJam : '-') : 
                    stats.totalJam;
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 bg-white">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-semibold text-gray-800">${item.nama}</h3>
                                <p class="text-sm text-gray-600">${new Date(item.tanggal).toLocaleDateString('id-ID')} - ${item.shift}</p>
                            </div>
                            <div class="flex gap-2">
                                ${item.fotoMasuk ? `<img src="${item.fotoMasuk}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoMasuk}')" title="Foto Masuk">` : ''}
                                ${item.fotoPulang ? `<img src="${item.fotoPulang}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoPulang}')" title="Foto Pulang">` : ''}
                                <button onclick="editAbsensi('${item.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteAbsensi('${item.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div><span class="text-gray-600">Masuk:</span> <span class="font-medium">${item.jamMasuk || '-'}</span></div>
                            <div><span class="text-gray-600">Pulang:</span> <span class="font-medium">${item.jamPulang || '-'}</span></div>
                            <div><span class="text-gray-600">Total:</span> <span class="font-medium text-blue-600">${totalJamDisplay}</span></div>
                            <div><span class="text-gray-600">Terlambat:</span> <span class="font-medium">${stats.keterlambatan}</span></div>
                            <div><span class="text-gray-600">Lembur:</span> <span class="font-medium">${stats.lembur}</span></div>
                        </div>
                        ${item.catatan ? `<p class="text-sm text-gray-600 mt-2"><span class="font-medium">Catatan:</span> ${item.catatan}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Update summary stats
        function updateSummaryStats() {
            const container = document.getElementById('summaryStats');
            
            let totalHadir = 0, totalTerlambat = 0, totalLembur = 0, totalJamKerja = 0;
            
            absensiData.forEach(item => {
                if (item.jamMasuk) totalHadir++;
                
                const stats = calculateWorkStats(item.jamMasuk, item.jamPulang, item.shift);
                if (stats.keterlambatan !== '-' && parseInt(stats.keterlambatan) > 0) totalTerlambat++;
                if (stats.lembur !== '-' && parseInt(stats.lembur) > 0) totalLembur++;
                if (stats.totalJam !== '-') totalJamKerja += parseFloat(stats.totalJam);
            });
            
            container.innerHTML = `
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-user-check text-green-600 text-xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Total Kehadiran</p>
                            <p class="text-xl font-bold text-gray-800">${totalHadir}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-yellow-600 text-xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Total Terlambat</p>
                            <p class="text-xl font-bold text-gray-800">${totalTerlambat}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-business-time text-blue-600 text-xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Total Lembur</p>
                            <p class="text-xl font-bold text-gray-800">${totalLembur}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-hourglass-half text-purple-600 text-xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Total Jam Kerja</p>
                            <p class="text-xl font-bold text-gray-800">${totalJamKerja.toFixed(1)} jam</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Edit absensi
        function editAbsensi(id) {
            const item = absensiData.find(data => data.id === id);
            if (!item) return;

            document.getElementById('editId').value = id;
            document.getElementById('editJamMasuk').value = item.jamMasuk;
            document.getElementById('editJamPulang').value = item.jamPulang;
            document.getElementById('editCatatan').value = item.catatan;
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        // Submit edit form
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            const itemIndex = absensiData.findIndex(data => data.id === id);
            
            if (itemIndex !== -1) {
                showLoading(true);
                showSyncIndicator('syncing', 'Mengupdate data...');
                
                setTimeout(async () => {
                    try {
                        const updatedData = {
                            jamMasuk: document.getElementById('editJamMasuk').value,
                            jamPulang: document.getElementById('editJamPulang').value,
                            catatan: document.getElementById('editCatatan').value
                        };
                        
                        // Update local data
                        absensiData[itemIndex].jamMasuk = updatedData.jamMasuk;
                        absensiData[itemIndex].jamPulang = updatedData.jamPulang;
                        absensiData[itemIndex].catatan = updatedData.catatan;
                        
                        // Update di Firebase
                        await updateInFirebase(id, updatedData);
                        
                        closeEditModal();
                        showLoading(false);
                        showSyncIndicator('success', 'Data terupdate!');
                        
                        // Update UI jika tidak menggunakan real-time listener
                        if (!firebaseReady) {
                            loadRekapData();
                            updateSummaryStats();
                            loadAbsensiHariIni();
                            updateStats();
                        }
                        
                    } catch (error) {
                        console.error('Error updating data:', error);
                        showLoading(false);
                        showSyncIndicator('error', 'Gagal mengupdate data!');
                    }
                }, 500);
            }
        });

        // Delete absensi
        function deleteAbsensi(id) {
            if (confirm('Yakin ingin menghapus data absensi ini?')) {
                showLoading(true);
                showSyncIndicator('syncing', 'Menghapus data...');
                
                setTimeout(async () => {
                    try {
                        // Hapus dari Firebase
                        await deleteFromFirebase(id);
                        
                        // Hapus dari local data
                        absensiData = absensiData.filter(data => data.id !== id);
                        
                        showLoading(false);
                        showSyncIndicator('success', 'Data terhapus!');
                        
                        // Update UI jika tidak menggunakan real-time listener
                        if (!firebaseReady) {
                            loadRekapData();
                            loadAbsensiHariIni();
                            updateStats();
                            updateSummaryStats();
                        }
                        
                    } catch (error) {
                        console.error('Error deleting data:', error);
                        showLoading(false);
                        showSyncIndicator('error', 'Gagal menghapus data!');
                    }
                }, 500);
            }
        }

        // Apply filter
        function applyFilter() {
            const filterType = document.getElementById('filterTipeRekap').value;
            
            if (filterType === 'bulanan') {
                loadMonthlySummary();
                return;
            }
            
            const filterTanggalMulai = document.getElementById('filterTanggalMulai').value;
            const filterTanggalAkhir = document.getElementById('filterTanggalAkhir').value;
            const filterNama = document.getElementById('filterNama').value;
            
            let filteredData = [...absensiData];
            
            if (filterTanggalMulai) {
                filteredData = filteredData.filter(item => item.tanggal >= filterTanggalMulai);
            }
            
            if (filterTanggalAkhir) {
                filteredData = filteredData.filter(item => item.tanggal <= filterTanggalAkhir);
            }
            
            if (filterNama) {
                filteredData = filteredData.filter(item => item.nama === filterNama);
            }
            
            // Update display with filtered data
            const originalData = [...absensiData];
            absensiData = filteredData;
            loadRekapData();
            updateSummaryStats();
            absensiData = originalData; // Restore original data
        }

        // Event listeners untuk filter bulanan
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('filterBulan').addEventListener('change', loadMonthlySummary);
            document.getElementById('filterTahun').addEventListener('change', loadMonthlySummary);
            document.getElementById('filterNamaBulanan').addEventListener('change', loadMonthlySummary);
        });

        // Export to Excel
        function exportToExcel() {
            if (absensiData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }

            showLoading(true);
            
            setTimeout(() => {
                const filterType = document.getElementById('filterTipeRekap').value;
                const exportData = absensiData.map(item => {
                    const stats = calculateWorkStats(item.jamMasuk, item.jamPulang, item.shift);
                    const totalJamDisplay = filterType === 'bulanan' ? 
                        (stats.totalJam !== '-' ? stats.totalJam : '-') : 
                        stats.totalJam;
                    
                    return {
                        'Tanggal': new Date(item.tanggal).toLocaleDateString('id-ID'),
                        'Nama Petugas': item.nama,
                        'Shift': item.shift,
                        'Jam Masuk': item.jamMasuk || '-',
                        'Jam Pulang': item.jamPulang || '-',
                        'Keterlambatan': stats.keterlambatan,
                        'Lembur': stats.lembur,
                        [`Total Jam ${filterType === 'bulanan' ? 'Kerja/Bulan' : 'Kerja/Hari'}`]: totalJamDisplay,
                        'Catatan': item.catatan || '-'
                    };
                });

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Rekap Absensi PPSU');
                
                const fileName = `Rekap_Absensi_PPSU_Pisangan_Baru_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showLoading(false);
                showSyncIndicator('success', 'Data berhasil diekspor!');
            }, 1000);
        }

        // Export to CSV
        function exportToCSV() {
            if (absensiData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }

            showLoading(true);
            
            setTimeout(() => {
                const filterType = document.getElementById('filterTipeRekap').value;
                const exportData = absensiData.map(item => {
                    const stats = calculateWorkStats(item.jamMasuk, item.jamPulang, item.shift);
                    const totalJamDisplay = filterType === 'bulanan' ? 
                        (stats.totalJam !== '-' ? stats.totalJam : '-') : 
                        stats.totalJam;
                    
                    return {
                        'Tanggal': new Date(item.tanggal).toLocaleDateString('id-ID'),
                        'Nama Petugas': item.nama,
                        'Shift': item.shift,
                        'Jam Masuk': item.jamMasuk || '-',
                        'Jam Pulang': item.jamPulang || '-',
                        'Keterlambatan': stats.keterlambatan,
                        'Lembur': stats.lembur,
                        [`Total Jam ${filterType === 'bulanan' ? 'Kerja/Bulan' : 'Kerja/Hari'}`]: totalJamDisplay,
                        'Catatan': item.catatan || '-'
                    };
                });

                const ws = XLSX.utils.json_to_sheet(exportData);
                const csv = XLSX.utils.sheet_to_csv(ws);
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `Rekap_Absensi_PPSU_Pisangan_Baru_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showLoading(false);
                showSyncIndicator('success', 'Data berhasil diekspor!');
            }, 1000);
        }

        // Clear all data
        function clearAllData() {
            if (confirm('⚠️ PERINGATAN: Ini akan menghapus SEMUA data absensi secara permanen!\n\nSemua data 43 petugas akan hilang dan tidak dapat dikembalikan.\n\nYakin ingin melanjutkan?')) {
                if (confirm('🔴 KONFIRMASI TERAKHIR:\n\nSemua data absensi akan dihapus permanen!\nTindakan ini tidak dapat dibatalkan.\n\nKlik OK untuk menghapus semua data.')) {
                    showLoading(true);
                    showSyncIndicator('syncing', 'Menghapus semua data...');
                    
                    setTimeout(async () => {
                        try {
                            // Hapus semua data dari Firebase
                            await clearAllFirebaseData();
                            
                            // Clear local data
                            absensiData = [];
                            
                            showLoading(false);
                            showSyncIndicator('success', 'Semua data terhapus!');
                            
                            // Update UI jika tidak menggunakan real-time listener
                            if (!firebaseReady) {
                                loadRekapData();
                                loadAbsensiHariIni();
                                updateStats();
                                updateSummaryStats();
                            }
                            
                        } catch (error) {
                            console.error('Error clearing all data:', error);
                            showLoading(false);
                            showSyncIndicator('error', 'Gagal menghapus semua data!');
                        }
                    }, 1500);
                }
            }
        }

        // Refresh data
        function refreshData() {
            showLoading(true);
            showSyncIndicator('syncing', 'Menyinkronkan data...');
            
            setTimeout(() => {
                // Simulasi refresh dari server
                const savedData = JSON.parse(localStorage.getItem('absensiPPSUData')) || [];
                absensiData = savedData;
                
                loadAbsensiHariIni();
                updateStats();
                
                if (!document.getElementById('adminPage').classList.contains('hidden')) {
                    loadRekapData();
                    updateSummaryStats();
                }
                
                showLoading(false);
                showSyncIndicator('success', 'Data tersinkron!');
            }, 1000);
        }

        // Sync data (simulasi Firebase real-time)
        function syncData() {
            const savedData = JSON.parse(localStorage.getItem('absensiPPSUData')) || [];
            if (JSON.stringify(savedData) !== JSON.stringify(absensiData)) {
                absensiData = savedData;
                
                loadAbsensiHariIni();
                updateStats();
                
                if (!document.getElementById('adminPage').classList.contains('hidden')) {
                    loadRekapData();
                    updateSummaryStats();
                }
                
                // Show sync notification
                showSyncIndicator('success', 'Data tersinkron otomatis');
            }
        }

        // Handle offline/online status
        window.addEventListener('online', function() {
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-wifi text-green-500"></i> Online';
            showSyncIndicator('success', 'Kembali online');
            syncData();
        });

        window.addEventListener('offline', function() {
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-wifi-slash text-red-500"></i> Offline';
            showSyncIndicator('error', 'Mode offline');
        });

        // Handle visibility change (tab switching)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                syncData();
                checkSessionTimeout();
            }
        });

        // Session timeout (24 hours)
        function checkSessionTimeout() {
            const loginTime = localStorage.getItem('adminLoginTime');
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            
            if (isLoggedIn && loginTime) {
                const loginDate = new Date(loginTime);
                const now = new Date();
                const hoursDiff = (now - loginDate) / (1000 * 60 * 60);
                
                // Auto logout after 24 hours
                if (hoursDiff > 24) {
                    localStorage.removeItem('adminLoggedIn');
                    localStorage.removeItem('adminLoginTime');
                    showSyncIndicator('error', 'Sesi telah berakhir, silakan login kembali');
                    showPage('login');
                    document.getElementById('logoutBtn').classList.add('hidden');
                }
            }
        }

        // Check session timeout every 5 minutes
        setInterval(checkSessionTimeout, 5 * 60 * 1000);

        // Prevent right-click on sensitive areas (optional security)
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('#loginPage') || e.target.closest('#adminPage')) {
                e.preventDefault();
            }
        });



        // Clear sensitive data on page unload
        window.addEventListener('beforeunload', function() {
            // Clear any temporary sensitive data if needed
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97407b86264afce4',t:'MTc1NjAxMzY4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
