<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi PPSU Pisangan Baru </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #3b82f6;
            --dark-blue: #1e40af;
            --light-blue: #60a5fa;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --danger-red: #ef4444;
            --purple: #8b5cf6;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .glass-nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .camera-preview {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px dashed var(--primary-blue);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .camera-preview:hover {
            border-color: var(--dark-blue);
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: scale(1.02);
        }
        
        .captured-photo {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
        }
        
        .photo-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--primary-blue);
        }
        
        .photo-thumbnail:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .modern-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .modern-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-hadir { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
        }
        
        .status-terlambat { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: white; 
        }
        
        .status-lembur { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed); 
            color: white; 
        }
        
        .status-belum-pulang { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white; 
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .attendance-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
        }
        
        .attendance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .attendance-card.hadir {
            border-left-color: #10b981;
        }
        
        .attendance-card.terlambat {
            border-left-color: #f59e0b;
        }
        
        .attendance-card.belum-pulang {
            border-left-color: #ef4444;
        }
        
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modern-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
        }
        
        .modern-table th {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .modern-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .sync-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .sync-online {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .sync-syncing {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
        }
        
        .sync-offline {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .notification-toast {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: all 0.3s ease;
            max-width: 300px;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .auto-time-display {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            margin-top: 8px;
        }
        
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .tab-button {
            padding: 12px 24px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border-bottom-color: #1e40af;
        }
        
        .tab-button:not(.active) {
            background: rgba(255, 255, 255, 0.7);
            color: #6b7280;
        }
        
        .tab-button:not(.active):hover {
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
        }
        
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
            .mobile-card {
                display: block;
            }
            .desktop-table {
                display: none;
            }
            .sync-indicator {
                top: 70px;
                right: 10px;
                font-size: 10px;
                padding: 6px 12px;
            }
            .notification-toast {
                top: 90px;
                right: 10px;
                max-width: 250px;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-card {
                display: none;
            }
            .desktop-table {
                display: table;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="glass-card rounded-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold gradient-text">Login Admin</h1>
                <p class="text-gray-600 mt-2">Masuk untuk mengakses halaman admin</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <input type="text" id="loginUsername" class="modern-input w-full px-4 py-3 focus:outline-none" placeholder="Masukkan username" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="modern-input w-full px-4 py-3 focus:outline-none" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="btn-primary w-full py-3 px-6 rounded-xl text-white font-semibold">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
                <button type="button" onclick="showMainApp()" class="w-full py-3 px-6 rounded-xl text-gray-600 font-semibold border border-gray-300 hover:bg-gray-50 transition-all">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali ke Absensi
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Sync Indicator -->
        <div id="syncIndicator" class="sync-indicator sync-online">
            <i class="fas fa-wifi mr-2"></i>Tersinkron Real-time
        </div>

        <!-- Notification Toast -->
        <div id="notificationToast" class="notification-toast">
            <div class="flex items-center">
                <div id="notificationIcon" class="mr-3 text-xl"></div>
                <div>
                    <div id="notificationTitle" class="font-semibold text-sm"></div>
                    <div id="notificationMessage" class="text-xs text-gray-600"></div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="glass-nav sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 flex items-center justify-center mr-3">
                            <i class="fas fa-clipboard-check text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white">Absensi PPSU Pisangan Baru</h1>
                            <p class="text-xs text-blue-200">PPSU Attendance System</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="glass-card px-3 py-2 rounded-lg mr-4 hidden sm:block">
                            <div class="text-center">
                                <div id="currentTime" class="text-lg font-bold gradient-text"></div>
                                <div id="currentDate" class="text-xs text-blue-300"></div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <button onclick="showPage('home')" class="nav-btn px-3 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition-all text-sm sm:text-base">
                                <i class="fas fa-home mr-1 sm:mr-2"></i><span class="hidden sm:inline">Home</span>
                            </button>
                            <button onclick="showAdminLogin()" class="nav-btn px-3 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition-all text-sm sm:text-base">
                                <i class="fas fa-user-shield mr-1 sm:mr-2"></i><span class="hidden sm:inline">Admin</span>
                            </button>
                            <button id="logoutBtn" onclick="logout()" class="nav-btn px-3 py-2 rounded-lg text-white hover:bg-white hover:bg-opacity-20 transition-all text-sm sm:text-base hidden">
                                <i class="fas fa-sign-out-alt mr-1 sm:mr-2"></i><span class="hidden sm:inline">Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Home Page -->
        <div id="homePage" class="page">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- Mobile Time Display -->
                <div class="glass-card rounded-xl p-4 mb-6 sm:hidden">
                    <div class="text-center">
                        <div id="currentTimeMobile" class="text-2xl font-bold gradient-text"></div>
                        <div id="currentDateMobile" class="text-sm text-blue-600"></div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="stats-card p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 shadow-lg">
                                <i class="fas fa-user-check text-white text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-semibold text-gray-600">Hadir Hari Ini</p>
                                <p id="hadirHariIni" class="text-3xl font-bold gradient-text">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="stats-card p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-gradient-to-r from-yellow-500 to-orange-600 shadow-lg">
                                <i class="fas fa-clock text-white text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-semibold text-gray-600">Terlambat</p>
                                <p id="terlambatHariIni" class="text-3xl font-bold gradient-text">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="stats-card p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-gradient-to-r from-red-500 to-pink-600 shadow-lg">
                                <i class="fas fa-user-clock text-white text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-semibold text-gray-600">Belum Pulang</p>
                                <p id="belumPulangHariIni" class="text-3xl font-bold gradient-text">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="stats-card p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-gradient-to-r from-purple-500 to-indigo-600 shadow-lg">
                                <i class="fas fa-users text-white text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-semibold text-gray-600">Total Petugas</p>
                                <p class="text-3xl font-bold gradient-text">43</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Form Absensi -->
                    <div class="glass-card rounded-xl p-6">
                        <h2 class="text-2xl font-bold gradient-text mb-6 flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 flex items-center justify-center mr-3">
                                <i class="fas fa-user-clock text-white"></i>
                            </div>
                            Form Absensi Real-time
                        </h2>
                        
                        <form id="absensiForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Petugas *</label>
                                <select id="namaPetugas" class="modern-input w-full px-4 py-3 focus:outline-none" required>
                                    <option value="">Pilih Nama Petugas</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Shift *</label>
                                <select id="shift" class="modern-input w-full px-4 py-3 focus:outline-none" required>
                                    <option value="">Pilih Shift</option>
                                    <option value="Shift 1">Shift 1 (05:00 - 13:00)</option>
                                    <option value="Shift 2">Shift 2 (07:20 - 15:20)</option>
                                    <option value="Shift Piket">Shift Piket (18:00 - 06:00)</option>
                                    <option value="Shift Piket Pagi">Shift Piket Pagi (07:00 - 12:00)</option>
                                    <option value="Shift Piket Siang">Shift Piket Siang (12:00 - 17:00)</option>
                                    <option value="Shift Kantor">Shift Kantor (07:00 - 17:00)</option>
                                </select>
                            </div>

                            <!-- Auto Time Display -->
                            <div id="autoTimeDisplay" class="hidden">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div id="jamMasukDisplay" class="hidden">
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Jam Masuk (Otomatis)</label>
                                        <div class="auto-time-display">
                                            <i class="fas fa-clock mr-2"></i><span id="jamMasukValue">-</span>
                                        </div>
                                    </div>
                                    <div id="jamPulangDisplay" class="hidden">
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Jam Pulang (Otomatis)</label>
                                        <div class="auto-time-display">
                                            <i class="fas fa-clock mr-2"></i><span id="jamPulangValue">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Foto Absen Masuk * 
                                        <span class="text-red-500 text-xs">(WAJIB)</span>
                                    </label>
                                    <div class="camera-container">
                                        <div id="fotoMasukPreview" class="camera-preview" onclick="startCamera('masuk')">
                                            <div class="text-center">
                                                <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                                                <p class="text-gray-500 text-sm">Klik untuk ambil foto</p>
                                                <p class="text-red-500 text-xs mt-1">Jam masuk otomatis</p>
                                            </div>
                                        </div>
                                        <video id="videoMasuk" class="hidden w-full h-48 object-cover rounded-lg"></video>
                                        <canvas id="canvasMasuk" class="hidden"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Foto Absen Pulang
                                        <span class="text-orange-500 text-xs">(WAJIB jika pulang)</span>
                                    </label>
                                    <div class="camera-container">
                                        <div id="fotoPulangPreview" class="camera-preview" onclick="startCamera('pulang')">
                                            <div class="text-center">
                                                <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                                                <p class="text-gray-500 text-sm">Klik untuk ambil foto</p>
                                                <p class="text-orange-500 text-xs mt-1">Jam pulang otomatis</p>
                                            </div>
                                        </div>
                                        <video id="videoPulang" class="hidden w-full h-48 object-cover rounded-lg"></video>
                                        <canvas id="canvasPulang" class="hidden"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Catatan</label>
                                <textarea id="catatan" rows="3" class="modern-input w-full px-4 py-3 focus:outline-none" placeholder="Catatan tambahan (opsional)"></textarea>
                            </div>

                            <button type="submit" class="btn-primary w-full py-3 px-6 rounded-xl text-white font-semibold text-lg flex items-center justify-center">
                                <i class="fas fa-save mr-2"></i>Simpan Absensi Real-time
                            </button>
                        </form>
                    </div>

                    <!-- Data Absensi Hari Ini -->
                    <div class="glass-card rounded-xl p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold gradient-text flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 flex items-center justify-center mr-3">
                                    <i class="fas fa-list text-white"></i>
                                </div>
                                Absensi Hari Ini
                                <div class="pulse-dot ml-3"></div>
                            </h2>
                            <button onclick="refreshData()" class="p-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:shadow-lg transition-all">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div id="absensiHariIni" class="space-y-3 max-h-96 overflow-y-auto">
                            <!-- Data akan dimuat di sini -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="page hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="glass-card rounded-xl p-6">
                    <!-- Admin Tabs -->
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="showAdminTab('rekap')" class="tab-button active" id="rekapTab">
                            <i class="fas fa-chart-bar mr-2"></i>Rekap Absensi
                        </button>
                        <button onclick="showAdminTab('harian')" class="tab-button" id="harianTab">
                            <i class="fas fa-calendar-day mr-2"></i>Laporan Harian
                        </button>
                        <button onclick="showAdminTab('bulanan')" class="tab-button" id="bulananTab">
                            <i class="fas fa-calendar-alt mr-2"></i>Laporan Bulanan
                        </button>
                    </div>

                    <!-- Rekap Tab -->
                    <div id="rekapTabContent" class="tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold gradient-text flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-bar text-white"></i>
                                </div>
                                Rekap Absensi Real-time
                                <div class="pulse-dot ml-3"></div>
                            </h2>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="exportToExcel()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-xl hover:shadow-lg transition-all text-sm font-semibold">
                                    <i class="fas fa-file-excel mr-2"></i>Export Excel
                                </button>
                                <button onclick="exportToCSV()" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-xl hover:shadow-lg transition-all text-sm font-semibold">
                                    <i class="fas fa-file-csv mr-2"></i>Export CSV
                                </button>
                                <button onclick="clearAllData()" class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-4 py-2 rounded-xl hover:shadow-lg transition-all text-sm font-semibold">
                                    <i class="fas fa-trash mr-2"></i>Hapus Semua
                                </button>
                            </div>
                        </div>

                        <!-- Filter -->
                        <div class="mb-6">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <input type="date" id="filterTanggalMulai" class="modern-input px-4 py-2 focus:outline-none" placeholder="Tanggal Mulai">
                                <input type="date" id="filterTanggalAkhir" class="modern-input px-4 py-2 focus:outline-none" placeholder="Tanggal Akhir">
                                <select id="filterNama" class="modern-input px-4 py-2 focus:outline-none">
                                    <option value="">Semua Petugas</option>
                                </select>
                                <button onclick="applyFilter()" class="btn-primary px-4 py-2 rounded-xl text-white font-semibold">
                                    <i class="fas fa-filter mr-2"></i>Filter
                                </button>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div id="summaryStats" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <!-- Stats akan dimuat di sini -->
                        </div>

                        <!-- Tabel Desktop -->
                        <div class="table-container">
                            <table class="modern-table desktop-table w-full border-collapse">
                                <thead>
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Tanggal</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Nama</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Shift</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Jam Masuk</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Jam Pulang</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Foto</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Keterlambatan</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Pulang Cepat</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Lembur</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Total Jam</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="rekapTableBody">
                                    <!-- Data akan dimuat di sini -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Cards Mobile -->
                        <div id="rekapMobileCards" class="mobile-card space-y-4">
                            <!-- Data akan dimuat di sini -->
                        </div>
                    </div>

                    <!-- Harian Tab -->
                    <div id="harianTabContent" class="tab-content hidden">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold gradient-text mb-4">Laporan Harian</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                                <input type="date" id="harianTanggal" class="modern-input px-4 py-2 focus:outline-none">
                                <select id="harianShift" class="modern-input px-4 py-2 focus:outline-none">
                                    <option value="">Semua Shift</option>
                                    <option value="Shift 1">Shift 1</option>
                                    <option value="Shift 2">Shift 2</option>
                                    <option value="Shift Piket">Shift Piket</option>
                                    <option value="Shift Piket Pagi">Shift Piket Pagi</option>
                                    <option value="Shift Piket Siang">Shift Piket Siang</option>
                                    <option value="Shift Kantor">Shift Kantor</option>
                                </select>
                                <button onclick="generateHarianReport()" class="btn-primary px-4 py-2 rounded-xl text-white font-semibold">
                                    <i class="fas fa-chart-line mr-2"></i>Generate Laporan
                                </button>
                            </div>
                        </div>
                        <div id="harianReportContent">
                            <!-- Laporan harian akan dimuat di sini -->
                        </div>
                    </div>

                    <!-- Bulanan Tab -->
                    <div id="bulananTabContent" class="tab-content hidden">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold gradient-text mb-4">Laporan Bulanan</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                                <input type="month" id="bulananPeriode" class="modern-input px-4 py-2 focus:outline-none">
                                <select id="bulananNama" class="modern-input px-4 py-2 focus:outline-none">
                                    <option value="">Semua Petugas</option>
                                </select>
                                <button onclick="generateBulananReport()" class="btn-primary px-4 py-2 rounded-xl text-white font-semibold">
                                    <i class="fas fa-calendar-check mr-2"></i>Generate Laporan
                                </button>
                            </div>
                        </div>
                        <div id="bulananReportContent">
                            <!-- Laporan bulanan akan dimuat di sini -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-card rounded-xl max-w-md w-full p-6">
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mr-3">
                    <i class="fas fa-edit text-white"></i>
                </div>
                <h3 class="text-xl font-bold gradient-text">Edit Absensi</h3>
            </div>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editId">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Jam Masuk</label>
                    <input type="time" id="editJamMasuk" class="modern-input w-full px-4 py-3 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Jam Pulang</label>
                    <input type="time" id="editJamPulang" class="modern-input w-full px-4 py-3 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Catatan</label>
                    <textarea id="editCatatan" rows="3" class="modern-input w-full px-4 py-3 focus:outline-none" placeholder="Catatan tambahan..."></textarea>
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="btn-primary flex-1 py-3 px-4 rounded-xl text-white font-semibold">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-4 rounded-xl hover:shadow-lg transition-all font-semibold">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="photo-modal hidden" onclick="closePhotoModal()">
        <img id="photoModalImage" src="" alt="Foto Absensi">
        <button onclick="closePhotoModal()" class="absolute top-4 right-4 bg-white text-gray-800 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-100">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="glass-card rounded-xl p-8 flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
            <span class="text-lg font-semibold gradient-text">Sinkronisasi Real-time...</span>
        </div>
    </div>

    <script>
        // Firebase Configuration - REAL PRODUCTION CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD26mSDHSGsjIMEAPtZgN-jd-ODViXe15E",
            authDomain: "absensi-ppsu-pisbar-f80f5.firebaseapp.com",
            databaseURL: "https://absensi-ppsu-pisbar-f80f5-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "absensi-ppsu-pisbar-f80f5",
            storageBucket: "absensi-ppsu-pisbar-f80f5.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:c3c57c5fba975ee8558b66"
        };

        // Initialize Firebase
        let isFirebaseEnabled = false;
        let db = null;
        let auth = null;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            isFirebaseEnabled = true;
            console.log('✅ Firebase initialized successfully with real config');
            
            // Enable offline persistence for better reliability
            db.enablePersistence().catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                } else if (err.code == 'unimplemented') {
                    console.log('The current browser does not support all of the features required to enable persistence');
                }
            });
            
            // Test Firestore connection
            db.collection('test').doc('connection').set({
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'connected'
            }).then(() => {
                console.log('✅ Firestore connection test successful');
                updateSyncIndicator('online');
            }).catch((error) => {
                console.error('❌ Firestore connection test failed:', error);
                updateSyncIndicator('offline');
            });
            
        } catch (error) {
            console.error('❌ Firebase initialization failed:', error);
            isFirebaseEnabled = false;
            updateSyncIndicator('offline');
        }

        // Admin credentials - EXACT MATCH
        const ADMIN_CREDENTIALS = {
            username: 'elfida',
            password: 'Pis212baru'
        };

        // Data petugas PPSU Pisangan Baru (43 petugas)
        const petugasList = [
            'Achmad Rosidi', 'Ade Kurniawan', 'Al Azahar', 'Alwi', 'Arif Abdul Rahman',
            'Asep', 'Chandra Darmawan', 'Daday Sukandar', 'Dea Sabilah Handriyani', 'Deni Arcis',
            'Dewo Panca Pamungkas', 'Dimas Herwinto Pradana', 'Eris Sumiadi', 'Fida Marzuki Putra', 'Herdinsah',
            'Hermansyah', 'Hikmatun Nisa', 'Ihsan Muttaqien', 'Ilham Prayitno Yudo', 'Indra Jaya',
            'Irfan Mahadi', 'M. Yusuf', 'Maryanto', 'Mohamad Irwan Yulianto', 'Muhammad Khomeini',
            'Nur Iman', 'Nuryana', 'Puji Lestari', 'Pujiyanto', 'Rafly Nugraha',
            'Rahman', 'Rahmat Agustio', 'Reynaldi Saputra', 'Rizky Prasetia', 'Rohmah',
            'Sabar Minggudi', 'Siti Marsah', 'Suhanda', 'Supardi', 'Suwandi',
            'Syaiful Huda', 'Tri Julianto', 'Wiyono Fauzy'
        ];

        // Enhanced shift schedule with precise minute calculations
        const shiftSchedule = {
            'Shift 1': { start: '05:00', end: '13:00', breakMinutes: 60, tolerance: 15 },
            'Shift 2': { start: '07:20', end: '15:20', breakMinutes: 60, tolerance: 15 },
            'Shift Piket': { start: '18:00', end: '06:00', breakMinutes: 60, overnight: true, tolerance: 30 },
            'Shift Piket Pagi': { start: '07:00', end: '12:00', breakMinutes: 30, tolerance: 15 },
            'Shift Piket Siang': { start: '12:00', end: '17:00', breakMinutes: 30, tolerance: 15 },
            'Shift Kantor': { start: '07:00', end: '17:00', breakMinutes: 60, tolerance: 15 }
        };

        // Global variables
        let absensiData = [];
        let currentEditId = null;
        let isLoading = false;
        let currentStream = null;
        let currentCameraType = null;
        let autoJamMasuk = null;
        let autoJamPulang = null;
        let syncStatus = 'online';
        let isLoggedIn = false;
        let realtimeListener = null;

        // Enhanced Firebase real-time functions
        async function saveToFirestore(data) {
            if (!isFirebaseEnabled) {
                console.log('Firebase not available, using localStorage');
                const existingData = JSON.parse(localStorage.getItem('absensiPPSUData')) || [];
                const existingIndex = existingData.findIndex(item => item.id === data.id);
                
                if (existingIndex !== -1) {
                    existingData[existingIndex] = data;
                } else {
                    existingData.unshift(data);
                }
                
                localStorage.setItem('absensiPPSUData', JSON.stringify(existingData));
                return data;
            }

            try {
                updateSyncIndicator('syncing');
                
                // Add server timestamp
                const dataWithTimestamp = {
                    ...data,
                    serverTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: new Date().toISOString()
                };
                
                await db.collection('absensi').doc(data.id).set(dataWithTimestamp, { merge: true });
                console.log('✅ Data saved to Firestore:', data.id);
                
                updateSyncIndicator('online');
                return data;
            } catch (error) {
                console.error('❌ Error saving to Firestore:', error);
                updateSyncIndicator('offline');
                
                // Fallback to localStorage
                const existingData = JSON.parse(localStorage.getItem('absensiPPSUData')) || [];
                const existingIndex = existingData.findIndex(item => item.id === data.id);
                
                if (existingIndex !== -1) {
                    existingData[existingIndex] = data;
                } else {
                    existingData.unshift(data);
                }
                
                localStorage.setItem('absensiPPSUData', JSON.stringify(existingData));
                throw error;
            }
        }

        async function loadFromFirestore() {
            if (!isFirebaseEnabled) {
                console.log('Firebase not available, loading from localStorage');
                return JSON.parse(localStorage.getItem('absensiPPSUData')) || [];
            }

            try {
                updateSyncIndicator('syncing');
                
                const snapshot = await db.collection('absensi')
                    .orderBy('timestamp', 'desc')
                    .limit(1000) // Limit for performance
                    .get();
                
                const data = [];
                snapshot.forEach(doc => {
                    const docData = doc.data();
                    data.push({ 
                        id: doc.id, 
                        ...docData,
                        // Convert Firestore timestamp to ISO string if needed
                        timestamp: docData.timestamp || new Date().toISOString()
                    });
                });
                
                console.log(`✅ Loaded ${data.length} records from Firestore`);
                updateSyncIndicator('online');
                
                // Also save to localStorage as backup
                localStorage.setItem('absensiPPSUData', JSON.stringify(data));
                
                return data;
            } catch (error) {
                console.error('❌ Error loading from Firestore:', error);
                updateSyncIndicator('offline');
                
                // Fallback to localStorage
                return JSON.parse(localStorage.getItem('absensiPPSUData')) || [];
            }
        }

        async function deleteFromFirestore(id) {
            if (!isFirebaseEnabled) {
                const existingData = JSON.parse(localStorage.getItem('absensiPPSUData')) || [];
                const filteredData = existingData.filter(item => item.id !== id);
                localStorage.setItem('absensiPPSUData', JSON.stringify(filteredData));
                return;
            }

            try {
                updateSyncIndicator('syncing');
                await db.collection('absensi').doc(id).delete();
                console.log('✅ Data deleted from Firestore:', id);
                updateSyncIndicator('online');
            } catch (error) {
                console.error('❌ Error deleting from Firestore:', error);
                updateSyncIndicator('offline');
                throw error;
            }
        }

        function startRealtimeListener() {
            if (!isFirebaseEnabled) {
                console.log('Firebase not available, real-time sync disabled');
                return;
            }

            if (realtimeListener) {
                realtimeListener();
            }

            console.log('🔄 Starting real-time listener...');
            
            realtimeListener = db.collection('absensi')
                .orderBy('timestamp', 'desc')
                .limit(100) // Limit for performance
                .onSnapshot((snapshot) => {
                    updateSyncIndicator('syncing');
                    
                    snapshot.docChanges().forEach((change) => {
                        const docData = change.doc.data();
                        const newData = { 
                            id: change.doc.id, 
                            ...docData,
                            timestamp: docData.timestamp || new Date().toISOString()
                        };
                        
                        if (change.type === 'added') {
                            const existingIndex = absensiData.findIndex(item => item.id === newData.id);
                            if (existingIndex === -1) {
                                absensiData.unshift(newData);
                                console.log('➕ Real-time: Data added', newData.nama);
                                showNotification('Data Baru!', `${newData.nama} baru saja absen`, 'fa-user-plus');
                            }
                        }
                        
                        if (change.type === 'modified') {
                            const existingIndex = absensiData.findIndex(item => item.id === newData.id);
                            if (existingIndex !== -1) {
                                absensiData[existingIndex] = newData;
                                console.log('✏️ Real-time: Data modified', newData.nama);
                                showNotification('Data Diperbarui!', `Absensi ${newData.nama} telah diupdate`, 'fa-sync-alt');
                            }
                        }
                        
                        if (change.type === 'removed') {
                            absensiData = absensiData.filter(item => item.id !== change.doc.id);
                            console.log('🗑️ Real-time: Data removed', change.doc.id);
                            showNotification('Data Dihapus!', 'Data absensi telah dihapus', 'fa-trash');
                        }
                    });
                    
                    // Update localStorage backup
                    localStorage.setItem('absensiPPSUData', JSON.stringify(absensiData));
                    
                    // Update UI
                    loadAbsensiHariIni();
                    updateStats();
                    if (isLoggedIn && !document.getElementById('adminPage').classList.contains('hidden')) {
                        loadRekapData();
                        updateSummaryStats();
                    }
                    
                    updateSyncIndicator('online');
                }, (error) => {
                    console.error('❌ Real-time listener error:', error);
                    updateSyncIndicator('offline');
                });
        }

        // Enhanced calculation functions with precise minute calculations
        function timeToMinutes(timeString) {
            if (!timeString) return 0;
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function minutesToHoursText(minutes) {
            if (minutes <= 0) return '-';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            if (hours === 0) return `${mins} menit`;
            if (mins === 0) return `${hours} jam`;
            return `${hours} jam ${mins} menit`;
        }

        function calculateWorkStatsDetailed(jamMasuk, jamPulang, shift) {
            if (!jamMasuk || !jamPulang) {
                return {
                    totalJam: '-',
                    totalMenit: 0,
                    keterlambatan: '-',
                    keterlambatanMenit: 0,
                    pulangCepat: '-',
                    pulangCepatMenit: 0,
                    lembur: '-',
                    lemburMenit: 0,
                    jamKerjaNormal: '-',
                    efisiensi: '-'
                };
            }

            const schedule = shiftSchedule[shift];
            if (!schedule) {
                const masukMenit = timeToMinutes(jamMasuk);
                const pulangMenit = timeToMinutes(jamPulang);
                let totalMenit = pulangMenit - masukMenit;
                
                if (totalMenit < 0) totalMenit += 24 * 60; // Handle overnight
                totalMenit = Math.max(0, totalMenit - 60); // Default 1 hour break
                
                return {
                    totalJam: minutesToHoursText(totalMenit),
                    totalMenit: totalMenit,
                    keterlambatan: '-',
                    keterlambatanMenit: 0,
                    pulangCepat: '-',
                    pulangCepatMenit: 0,
                    lembur: '-',
                    lemburMenit: 0,
                    jamKerjaNormal: minutesToHoursText(totalMenit),
                    efisiensi: '100%'
                };
            }

            const masukMenit = timeToMinutes(jamMasuk);
            const pulangMenit = timeToMinutes(jamPulang);
            const jadwalMasukMenit = timeToMinutes(schedule.start);
            const jadwalPulangMenit = timeToMinutes(schedule.end);

            // Handle overnight shifts
            let actualPulangMenit = pulangMenit;
            let actualJadwalPulangMenit = jadwalPulangMenit;
            
            if (schedule.overnight) {
                if (pulangMenit < masukMenit) {
                    actualPulangMenit = pulangMenit + (24 * 60);
                }
                if (jadwalPulangMenit < jadwalMasukMenit) {
                    actualJadwalPulangMenit = jadwalPulangMenit + (24 * 60);
                }
            }

            // Calculate total work minutes (minus break)
            let totalMenit = actualPulangMenit - masukMenit - schedule.breakMinutes;
            totalMenit = Math.max(0, totalMenit);

            // Calculate lateness (with tolerance)
            const keterlambatanMenit = Math.max(0, masukMenit - jadwalMasukMenit - (schedule.tolerance || 0));

            // Calculate early departure
            const pulangCepatMenit = Math.max(0, actualJadwalPulangMenit - actualPulangMenit);

            // Calculate overtime
            const lemburMenit = Math.max(0, actualPulangMenit - actualJadwalPulangMenit);

            // Calculate normal work hours (scheduled hours minus break)
            const jadwalKerjaMenit = actualJadwalPulangMenit - jadwalMasukMenit - schedule.breakMinutes;
            
            // Calculate efficiency
            const efisiensi = jadwalKerjaMenit > 0 ? Math.min(100, (totalMenit / jadwalKerjaMenit) * 100) : 100;

            return {
                totalJam: minutesToHoursText(totalMenit),
                totalMenit: totalMenit,
                keterlambatan: keterlambatanMenit > 0 ? minutesToHoursText(keterlambatanMenit) : '-',
                keterlambatanMenit: keterlambatanMenit,
                pulangCepat: pulangCepatMenit > 0 ? minutesToHoursText(pulangCepatMenit) : '-',
                pulangCepatMenit: pulangCepatMenit,
                lembur: lemburMenit > 0 ? minutesToHoursText(lemburMenit) : '-',
                lemburMenit: lemburMenit,
                jamKerjaNormal: minutesToHoursText(jadwalKerjaMenit),
                efisiensi: `${Math.round(efisiensi)}%`
            };
        }

        // Backward compatibility function
        function calculateWorkStats(jamMasuk, jamPulang, shift) {
            const detailed = calculateWorkStatsDetailed(jamMasuk, jamPulang, shift);
            return {
                totalJam: detailed.totalJam,
                keterlambatan: detailed.keterlambatan,
                pulangCepat: detailed.pulangCepat,
                lembur: detailed.lembur
            };
        }

        // Authentication functions
        function showAdminLogin() {
            if (isLoggedIn) {
                showPage('admin');
            } else {
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginPage').classList.remove('hidden');
            }
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            showPage('home');
        }

        function logout() {
            isLoggedIn = false;
            document.getElementById('logoutBtn').classList.add('hidden');
            showNotification('Logout Berhasil', 'Anda telah keluar dari sistem admin', 'fa-sign-out-alt');
            showPage('home');
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            console.log('Login attempt:', { username, password: '***' });
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                isLoggedIn = true;
                document.getElementById('logoutBtn').classList.remove('hidden');
                showMainApp();
                showPage('admin');
                showNotification('Login Berhasil!', 'Selamat datang di panel admin', 'fa-user-shield');
                
                // Clear form
                this.reset();
                console.log('✅ Login successful');
            } else {
                console.log('❌ Login failed - invalid credentials');
                alert('Username atau password salah!\n\nUsername: elfida\nPassword: Pis212baru');
                showNotification('Login Gagal', 'Username atau password tidak valid', 'fa-exclamation-triangle');
            }
        });

        // Real-time sync functions
        function updateSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            const iconClass = status === 'online' ? 'fa-wifi' : status === 'syncing' ? 'fa-sync-alt fa-spin' : 'fa-wifi-slash';
            const text = status === 'online' ? 'Tersinkron Real-time' : status === 'syncing' ? 'Sinkronisasi...' : 'Mode Offline';
            
            indicator.className = `sync-indicator sync-${status}`;
            indicator.innerHTML = `<i class="fas ${iconClass} mr-2"></i>${text}`;
            syncStatus = status;
        }

        function showNotification(title, message, icon = 'fa-info-circle', duration = 3000) {
            const toast = document.getElementById('notificationToast');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const iconEl = document.getElementById('notificationIcon');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            iconEl.innerHTML = `<i class="fas ${icon} text-blue-500"></i>`;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Compress image function
        function compressImage(canvas, quality = 0.6, maxWidth = 400) {
            const ctx = canvas.getContext('2d');
            const originalWidth = canvas.width;
            const originalHeight = canvas.height;
            
            // Calculate new dimensions
            let newWidth = originalWidth;
            let newHeight = originalHeight;
            
            if (originalWidth > maxWidth) {
                newWidth = maxWidth;
                newHeight = (originalHeight * maxWidth) / originalWidth;
            }
            
            // Create new canvas with compressed size
            const compressedCanvas = document.createElement('canvas');
            compressedCanvas.width = newWidth;
            compressedCanvas.height = newHeight;
            
            const compressedCtx = compressedCanvas.getContext('2d');
            compressedCtx.drawImage(canvas, 0, 0, newWidth, newHeight);
            
            return compressedCanvas.toDataURL('image/jpeg', quality);
        }

        // Start camera with auto time capture
        async function startCamera(type) {
            try {
                updateSyncIndicator('syncing');
                
                // Stop previous camera
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });

                currentStream = stream;
                currentCameraType = type;

                const video = document.getElementById('video' + (type === 'masuk' ? 'Masuk' : 'Pulang'));
                const preview = document.getElementById('foto' + (type === 'masuk' ? 'Masuk' : 'Pulang') + 'Preview');

                video.srcObject = stream;
                video.play();

                // Hide preview and show video
                preview.classList.add('hidden');
                video.classList.remove('hidden');

                // Add capture button
                const captureButton = document.createElement('button');
                captureButton.type = 'button';
                captureButton.className = 'absolute bottom-2 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-full hover:bg-red-600 transition-colors z-10';
                captureButton.innerHTML = '<i class="fas fa-camera mr-2"></i>Ambil Foto & Waktu';
                captureButton.onclick = () => capturePhotoWithTime(type);

                const container = video.parentElement;
                container.style.position = 'relative';
                container.appendChild(captureButton);

                updateSyncIndicator('online');

            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Tidak dapat mengakses kamera. Pastikan browser memiliki izin kamera.');
                updateSyncIndicator('offline');
            }
        }

        // Capture photo with automatic time
        function capturePhotoWithTime(type) {
            const video = document.getElementById('video' + (type === 'masuk' ? 'Masuk' : 'Pulang'));
            const canvas = document.getElementById('canvas' + (type === 'masuk' ? 'Masuk' : 'Pulang'));
            const preview = document.getElementById('foto' + (type === 'masuk' ? 'Masuk' : 'Pulang') + 'Preview');

            // Set canvas size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Compress image
            const photoData = compressImage(canvas, 0.7, 400);

            // Auto capture time with precise formatting
            const now = new Date();
            const currentTime = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });

            if (type === 'masuk') {
                autoJamMasuk = currentTime;
                document.getElementById('jamMasukValue').textContent = currentTime;
                document.getElementById('jamMasukDisplay').classList.remove('hidden');
                showNotification('Foto Masuk Tersimpan!', `Jam masuk otomatis: ${currentTime}`, 'fa-camera', 2000);
            } else {
                autoJamPulang = currentTime;
                document.getElementById('jamPulangValue').textContent = currentTime;
                document.getElementById('jamPulangDisplay').classList.remove('hidden');
                showNotification('Foto Pulang Tersimpan!', `Jam pulang otomatis: ${currentTime}`, 'fa-camera', 2000);
            }

            // Show auto time display
            document.getElementById('autoTimeDisplay').classList.remove('hidden');

            // Display captured photo
            preview.innerHTML = `
                <img src="${photoData}" class="captured-photo" alt="Foto ${type}">
                <div class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer text-xs" onclick="removePhoto('${type}')">
                    <i class="fas fa-times"></i>
                </div>
                <div class="absolute bottom-2 left-2 bg-green-500 text-white px-2 py-1 rounded text-xs">
                    <i class="fas fa-check mr-1"></i>${currentTime}
                </div>
            `;

            // Stop camera and hide video
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }

            video.classList.add('hidden');
            preview.classList.remove('hidden');

            // Remove capture button
            const captureButton = video.parentElement.querySelector('button');
            if (captureButton) {
                captureButton.remove();
            }
        }

        // Remove photo and reset time
        function removePhoto(type) {
            const preview = document.getElementById('foto' + (type === 'masuk' ? 'Masuk' : 'Pulang') + 'Preview');
            const video = document.getElementById('video' + (type === 'masuk' ? 'Masuk' : 'Pulang'));
            
            // Stop camera if active
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // Hide video and show preview
            video.classList.add('hidden');
            preview.classList.remove('hidden');
            
            // Reset auto time
            if (type === 'masuk') {
                autoJamMasuk = null;
                document.getElementById('jamMasukDisplay').classList.add('hidden');
            } else {
                autoJamPulang = null;
                document.getElementById('jamPulangDisplay').classList.add('hidden');
            }

            // Check if both times are null to hide display
            if (!autoJamMasuk && !autoJamPulang) {
                document.getElementById('autoTimeDisplay').classList.add('hidden');
            }
            
            // Reset preview
            preview.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-500 text-sm">Klik untuk ambil foto</p>
                    <p class="text-${type === 'masuk' ? 'red' : 'orange'}-500 text-xs mt-1">Jam ${type} otomatis</p>
                </div>
            `;
            
            // Remove capture button if exists
            const captureButton = video.parentElement.querySelector('button');
            if (captureButton) {
                captureButton.remove();
            }

            showNotification('Foto Dihapus', `Foto ${type} dan waktu otomatis telah dihapus`, 'fa-trash', 2000);
        }

        // Enhanced form submission with Firebase integration
        document.getElementById('absensiForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            const nama = document.getElementById('namaPetugas').value;
            const shift = document.getElementById('shift').value;
            const fotoMasuk = document.querySelector('#fotoMasukPreview img')?.src || '';
            const fotoPulang = document.querySelector('#fotoPulangPreview img')?.src || '';
            const catatan = document.getElementById('catatan').value;

            // Enhanced validation
            if (!nama || !shift) {
                alert('Mohon lengkapi nama petugas dan shift!');
                return;
            }

            // Check existing attendance
            const today = new Date().toISOString().split('T')[0];
            const existingAbsensi = absensiData.find(item => 
                item.nama === nama && 
                item.tanggal === today
            );

            // Validation for new attendance (masuk)
            if (!existingAbsensi) {
                if (!fotoMasuk || !autoJamMasuk) {
                    alert('Foto absen masuk WAJIB diambil untuk absensi baru!');
                    return;
                }
            }

            // Validation for pulang
            if (fotoPulang && !autoJamPulang) {
                alert('Jika mengambil foto pulang, jam pulang otomatis harus terisi!');
                return;
            }

            if (autoJamPulang && !fotoPulang) {
                alert('Foto absen pulang WAJIB jika jam pulang diisi!');
                return;
            }

            updateSyncIndicator('syncing');
            showLoading(true);

            // Prepare form data with enhanced metadata
            const formData = {
                id: existingAbsensi ? existingAbsensi.id : `${Date.now()}_${nama.replace(/\s+/g, '_')}`,
                tanggal: today,
                nama: nama,
                shift: shift,
                jamMasuk: existingAbsensi ? (existingAbsensi.jamMasuk || autoJamMasuk) : autoJamMasuk,
                jamPulang: autoJamPulang || existingAbsensi?.jamPulang || '',
                fotoMasuk: fotoMasuk || existingAbsensi?.fotoMasuk || '',
                fotoPulang: fotoPulang || existingAbsensi?.fotoPulang || '',
                catatan: catatan,
                timestamp: existingAbsensi ? existingAbsensi.timestamp : new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                version: (existingAbsensi?.version || 0) + 1,
                source: 'web_app'
            };

            try {
                await saveToFirestore(formData);
                
                if (existingAbsensi) {
                    // Update existing data in local array
                    const index = absensiData.findIndex(item => item.id === existingAbsensi.id);
                    if (index !== -1) {
                        absensiData[index] = formData;
                    }
                    showNotification('Data Diperbarui!', `Absensi ${nama} berhasil diupdate`, 'fa-sync-alt');
                } else {
                    // Add new data to local array
                    absensiData.unshift(formData);
                    showNotification('Absensi Tersimpan!', `${nama} berhasil absen masuk`, 'fa-user-check');
                }

                // Reset form
                this.reset();
                resetPhotoPreview();
                
                showLoading(false);
                updateSyncIndicator('online');
                
                // Update UI with real-time effect
                loadAbsensiHariIni();
                updateStats();
                
                // Show success notification
                const message = existingAbsensi ? 'Data absensi berhasil diperbarui dan tersinkron!' : 'Absensi berhasil disimpan dan tersinkron!';
                setTimeout(() => alert(message), 500);
                
                console.log('✅ Form submitted successfully:', formData.id);
                
            } catch (error) {
                console.error('❌ Error saving attendance:', error);
                showLoading(false);
                updateSyncIndicator('offline');
                alert('Terjadi kesalahan saat menyimpan data. Data disimpan secara lokal dan akan disinkron otomatis.');
            }
        });

        // Reset photo preview and auto times
        function resetPhotoPreview() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // Reset auto times
            autoJamMasuk = null;
            autoJamPulang = null;
            document.getElementById('autoTimeDisplay').classList.add('hidden');
            document.getElementById('jamMasukDisplay').classList.add('hidden');
            document.getElementById('jamPulangDisplay').classList.add('hidden');
            
            ['fotoMasukPreview', 'fotoPulangPreview'].forEach((id, index) => {
                const preview = document.getElementById(id);
                const type = index === 0 ? 'masuk' : 'pulang';
                const videoId = id.replace('Preview', '').replace('foto', 'video');
                const video = document.getElementById(videoId);
                
                if (video) {
                    video.classList.add('hidden');
                }
                preview.classList.remove('hidden');
                preview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500 text-sm">Klik untuk ambil foto</p>
                        <p class="text-${type === 'masuk' ? 'red' : 'orange'}-500 text-xs mt-1">Jam ${type} otomatis</p>
                    </div>
                `;
                
                const captureButton = preview.parentElement.querySelector('button');
                if (captureButton) {
                    captureButton.remove();
                }
            });
        }

        // Enhanced load absensi hari ini with real-time indicators
        function loadAbsensiHariIni() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = absensiData.filter(item => item.tanggal === today);
            
            // Sort by timestamp (newest first)
            todayData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const container = document.getElementById('absensiHariIni');
            
            if (todayData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Belum ada absensi hari ini</p>
                        <p class="text-xs text-gray-400 mt-2">Data akan muncul secara real-time</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = todayData.map(item => {
                const stats = calculateWorkStats(item.jamMasuk, item.jamPulang, item.shift);
                const status = getAttendanceStatus(item.jamMasuk, item.jamPulang, item.shift);
                const timeAgo = getTimeAgo(item.timestamp);
                
                let cardClass = 'attendance-card';
                if (item.jamMasuk && item.jamPulang) {
                    cardClass += ' hadir';
                } else if (item.jamMasuk && !item.jamPulang) {
                    cardClass += ' belum-pulang';
                } else {
                    cardClass += ' terlambat';
                }
                
                return `
                    <div class="${cardClass} border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">${item.nama}</h3>
                                <p class="text-sm text-gray-600">${item.shift}</p>
                                <p class="text-xs text-blue-500 mt-1">
                                    <i class="fas fa-clock mr-1"></i>${timeAgo}
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${item.fotoMasuk ? `<img src="${item.fotoMasuk}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoMasuk}')" title="Foto Masuk">` : ''}
                                ${item.fotoPulang ? `<img src="${item.fotoPulang}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoPulang}')" title="Foto Pulang">` : ''}
                                <span class="status-badge ${status.class}">${status.text}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Masuk:</span>
                                <span class="font-medium ml-2">${item.jamMasuk || '-'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Pulang:</span>
                                <span class="font-medium ml-2">${item.jamPulang || '-'}</span>
                            </div>
                        </div>
                        ${stats.totalJam !== '-' ? `
                            <div class="mt-2 text-sm">
                                <span class="text-gray-600">Total Jam:</span>
                                <span class="font-medium ml-2 text-blue-600">${stats.totalJam}</span>
                            </div>
                        ` : ''}
                        ${item.catatan ? `<p class="text-sm text-gray-600 mt-2 italic">"${item.catatan}"</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Get time ago helper
        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInMinutes = Math.floor((now - time) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Baru saja';
            if (diffInMinutes < 60) return `${diffInMinutes} menit lalu`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} jam lalu`;
            
            return time.toLocaleDateString('id-ID');
        }

        // Get attendance status
        function getAttendanceStatus(jamMasuk, jamPulang, shift) {
            if (!jamMasuk) return { text: 'Belum Absen', class: 'status-badge bg-gray-100 text-gray-600' };
            
            if (!jamPulang) return { text: 'Belum Pulang', class: 'status-belum-pulang' };
            
            const stats = calculateWorkStatsDetailed(jamMasuk, jamPulang, shift);
            
            if (stats.keterlambatanMenit > 0) {
                return { text: 'Terlambat', class: 'status-terlambat' };
            }
            
            if (stats.lemburMenit > 0) {
                return { text: 'Lembur', class: 'status-lembur' };
            }
            
            return { text: 'Hadir', class: 'status-hadir' };
        }

        // Enhanced update stats with real-time counters
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = absensiData.filter(item => item.tanggal === today);
            
            let hadir = 0, terlambat = 0, belumPulang = 0;
            
            todayData.forEach(item => {
                if (item.jamMasuk) hadir++;
                if (item.jamMasuk && !item.jamPulang) belumPulang++;
                
                const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                if (stats.keterlambatanMenit > 0) terlambat++;
            });
            
            // Animate counter updates
            animateCounter('hadirHariIni', hadir);
            animateCounter('terlambatHariIni', terlambat);
            animateCounter('belumPulangHariIni', belumPulang);
        }

        // Animate counter function
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            
            if (currentValue === targetValue) return;
            
            const increment = targetValue > currentValue ? 1 : -1;
            const duration = 500;
            const steps = Math.abs(targetValue - currentValue);
            const stepDuration = duration / steps;
            
            let current = currentValue;
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                
                if (current === targetValue) {
                    clearInterval(timer);
                }
            }, stepDuration);
        }

        // Enhanced load rekap data with real-time updates
        function loadRekapData() {
            const tableBody = document.getElementById('rekapTableBody');
            const mobileCards = document.getElementById('rekapMobileCards');
            
            if (absensiData.length === 0) {
                const emptyMessage = `
                    <div class="text-center py-8">
                        <i class="fas fa-chart-line text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">Belum ada data absensi</p>
                        <p class="text-xs text-gray-400 mt-2">Data akan muncul secara real-time</p>
                    </div>
                `;
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-gray-500">Belum ada data absensi</td></tr>';
                mobileCards.innerHTML = emptyMessage;
                return;
            }

            // Sort data by timestamp (newest first)
            const sortedData = [...absensiData].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Desktop table
            tableBody.innerHTML = sortedData.map(item => {
                const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                const displayDate = new Date(item.tanggal).toLocaleDateString('id-ID');
                const timeAgo = getTimeAgo(item.timestamp);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 text-sm">
                            ${displayDate}
                            <div class="text-xs text-blue-500">${timeAgo}</div>
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-sm font-medium">${item.nama}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm">${item.shift}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm">${item.jamMasuk || '-'}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm">${item.jamPulang || '-'}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            <div class="flex gap-1 justify-center">
                                ${item.fotoMasuk ? `<img src="${item.fotoMasuk}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoMasuk}')" title="Foto Masuk">` : '<span class="text-gray-400 text-xs">-</span>'}
                                ${item.fotoPulang ? `<img src="${item.fotoPulang}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoPulang}')" title="Foto Pulang">` : ''}
                            </div>
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-sm ${stats.keterlambatanMenit > 0 ? 'text-red-600 font-semibold' : ''}">${stats.keterlambatan}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm ${stats.pulangCepatMenit > 0 ? 'text-orange-600 font-semibold' : ''}">${stats.pulangCepat}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm ${stats.lemburMenit > 0 ? 'text-purple-600 font-semibold' : ''}">${stats.lembur}</td>
                        <td class="border border-gray-300 px-4 py-3 text-sm font-semibold text-blue-600">${stats.totalJam}</td>
                        <td class="border border-gray-300 px-4 py-3">
                            <div class="flex gap-1">
                                <button onclick="editAbsensi('${item.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteAbsensi('${item.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Mobile cards
            mobileCards.innerHTML = sortedData.map(item => {
                const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                const displayDate = new Date(item.tanggal).toLocaleDateString('id-ID');
                const timeAgo = getTimeAgo(item.timestamp);
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 bg-white">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-semibold text-gray-800">${item.nama}</h3>
                                <p class="text-sm text-gray-600">${displayDate} - ${item.shift}</p>
                                <p class="text-xs text-blue-500">${timeAgo}</p>
                            </div>
                            <div class="flex gap-2">
                                ${item.fotoMasuk ? `<img src="${item.fotoMasuk}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoMasuk}')" title="Foto Masuk">` : ''}
                                ${item.fotoPulang ? `<img src="${item.fotoPulang}" class="photo-thumbnail" onclick="showPhotoModal('${item.fotoPulang}')" title="Foto Pulang">` : ''}
                                <button onclick="editAbsensi('${item.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteAbsensi('${item.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div><span class="text-gray-600">Masuk:</span> <span class="font-medium">${item.jamMasuk || '-'}</span></div>
                            <div><span class="text-gray-600">Pulang:</span> <span class="font-medium">${item.jamPulang || '-'}</span></div>
                            <div><span class="text-gray-600">Total:</span> <span class="font-medium text-blue-600">${stats.totalJam}</span></div>
                            <div><span class="text-gray-600">Terlambat:</span> <span class="font-medium ${stats.keterlambatanMenit > 0 ? 'text-red-600' : ''}">${stats.keterlambatan}</span></div>
                            <div><span class="text-gray-600">Pulang Cepat:</span> <span class="font-medium ${stats.pulangCepatMenit > 0 ? 'text-orange-600' : ''}">${stats.pulangCepat}</span></div>
                            <div><span class="text-gray-600">Lembur:</span> <span class="font-medium ${stats.lemburMenit > 0 ? 'text-purple-600' : ''}">${stats.lembur}</span></div>
                        </div>
                        ${item.catatan ? `<p class="text-sm text-gray-600 mt-2"><span class="font-medium">Catatan:</span> ${item.catatan}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Update summary stats with animations
        function updateSummaryStats() {
            const container = document.getElementById('summaryStats');
            
            let totalHadir = 0, totalTerlambat = 0, totalLembur = 0, totalJamKerja = 0;
            
            absensiData.forEach(item => {
                if (item.jamMasuk) totalHadir++;
                
                const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                if (stats.keterlambatanMenit > 0) totalTerlambat++;
                if (stats.lemburMenit > 0) totalLembur++;
                if (stats.totalMenit > 0) totalJamKerja += stats.totalMenit;
            });
            
            container.innerHTML = `
                <div class="bg-green-50 rounded-lg p-4 stats-card">
                    <div class="flex items-center">
                        <i class="fas fa-user-check text-green-600 text-xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Total Kehadiran</p>
                            <p class="text-xl font-bold text-gray-800" id="totalHadirStat">${totalHadir}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 stats-card">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-yellow-600 text-xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Total Terlambat</p>
                            <p class="text-xl font-bold text-gray-800" id="totalTerlambatStat">${totalTerlambat}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 rounded-lg p-4 stats-card">
                    <div class="flex items-center">
                        <i class="fas fa-business-time text-blue-600 text-xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Total Lembur</p>
                            <p class="text-xl font-bold text-gray-800" id="totalLemburStat">${totalLembur}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 stats-card">
                    <div class="flex items-center">
                        <i class="fas fa-hourglass-half text-purple-600 text-xl mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-600">Total Jam Kerja</p>
                            <p class="text-xl font-bold text-gray-800" id="totalJamStat">${minutesToHoursText(totalJamKerja)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Admin tab functions
        function showAdminTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(tabName + 'TabContent').classList.remove('hidden');
            
            // Load specific content
            if (tabName === 'rekap') {
                loadRekapData();
                updateSummaryStats();
            } else if (tabName === 'harian') {
                // Set default date to today
                document.getElementById('harianTanggal').value = new Date().toISOString().split('T')[0];
            } else if (tabName === 'bulanan') {
                // Set default month to current month
                const now = new Date();
                document.getElementById('bulananPeriode').value = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            }
        }

        // Generate daily report
        function generateHarianReport() {
            const tanggal = document.getElementById('harianTanggal').value;
            const shift = document.getElementById('harianShift').value;
            
            if (!tanggal) {
                alert('Pilih tanggal terlebih dahulu!');
                return;
            }
            
            updateSyncIndicator('syncing');
            
            let filteredData = absensiData.filter(item => item.tanggal === tanggal);
            if (shift) {
                filteredData = filteredData.filter(item => item.shift === shift);
            }
            
            setTimeout(() => {
                const container = document.getElementById('harianReportContent');
                
                if (filteredData.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Tidak ada data untuk tanggal dan shift yang dipilih</p>
                        </div>
                    `;
                    updateSyncIndicator('online');
                    return;
                }
                
                // Calculate statistics
                let totalHadir = 0, totalTerlambat = 0, totalLembur = 0, totalJamKerja = 0;
                let totalKeterlambatanMenit = 0, totalLemburMenit = 0;
                
                filteredData.forEach(item => {
                    if (item.jamMasuk) totalHadir++;
                    
                    const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                    if (stats.keterlambatanMenit > 0) {
                        totalTerlambat++;
                        totalKeterlambatanMenit += stats.keterlambatanMenit;
                    }
                    if (stats.lemburMenit > 0) {
                        totalLembur++;
                        totalLemburMenit += stats.lemburMenit;
                    }
                    if (stats.totalMenit > 0) {
                        totalJamKerja += stats.totalMenit;
                    }
                });
                
                const displayDate = new Date(tanggal).toLocaleDateString('id-ID', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                container.innerHTML = `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">Laporan Harian - ${displayDate}${shift ? ` (${shift})` : ''}</h4>
                        
                        <!-- Summary Cards -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-green-50 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i class="fas fa-user-check text-green-600 text-xl mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-600">Total Hadir</p>
                                        <p class="text-2xl font-bold text-gray-800">${totalHadir}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-red-50 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i class="fas fa-clock text-red-600 text-xl mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-600">Terlambat</p>
                                        <p class="text-2xl font-bold text-gray-800">${totalTerlambat}</p>
                                        <p class="text-xs text-red-600">${minutesToHoursText(totalKeterlambatanMenit)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i class="fas fa-business-time text-purple-600 text-xl mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-600">Lembur</p>
                                        <p class="text-2xl font-bold text-gray-800">${totalLembur}</p>
                                        <p class="text-xs text-purple-600">${minutesToHoursText(totalLemburMenit)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i class="fas fa-hourglass-half text-blue-600 text-xl mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-600">Total Jam Kerja</p>
                                        <p class="text-2xl font-bold text-gray-800">${Math.floor(totalJamKerja / 60)}</p>
                                        <p class="text-xs text-blue-600">${minutesToHoursText(totalJamKerja)}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detail Table -->
                        <div class="bg-white rounded-lg overflow-hidden shadow">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Nama</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Shift</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Jam Masuk</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Jam Pulang</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Total Jam</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Keterlambatan</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Lembur</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${filteredData.map(item => {
                                        const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                                        return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 text-sm font-medium text-gray-800">${item.nama}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">${item.shift}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">${item.jamMasuk || '-'}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">${item.jamPulang || '-'}</td>
                                                <td class="px-4 py-3 text-sm font-semibold text-blue-600">${stats.totalJam}</td>
                                                <td class="px-4 py-3 text-sm ${stats.keterlambatanMenit > 0 ? 'text-red-600 font-semibold' : 'text-gray-600'}">${stats.keterlambatan}</td>
                                                <td class="px-4 py-3 text-sm ${stats.lemburMenit > 0 ? 'text-purple-600 font-semibold' : 'text-gray-600'}">${stats.lembur}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                updateSyncIndicator('online');
                showNotification('Laporan Harian', `Berhasil generate laporan untuk ${filteredData.length} data`, 'fa-chart-line');
            }, 1000);
        }

        // Generate monthly report
        function generateBulananReport() {
            const periode = document.getElementById('bulananPeriode').value;
            const nama = document.getElementById('bulananNama').value;
            
            if (!periode) {
                alert('Pilih periode bulan terlebih dahulu!');
                return;
            }
            
            updateSyncIndicator('syncing');
            
            const [year, month] = periode.split('-');
            let filteredData = absensiData.filter(item => {
                const itemDate = new Date(item.tanggal);
                return itemDate.getFullYear() == year && (itemDate.getMonth() + 1) == month;
            });
            
            if (nama) {
                filteredData = filteredData.filter(item => item.nama === nama);
            }
            
            setTimeout(() => {
                const container = document.getElementById('bulananReportContent');
                
                if (filteredData.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Tidak ada data untuk periode yang dipilih</p>
                        </div>
                    `;
                    updateSyncIndicator('online');
                    return;
                }
                
                // Group by employee
                const groupedData = {};
                filteredData.forEach(item => {
                    if (!groupedData[item.nama]) {
                        groupedData[item.nama] = [];
                    }
                    groupedData[item.nama].push(item);
                });
                
                // Calculate monthly statistics
                const monthlyStats = {};
                Object.keys(groupedData).forEach(employeeName => {
                    const employeeData = groupedData[employeeName];
                    let totalHadir = 0, totalTerlambat = 0, totalLembur = 0, totalJamKerja = 0;
                    let totalKeterlambatanMenit = 0, totalLemburMenit = 0;
                    
                    employeeData.forEach(item => {
                        if (item.jamMasuk) totalHadir++;
                        
                        const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                        if (stats.keterlambatanMenit > 0) {
                            totalTerlambat++;
                            totalKeterlambatanMenit += stats.keterlambatanMenit;
                        }
                        if (stats.lemburMenit > 0) {
                            totalLembur++;
                            totalLemburMenit += stats.lemburMenit;
                        }
                        if (stats.totalMenit > 0) {
                            totalJamKerja += stats.totalMenit;
                        }
                    });
                    
                    monthlyStats[employeeName] = {
                        totalHadir,
                        totalTerlambat,
                        totalLembur,
                        totalJamKerja,
                        totalKeterlambatanMenit,
                        totalLemburMenit,
                        data: employeeData
                    };
                });
                
                const monthName = new Date(year, month - 1).toLocaleDateString('id-ID', { 
                    year: 'numeric', 
                    month: 'long' 
                });
                
                container.innerHTML = `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">Laporan Bulanan - ${monthName}${nama ? ` (${nama})` : ''}</h4>
                        
                        <!-- Employee Summary -->
                        <div class="space-y-4 mb-6">
                            ${Object.keys(monthlyStats).map(employeeName => {
                                const stats = monthlyStats[employeeName];
                                return `
                                    <div class="bg-white rounded-lg p-4 shadow">
                                        <h5 class="font-semibold text-gray-800 mb-3">${employeeName}</h5>
                                        <div class="grid grid-cols-2 lg:grid-cols-6 gap-4">
                                            <div class="text-center">
                                                <p class="text-2xl font-bold text-green-600">${stats.totalHadir}</p>
                                                <p class="text-xs text-gray-600">Hari Hadir</p>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-2xl font-bold text-red-600">${stats.totalTerlambat}</p>
                                                <p class="text-xs text-gray-600">Terlambat</p>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-2xl font-bold text-purple-600">${stats.totalLembur}</p>
                                                <p class="text-xs text-gray-600">Lembur</p>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-lg font-bold text-blue-600">${Math.floor(stats.totalJamKerja / 60)}</p>
                                                <p class="text-xs text-gray-600">Total Jam</p>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-sm font-bold text-orange-600">${minutesToHoursText(stats.totalKeterlambatanMenit)}</p>
                                                <p class="text-xs text-gray-600">Total Terlambat</p>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-sm font-bold text-indigo-600">${minutesToHoursText(stats.totalLemburMenit)}</p>
                                                <p class="text-xs text-gray-600">Total Lembur</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Detailed Monthly Table -->
                        <div class="bg-white rounded-lg overflow-hidden shadow">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Tanggal</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Nama</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Shift</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Jam Masuk</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Jam Pulang</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Total Jam</th>
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${filteredData.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).map(item => {
                                        const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                                        const displayDate = new Date(item.tanggal).toLocaleDateString('id-ID');
                                        const status = getAttendanceStatus(item.jamMasuk, item.jamPulang, item.shift);
                                        
                                        return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 text-sm text-gray-600">${displayDate}</td>
                                                <td class="px-4 py-3 text-sm font-medium text-gray-800">${item.nama}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">${item.shift}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">${item.jamMasuk || '-'}</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">${item.jamPulang || '-'}</td>
                                                <td class="px-4 py-3 text-sm font-semibold text-blue-600">${stats.totalJam}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <span class="status-badge ${status.class}">${status.text}</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                updateSyncIndicator('online');
                showNotification('Laporan Bulanan', `Berhasil generate laporan untuk ${filteredData.length} data`, 'fa-calendar-check');
            }, 1000);
        }

        // Filter functions
        function applyFilter() {
            const tanggalMulai = document.getElementById('filterTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterTanggalAkhir').value;
            const nama = document.getElementById('filterNama').value;
            
            updateSyncIndicator('syncing');
            
            setTimeout(() => {
                let filteredData = [...absensiData];
                
                if (tanggalMulai) {
                    filteredData = filteredData.filter(item => item.tanggal >= tanggalMulai);
                }
                
                if (tanggalAkhir) {
                    filteredData = filteredData.filter(item => item.tanggal <= tanggalAkhir);
                }
                
                if (nama) {
                    filteredData = filteredData.filter(item => item.nama === nama);
                }
                
                // Temporarily replace absensiData for display
                const originalData = [...absensiData];
                absensiData = filteredData;
                
                loadRekapData();
                updateSummaryStats();
                
                // Restore original data
                absensiData = originalData;
                
                updateSyncIndicator('online');
                showNotification('Filter Applied', `Menampilkan ${filteredData.length} data`, 'fa-filter');
            }, 500);
        }

        // Export functions
        function exportToExcel() {
            if (absensiData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            updateSyncIndicator('syncing');
            
            const exportData = absensiData.map(item => {
                const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                return {
                    'Tanggal': new Date(item.tanggal).toLocaleDateString('id-ID'),
                    'Nama': item.nama,
                    'Shift': item.shift,
                    'Jam Masuk': item.jamMasuk || '-',
                    'Jam Pulang': item.jamPulang || '-',
                    'Total Jam Kerja': stats.totalJam,
                    'Keterlambatan': stats.keterlambatan,
                    'Pulang Cepat': stats.pulangCepat,
                    'Lembur': stats.lembur,
                    'Catatan': item.catatan || '-'
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Absensi PPSU');
            
            const fileName = `Absensi_PPSU_Pisbar_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            updateSyncIndicator('online');
            showNotification('Export Berhasil!', `File ${fileName} telah diunduh`, 'fa-file-excel');
        }

        function exportToCSV() {
            if (absensiData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            updateSyncIndicator('syncing');
            
            const headers = ['Tanggal', 'Nama', 'Shift', 'Jam Masuk', 'Jam Pulang', 'Total Jam', 'Keterlambatan', 'Pulang Cepat', 'Lembur', 'Catatan'];
            const csvData = [headers];
            
            absensiData.forEach(item => {
                const stats = calculateWorkStatsDetailed(item.jamMasuk, item.jamPulang, item.shift);
                csvData.push([
                    new Date(item.tanggal).toLocaleDateString('id-ID'),
                    item.nama,
                    item.shift,
                    item.jamMasuk || '-',
                    item.jamPulang || '-',
                    stats.totalJam,
                    stats.keterlambatan,
                    stats.pulangCepat,
                    stats.lembur,
                    item.catatan || '-'
                ]);
            });
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const fileName = `Absensi_PPSU_Pisbar_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            
            updateSyncIndicator('online');
            showNotification('Export Berhasil!', `File ${fileName} telah diunduh`, 'fa-file-csv');
        }

        // Edit and delete functions
        function editAbsensi(id) {
            const item = absensiData.find(data => data.id === id);
            if (!item) return;
            
            currentEditId = id;
            document.getElementById('editId').value = id;
            document.getElementById('editJamMasuk').value = item.jamMasuk || '';
            document.getElementById('editJamPulang').value = item.jamPulang || '';
            document.getElementById('editCatatan').value = item.catatan || '';
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditId = null;
        }

        // Edit form handler
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentEditId) return;
            
            const jamMasuk = document.getElementById('editJamMasuk').value;
            const jamPulang = document.getElementById('editJamPulang').value;
            const catatan = document.getElementById('editCatatan').value;
            
            updateSyncIndicator('syncing');
            showLoading(true);
            
            try {
                const existingItem = absensiData.find(item => item.id === currentEditId);
                if (!existingItem) throw new Error('Data tidak ditemukan');
                
                const updatedItem = {
                    ...existingItem,
                    jamMasuk: jamMasuk || existingItem.jamMasuk,
                    jamPulang: jamPulang || existingItem.jamPulang,
                    catatan: catatan,
                    lastUpdated: new Date().toISOString(),
                    version: (existingItem.version || 0) + 1
                };
                
                await saveToFirestore(updatedItem);
                
                // Update local data
                const index = absensiData.findIndex(item => item.id === currentEditId);
                if (index !== -1) {
                    absensiData[index] = updatedItem;
                }
                
                closeEditModal();
                loadRekapData();
                loadAbsensiHariIni();
                updateStats();
                updateSummaryStats();
                
                showLoading(false);
                updateSyncIndicator('online');
                showNotification('Data Diperbarui!', `Absensi ${updatedItem.nama} berhasil diupdate`, 'fa-sync-alt');
                
            } catch (error) {
                console.error('Error updating attendance:', error);
                showLoading(false);
                updateSyncIndicator('offline');
                alert('Terjadi kesalahan saat mengupdate data!');
            }
        });

        async function deleteAbsensi(id) {
            const item = absensiData.find(data => data.id === id);
            if (!item) return;
            
            if (!confirm(`Hapus absensi ${item.nama} pada ${new Date(item.tanggal).toLocaleDateString('id-ID')}?`)) {
                return;
            }
            
            updateSyncIndicator('syncing');
            showLoading(true);
            
            try {
                await deleteFromFirestore(id);
                
                // Remove from local data
                absensiData = absensiData.filter(data => data.id !== id);
                
                loadRekapData();
                loadAbsensiHariIni();
                updateStats();
                updateSummaryStats();
                
                showLoading(false);
                updateSyncIndicator('online');
                showNotification('Data Dihapus!', `Absensi ${item.nama} berhasil dihapus`, 'fa-trash');
                
            } catch (error) {
                console.error('Error deleting attendance:', error);
                showLoading(false);
                updateSyncIndicator('offline');
                alert('Terjadi kesalahan saat menghapus data!');
            }
        }

        async function clearAllData() {
            if (!confirm('PERINGATAN: Ini akan menghapus SEMUA data absensi secara permanen!\n\nApakah Anda yakin?')) {
                return;
            }
            
            if (!confirm('Konfirmasi sekali lagi: Hapus SEMUA data absensi?')) {
                return;
            }
            
            updateSyncIndicator('syncing');
            showLoading(true);
            
            try {
                if (isFirebaseEnabled) {
                    // Delete all documents from Firestore
                    const batch = db.batch();
                    const snapshot = await db.collection('absensi').get();
                    
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    console.log('✅ All data deleted from Firestore');
                }
                
                // Clear local data
                absensiData = [];
                localStorage.removeItem('absensiPPSUData');
                
                // Update UI
                loadRekapData();
                loadAbsensiHariIni();
                updateStats();
                updateSummaryStats();
                
                showLoading(false);
                updateSyncIndicator('online');
                showNotification('Semua Data Dihapus!', 'Semua data absensi telah dihapus', 'fa-trash');
                
            } catch (error) {
                console.error('Error clearing all data:', error);
                showLoading(false);
                updateSyncIndicator('offline');
                alert('Terjadi kesalahan saat menghapus semua data!');
            }
        }

        // Photo modal functions
        function showPhotoModal(photoSrc) {
            document.getElementById('photoModalImage').src = photoSrc;
            document.getElementById('photoModal').classList.remove('hidden');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
        }

        // Utility functions
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
            isLoading = show;
        }

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageName + 'Page').classList.remove('hidden');
            
            if (pageName === 'admin' && !isLoggedIn) {
                showAdminLogin();
                return;
            }
            
            if (pageName === 'admin' && isLoggedIn) {
                showAdminTab('rekap');
            }
        }

        function refreshData() {
            updateSyncIndicator('syncing');
            
            setTimeout(() => {
                loadAbsensiHariIni();
                updateStats();
                if (isLoggedIn && !document.getElementById('adminPage').classList.contains('hidden')) {
                    loadRekapData();
                    updateSummaryStats();
                }
                updateSyncIndicator('online');
                showNotification('Data Diperbarui!', 'Data telah direfresh dari server', 'fa-sync-alt');
            }, 1000);
        }

        // Real-time clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false 
            });
            const dateString = now.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentDate').textContent = dateString;
            document.getElementById('currentTimeMobile').textContent = timeString;
            document.getElementById('currentDateMobile').textContent = dateString;
        }

        // Initialize application
        async function initializeApp() {
            console.log('🚀 Initializing PPSU Pisangan Baru Attendance System...');
            
            // Update clock immediately and then every second
            updateClock();
            setInterval(updateClock, 1000);
            
            // Populate petugas dropdown
            const petugasSelect = document.getElementById('namaPetugas');
            const filterNamaSelect = document.getElementById('filterNama');
            const bulananNamaSelect = document.getElementById('bulananNama');
            
            petugasList.forEach(nama => {
                petugasSelect.innerHTML += `<option value="${nama}">${nama}</option>`;
                filterNamaSelect.innerHTML += `<option value="${nama}">${nama}</option>`;
                bulananNamaSelect.innerHTML += `<option value="${nama}">${nama}</option>`;
            });
            
            // Load data from Firebase/localStorage
            showLoading(true);
            try {
                absensiData = await loadFromFirestore();
                console.log(`✅ Loaded ${absensiData.length} attendance records`);
                
                // Start real-time listener
                startRealtimeListener();
                
                // Update UI
                loadAbsensiHariIni();
                updateStats();
                
                showLoading(false);
                showNotification('Sistem Siap!', 'Absensi PPSU Pisangan Baru siap digunakan', 'fa-check-circle');
                
            } catch (error) {
                console.error('❌ Error initializing app:', error);
                showLoading(false);
                updateSyncIndicator('offline');
                showNotification('Mode Offline', 'Sistem berjalan dalam mode offline', 'fa-exclamation-triangle');
            }
            
            console.log('✅ Application initialized successfully');
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Handle page visibility for real-time sync
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isFirebaseEnabled) {
                // Page became visible, refresh data
                setTimeout(refreshData, 1000);
            }
        });

        // Handle online/offline status
        window.addEventListener('online', function() {
            updateSyncIndicator('online');
            showNotification('Kembali Online!', 'Koneksi internet tersedia', 'fa-wifi');
            if (isFirebaseEnabled) {
                setTimeout(refreshData, 2000);
            }
        });

        window.addEventListener('offline', function() {
            updateSyncIndicator('offline');
            showNotification('Mode Offline', 'Tidak ada koneksi internet', 'fa-wifi-slash');
        });

        // Prevent form submission on Enter key in certain inputs
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT' && e.target.type !== 'submit') {
                e.preventDefault();
            }
        });

        // Auto-save form data to prevent data loss
        let autoSaveTimer;
        document.getElementById('absensiForm').addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                const formData = new FormData(this);
                const autoSaveData = {};
                for (let [key, value] of formData.entries()) {
                    autoSaveData[key] = value;
                }
                localStorage.setItem('absensiFormAutoSave', JSON.stringify(autoSaveData));
            }, 1000);
        });

        // Restore auto-saved form data
        window.addEventListener('load', function() {
            const autoSaveData = localStorage.getItem('absensiFormAutoSave');
            if (autoSaveData) {
                try {
                    const data = JSON.parse(autoSaveData);
                    Object.keys(data).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && data[key]) {
                            element.value = data[key];
                        }
                    });
                } catch (error) {
                    console.log('No auto-save data to restore');
                }
            }
        });

        // Clear auto-save data on successful form submission
        document.getElementById('absensiForm').addEventListener('submit', function() {
            localStorage.removeItem('absensiFormAutoSave');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97419cc972b3fd0e',t:'MTc1NjAyNTUzNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
